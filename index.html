<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jarvis">
<meta name="application-name" content="Jarvis">
<meta name="theme-color" content="#0a0a0f">
<title>JARVIS â€” Abhilas Rawat's Personal AI</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Jarvis%22%2C%22short_name%22%3A%22Jarvis%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0f%22%2C%22theme_color%22%3A%22%230a0a0f%22%7D">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg:#0a0a0f; --surface:#111118; --surface2:#16161f; --surface3:#1c1c28;
    --border:#1f1f2e; --border2:#2a2a3e;
    --accent:#4f8ef7; --accent2:#7c3aed; --accent3:#06d6a0;
    --accent-glow:rgba(79,142,247,0.15);
    --text:#e8eaf0; --text2:#a0a8c0; --muted:#4a5070;
    --danger:#ff4757; --claude-color:#d4a017; --deepseek-color:#4f8ef7;
  }
  [data-theme="light"]{--bg:#f5f5fa;--surface:#fff;--surface2:#f0f0f8;--surface3:#e8e8f0;--border:#dddde8;--border2:#c8c8d8;--text:#1a1a2e;--text2:#4a4a6a;--muted:#8888a8;--accent-glow:rgba(79,142,247,0.08);}
  [data-theme="midnight"]{--bg:#000005;--surface:#080810;--surface2:#0d0d18;--border:#151520;--border2:#1e1e2e;}
  [data-theme="forest"]{--bg:#0a0f0a;--surface:#0f160f;--surface2:#141e14;--border:#1a281a;--accent:#4ade80;--accent2:#16a34a;--accent3:#86efac;}
  [data-theme="sunset"]{--bg:#0f0a0a;--surface:#160f0f;--surface2:#1e1414;--border:#281a1a;--accent:#f97316;--accent2:#dc2626;--accent3:#fbbf24;}

  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;}

  /* â”€â”€ KEY SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #keyScreen{
    position:fixed;inset:0;z-index:999;
    background:var(--bg);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:28px;gap:22px;
  }
  #keyScreen .ks-title{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  #keyScreen .ks-orb{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:#fff;animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--accent-glow);}
  #keyScreen .ks-desc{text-align:center;max-width:360px;}
  #keyScreen .ks-desc h2{font-size:16px;font-weight:600;color:var(--text);margin-bottom:8px;}
  #keyScreen .ks-desc p{font-size:13px;color:var(--text2);line-height:1.6;}
  #keyScreen .ks-form{width:100%;max-width:400px;display:flex;flex-direction:column;gap:10px;}
  #apiKeyInput{width:100%;padding:13px 16px;border-radius:12px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;transition:border-color .2s;}
  #apiKeyInput:focus{border-color:var(--accent);}
  #keyError{font-size:12px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:18px;}
  #activateBtn{padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:15px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;letter-spacing:.5px;transition:opacity .2s;}
  #activateBtn:hover{opacity:.9;}
  .ks-link{text-align:center;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;}
  .ks-link a{color:var(--accent);text-decoration:none;}

  /* â”€â”€ APP WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #appWrapper{display:none;flex-direction:column;height:100%;width:100%;position:fixed;inset:0;}

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header{display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:56px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;position:relative;z-index:20;}
  .logo-area{display:flex;align-items:center;gap:10px;}
  .logo-ring{width:34px;height:34px;border-radius:50%;border:2px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent3),var(--accent)) border-box;display:flex;align-items:center;justify-content:center;animation:hue-spin 4s linear infinite;font-size:14px;}
  @keyframes hue-spin{to{filter:hue-rotate(360deg);}}
  .logo-name{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .logo-sub{font-size:9px;color:var(--muted);letter-spacing:1.5px;font-family:'JetBrains Mono',monospace;margin-top:-2px;}
  .header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:6px;}
  .source-tag{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);transition:all .4s;}
  .source-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  @keyframes pdot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(.8);}}
  .speed-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;border:1px solid var(--border2);background:var(--surface2);color:var(--muted);transition:all .3s;}
  .speed-pill.fast{color:var(--accent3);border-color:rgba(6,214,160,.3);background:rgba(6,214,160,.07);}
  .speed-pill.medium{color:var(--claude-color);border-color:rgba(212,160,23,.3);background:rgba(212,160,23,.07);}
  .header-right{display:flex;align-items:center;gap:8px;}
  .mem-badge{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);border:1px solid rgba(6,214,160,.2);background:rgba(6,214,160,.06);cursor:pointer;transition:all .2s;white-space:nowrap;}
  .mem-badge:hover{background:rgba(6,214,160,.12);}
  .mem-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  .hamburger{width:36px;height:36px;border-radius:10px;border:1px solid var(--border2);background:var(--surface2);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;transition:all .2s;flex-shrink:0;}
  .hamburger:hover{border-color:var(--accent);}
  .hamburger span{display:block;width:16px;height:1.5px;background:var(--text2);border-radius:2px;}

  /* â”€â”€ APP BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app-body{display:flex;flex:1;overflow:hidden;position:relative;}

  /* â”€â”€ DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;}
  .drawer-overlay.open{opacity:1;pointer-events:all;}
  .drawer{position:fixed;right:-340px;top:0;bottom:0;width:300px;background:var(--surface);border-left:1px solid var(--border);z-index:50;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);overflow:hidden;}
  .drawer.open{right:0;}
  .drawer-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
  .drawer-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .drawer-close{width:28px;height:28px;border-radius:8px;border:1px solid var(--border2);background:none;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
  .drawer-close:hover{background:var(--surface3);color:var(--text);}
  .drawer-body{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
  .drawer-section{padding:14px 18px;border-bottom:1px solid var(--border);}
  .drawer-section-title{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px;}
  .profile-card{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:var(--surface2);border:1px solid var(--border2);margin-bottom:12px;}
  .profile-avatar{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
  .profile-info h3{font-size:13px;font-weight:600;color:var(--text);}
  .profile-info p{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
  .owner-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:8px;background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--accent3);font-size:9px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:5px;}
  .setting-item{margin-bottom:12px;}
  .setting-label{font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:500;}
  .setting-input{width:100%;padding:9px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;}
  .setting-input:focus{border-color:var(--accent);}
  .theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}
  .theme-swatch{height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:white;}
  .theme-swatch.active{border-color:white;box-shadow:0 0 10px rgba(255,255,255,.3);}
  .history-item{padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:5px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:9px;}
  .history-icon{font-size:13px;flex-shrink:0;margin-top:1px;}
  .history-text{font-size:12px;color:var(--text2);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
  .history-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);flex-shrink:0;}
  .drawer-btn{width:100%;padding:10px;border-radius:10px;border:1px solid var(--accent);background:rgba(79,142,247,.1);color:var(--accent);font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:6px;display:block;}
  .drawer-btn:hover{background:rgba(79,142,247,.2);}
  .danger-btn{border-color:var(--danger)!important;background:rgba(255,71,87,.08)!important;color:var(--danger)!important;}
  .danger-btn:hover{background:rgba(255,71,87,.15)!important;}

  /* â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
  .autosave-strip{position:absolute;top:12px;left:14px;z-index:10;}
  .toggle-wrap{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border2);cursor:pointer;transition:all .2s;user-select:none;}
  .toggle-switch{width:28px;height:15px;border-radius:8px;background:var(--border2);position:relative;transition:background .3s;flex-shrink:0;}
  .toggle-switch.on{background:var(--accent3);}
  .toggle-knob{position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:white;transition:left .3s;}
  .toggle-switch.on .toggle-knob{left:15px;}
  .toggle-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--text2);}

  .messages-wrap{flex:1;overflow-y:auto;padding:60px 0 16px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;display:flex;flex-direction:column;}
  .messages-inner{width:100%;max-width:760px;margin:0 auto;padding:0 16px;display:flex;flex-direction:column;gap:0;flex:1;}

  /* Welcome */
  .welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:55vh;text-align:center;gap:18px;padding:30px 16px;}
  .orb-inner{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:white;letter-spacing:2px;}
  @keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}
  .welcome-title{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .welcome-sub{font-size:14px;color:var(--text2);max-width:460px;line-height:1.7;}
  .owner-line{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);border:1px solid var(--border2);padding:5px 14px;border-radius:20px;background:var(--surface2);}
  .owner-line span{color:var(--accent3);font-weight:600;}
  .suggestions{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin-top:6px;max-width:560px;}
  .sug-chip{padding:8px 14px;border-radius:22px;border:1px solid var(--border2);background:var(--surface2);font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s;}
  .sug-chip:hover{border-color:var(--accent);color:var(--text);}

  /* Messages */
  .msg-group{padding:14px 0;animation:fadeUp .25s ease-out;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
  .msg-group.user{display:flex;flex-direction:column;align-items:flex-end;}
  .msg-bubble{max-width:78%;padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.75;}
  .msg-bubble.ai{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px;max-width:100%;}
  .msg-bubble.user{background:linear-gradient(135deg,rgba(79,142,247,.25),rgba(124,58,237,.2));border:1px solid rgba(79,142,247,.25);border-top-right-radius:4px;}
  .msg-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
  .ai-avatar{width:24px;height:24px;border-radius:7px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Orbitron',monospace;color:white;flex-shrink:0;}
  .ai-name{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .source-chip{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.5px;}
  .chip-claude{background:rgba(212,160,23,.1);border:1px solid rgba(212,160,23,.25);color:var(--claude-color);}
  .chip-deepseek{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.25);color:var(--deepseek-color);}
  .chip-haiku{background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.25);color:var(--accent3);}
  .msg-text{white-space:pre-wrap;word-break:break-word;}

  /* Thinking */
  .thinking-bubble{background:var(--surface2);border:1px solid var(--border);border-radius:18px;border-top-left-radius:4px;padding:14px 18px;display:inline-flex;align-items:center;gap:6px;}
  .t-dot{width:7px;height:7px;border-radius:50%;animation:tdot 1.4s ease-in-out infinite;}
  .t-dot:nth-child(1){background:var(--accent);}
  .t-dot:nth-child(2){background:var(--accent2);animation-delay:.2s;}
  .t-dot:nth-child(3){background:var(--accent3);animation-delay:.4s;}
  @keyframes tdot{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-8px);}}

  /* Eval */
  .eval-section{margin-top:12px;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,.2);border:1px solid var(--border);}
  .eval-title{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;}
  .eval-row{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
  .eval-row:last-child{margin-bottom:0;}
  .eval-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);width:72px;flex-shrink:0;}
  .eval-track{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
  .eval-fill{height:100%;border-radius:2px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1);}
  .fill-a{background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .fill-b{background:linear-gradient(90deg,var(--accent3),#34d399);}
  .fill-c{background:linear-gradient(90deg,#f59e0b,#fcd34d);}
  .eval-num{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text2);width:28px;text-align:right;}
  .mem-indicator{display:flex;align-items:center;gap:5px;margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent3);}

  /* INPUT */
  .input-zone{padding:12px 16px 18px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
  .input-container{max-width:760px;margin:0 auto;}
  .input-box{display:flex;align-items:flex-end;gap:10px;background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:10px 12px;transition:border-color .25s,box-shadow .25s;}
  .input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
  #msgInput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Inter',sans-serif;font-size:15px;line-height:1.6;resize:none;max-height:140px;min-height:24px;}
  #msgInput::placeholder{color:var(--muted);}
  .send-btn{width:38px;height:38px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all .2s;}
  .send-btn:hover{transform:scale(1.05);}
  .send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
  .input-hint{text-align:center;font-size:10px;color:var(--muted);margin-top:8px;font-family:'JetBrains Mono',monospace;}

  /* TOAST */
  .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);padding:9px 16px;border-radius:12px;background:rgba(6,214,160,.15);border:1px solid rgba(6,214,160,.35);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent3);z-index:900;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

  /* Memory Modal */
  .mem-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
  .mem-modal-overlay.open{display:flex;}
  .mem-modal{width:100%;max-width:520px;max-height:80vh;background:var(--surface);border:1px solid var(--border2);border-radius:20px;display:flex;flex-direction:column;animation:modalIn .3s ease-out;overflow:hidden;}
  @keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px);}to{opacity:1;transform:none;}}
  .mem-modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
  .mem-modal-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;color:var(--accent3);}
  .mem-modal-body{overflow-y:auto;padding:16px 20px;flex:1;}
  .mem-entry{padding:11px 13px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:7px;border-left:3px solid var(--accent3);}
  .mem-entry-tag{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--accent3);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
  .mem-entry-text{font-size:13px;color:var(--text);line-height:1.5;}
  .mem-entry-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-top:4px;}

  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     API KEY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="keyScreen">
  <div class="ks-title">JARVIS</div>
  <div class="ks-orb">J</div>
  <div class="ks-desc">
    <h2>Enter your Anthropic API Key</h2>
    <p>Your key is saved only in your browser. It never leaves your device except to talk to Anthropic directly.</p>
  </div>
  <div class="ks-form">
    <input id="apiKeyInput" type="password" placeholder="sk-ant-api03-..." autocomplete="off" />
    <div id="keyError"></div>
    <button id="activateBtn" onclick="saveApiKey()">ACTIVATE JARVIS âš¡</button>
    <div class="ks-link">Get your free key â†’ <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appWrapper">
  <div class="toast" id="toast"></div>

  <!-- HEADER -->
  <div class="header">
    <div class="logo-area">
      <div class="logo-ring">â¬¡</div>
      <div>
        <div class="logo-name">JARVIS</div>
        <div class="logo-sub" id="logoSub">Personal AI Â· Abhilas Rawat</div>
      </div>
    </div>
    <div class="header-center">
      <div class="source-tag" id="sourceTag">
        <div class="source-dot"></div>
        <span id="sourceLabel">READY</span>
      </div>
      <div class="speed-pill" id="speedPill">âš¡ â€”</div>
    </div>
    <div class="header-right">
      <div class="mem-badge" onclick="openMemModal()">
        <div class="mem-dot"></div>
        <span id="memCount">0 Memories</span>
      </div>
      <div class="hamburger" onclick="openDrawer()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- APP BODY -->
  <div class="app-body">
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- DRAWER -->
    <div class="drawer" id="drawer">
      <div class="drawer-header">
        <div class="drawer-title">MENU</div>
        <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
      </div>
      <div class="drawer-body">

        <div class="drawer-section">
          <div class="drawer-section-title">Profile</div>
          <div class="profile-card">
            <div class="profile-avatar" id="profileEmoji">ğŸ‘¤</div>
            <div class="profile-info">
              <h3 id="profileName">Abhilas Rawat</h3>
              <p id="profileHandle">Creator &amp; Owner</p>
              <div class="owner-badge">ğŸ‘‘ SOLE OWNER</div>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-label">Your Name</div>
            <input class="setting-input" id="inputName" value="Abhilas Rawat" placeholder="Your name"/>
          </div>
          <div class="setting-item">
            <div class="setting-label">Profile Emoji</div>
            <input class="setting-input" id="inputEmoji" value="ğŸ‘¤" placeholder="Emoji" maxlength="4"/>
          </div>
          <div class="setting-item">
            <div class="setting-label">Bio</div>
            <input class="setting-input" id="inputBio" value="Creator &amp; Owner" placeholder="Short description"/>
          </div>
          <button class="drawer-btn" onclick="saveProfile()">Save Profile</button>
        </div>

        <div class="drawer-section">
          <div class="drawer-section-title">Color Theme</div>
          <div class="theme-grid">
            <div class="theme-swatch active" style="background:linear-gradient(135deg,#0a0a0f,#4f8ef7)" data-theme="dark" onclick="applyTheme('dark',this)">Dark</div>
            <div class="theme-swatch" style="background:linear-gradient(135deg,#000005,#7c3aed)" data-theme="midnight" onclick="applyTheme('midnight',this)">Night</div>
            <div class="theme-swatch" style="background:linear-gradient(135deg,#f5f5fa,#4f8ef7);color:#1a1a2e" data-theme="light" onclick="applyTheme('light',this)">Light</div>
            <div class="theme-swatch" style="background:linear-gradient(135deg,#0a0f0a,#4ade80)" data-theme="forest" onclick="applyTheme('forest',this)">Forest</div>
            <div class="theme-swatch" style="background:linear-gradient(135deg,#0f0a0a,#f97316)" data-theme="sunset" onclick="applyTheme('sunset',this)">Sunset</div>
          </div>
        </div>

        <div class="drawer-section">
          <div class="drawer-section-title">Previous Chats</div>
          <div id="historyList">
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:14px 0">No chat history yet</div>
          </div>
        </div>

        <div class="drawer-section">
          <div class="drawer-section-title">Account</div>
          <button class="drawer-btn danger-btn" onclick="resetApiKey()">ğŸ”‘ Change API Key</button>
          <button class="drawer-btn danger-btn" onclick="clearAll()">ğŸ—‘ Clear All Data</button>
        </div>

      </div>
    </div>

    <!-- MAIN CHAT -->
    <div class="chat-main">
      <div class="autosave-strip">
        <div class="toggle-wrap" onclick="toggleAutosave()">
          <div class="toggle-switch on" id="autosaveSwitch"><div class="toggle-knob"></div></div>
          <div class="toggle-label">AUTO-SAVE MEMORY</div>
        </div>
      </div>

      <div class="messages-wrap" id="messagesWrap">
        <div class="messages-inner" id="messages">
          <div class="welcome-screen" id="welcomeScreen">
            <div class="orb-inner">J</div>
            <div class="welcome-title">JARVIS</div>
            <div class="welcome-sub">Your personal AI â€” engineered exclusively for <strong>Abhilas Rawat</strong>.<br>Smart routing Â· Persistent memory Â· Always learning.</div>
            <div class="owner-line">Created by <span>Abhilas Rawat</span> Â· Sole Owner Â· Private &amp; Personal</div>
            <div class="suggestions">
              <div class="sug-chip" onclick="useChip('Write me a short story about a time traveler')">âœï¸ Write a story</div>
              <div class="sug-chip" onclick="useChip('Debug this Python code:\nfor i in range(10)\n  print(i)')">ğŸ› ï¸ Debug code</div>
              <div class="sug-chip" onclick="useChip('Rust vs Go â€” which should I learn in 2025?')">ğŸ” Rust vs Go</div>
              <div class="sug-chip" onclick="useChip('Find the derivative of xÂ³ + 2xÂ² - 5x + 1')">âˆ« Solve math</div>
              <div class="sug-chip" onclick="useChip('What do you remember about me?')">ğŸ§  What do you know?</div>
              <div class="sug-chip" onclick="useChip('Give me 5 AI startup ideas for 2025')">ğŸ’¡ Startup ideas</div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-zone">
        <div class="input-container">
          <div class="input-box">
            <textarea id="msgInput" placeholder="Message Jarvis..." rows="1"
              onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
          </div>
          <div class="input-hint">Enter to send Â· Shift+Enter for newline</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Memory Modal -->
<div class="mem-modal-overlay" id="memModal" onclick="closeMemModal(event)">
  <div class="mem-modal">
    <div class="mem-modal-header">
      <div class="mem-modal-title">ğŸ§  MEMORY VAULT</div>
      <button class="drawer-close" onclick="closeMemModal()">Ã—</button>
    </div>
    <div class="mem-modal-body" id="memModalBody"></div>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE POLYFILL â€” works on any real browser (not just Claude.ai)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (!window.storage) {
  window.storage = {
    get: async (key) => {
      const value = localStorage.getItem(key);
      if (value === null) throw new Error('Not found');
      return { key, value };
    },
    set: async (key, value) => {
      localStorage.setItem(key, String(value));
      return { key, value };
    },
    delete: async (key) => {
      localStorage.removeItem(key);
      return { key, deleted: true };
    }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://api.anthropic.com/v1/messages';
let API_KEY   = localStorage.getItem('jarvis-apikey') || '';

function apiHeaders() {
  return {
    'Content-Type': 'application/json',
    'x-api-key': API_KEY,
    'anthropic-version': '2023-06-01',
    'anthropic-dangerous-direct-browser-access': 'true'
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEY SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showKeyScreen() {
  document.getElementById('keyScreen').style.display = 'flex';
  document.getElementById('appWrapper').style.display = 'none';
}
function hideKeyScreen() {
  document.getElementById('keyScreen').style.display = 'none';
  document.getElementById('appWrapper').style.display = 'flex';
}
function saveApiKey() {
  const val = (document.getElementById('apiKeyInput').value || '').trim();
  if (!val) {
    document.getElementById('keyError').textContent = 'âš ï¸ Please enter your API key.';
    return;
  }
  if (!val.startsWith('sk-ant-')) {
    document.getElementById('keyError').textContent = 'âš ï¸ Key should start with sk-ant-';
    return;
  }
  API_KEY = val;
  localStorage.setItem('jarvis-apikey', val);
  hideKeyScreen();
  load();
}
function resetApiKey() {
  if (!confirm('Remove your API key and return to setup screen?')) return;
  API_KEY = '';
  localStorage.removeItem('jarvis-apikey');
  showKeyScreen();
}
document.getElementById('apiKeyInput').addEventListener('keydown', e => {
  document.getElementById('keyError').textContent = '';
  if (e.key === 'Enter') saveApiKey();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let memories            = [];
let conversationHistory = [];
let chatSessions        = [];
let autosave            = true;
let isBusy              = false;
let msgCounter          = 0;
let memSummary          = '';
let profile             = { name:'Abhilas Rawat', emoji:'ğŸ‘¤', bio:'Creator & Owner' };

const MAX_RAW_MEM        = 40;
const COMPRESS_THRESHOLD = 35;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODEL ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function classifyQuery(q) {
  const t = q.toLowerCase().trim();
  const words = t.split(/\s+/).length;

  const casual = ['hi','hello','hey','thanks','ok','okay','yes','no','sure','how are you'];
  if (words <= 6 && casual.some(c => t.startsWith(c))) {
    return { model:'claude-haiku-4-5-20251001', engine:'haiku', label:'âš¡ JARVIS â€” Fast' };
  }

  const codeKw = ['code','debug','function','bug','error','syntax','program','script','algorithm','compile','exception','class','method','variable','loop','array','api','import','module','library','regex','sql','database','html','css','javascript','python','java','rust','typescript','react','node','bash','shell'];
  if (codeKw.some(k => t.includes(k))) {
    return { model:'claude-haiku-4-5-20251001', engine:'deepseek', label:'â—ˆ JARVIS â€” Technical' };
  }

  const mathKw = ['solve','calculate','integral','derivative','equation','math','matrix','probability','formula','proof','theorem','algebra','geometry','calculus','physics','chemistry'];
  if (mathKw.some(k => t.includes(k))) {
    return { model:'claude-haiku-4-5-20251001', engine:'deepseek', label:'â—ˆ JARVIS â€” Technical' };
  }

  if (words <= 10) {
    return { model:'claude-haiku-4-5-20251001', engine:'haiku', label:'âš¡ JARVIS â€” Fast' };
  }

  return { model:'claude-haiku-4-5-20251001', engine:'claude', label:'âœ¦ JARVIS â€” Reasoning' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSystem(engine) {
  const memCtx = buildMemContext();
  const note = engine === 'deepseek'
    ? 'Mode: Technical â€” be precise and structured.'
    : engine === 'haiku'
    ? 'Mode: Fast â€” be concise. 1-3 sentences unless more is needed.'
    : 'Mode: Reasoning â€” be analytical and thorough.';
  return `You are JARVIS, the exclusive personal AI of Abhilas Rawat (creator & sole owner). Be direct, personalized, intelligent.\n${note}${memCtx ? '\n\nUser memory:\n' + memCtx : ''}`;
}

function buildMemContext() {
  const parts = [];
  if (memSummary) parts.push('Summary: ' + memSummary);
  if (memories.length) parts.push(memories.slice(-12).map(m => 'â€¢ ' + m.text).join('\n'));
  return parts.join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callApi(messages, model, system) {
  const body = { model, max_tokens: 1000, messages };
  if (system) body.system = system;

  const res = await fetch(API_URL, {
    method: 'POST',
    headers: apiHeaders(),
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    let msg = `API error ${res.status}`;
    try { const j = await res.json(); msg = j.error?.message || msg; } catch(_) {}
    throw new Error(msg);
  }

  const data = await res.json();
  return data.content?.[0]?.text || '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text  = input.value.trim();
  if (!text || isBusy) return;

  isBusy = true;
  document.getElementById('sendBtn').disabled = true;
  input.value = '';
  input.style.height = 'auto';

  // Hide welcome screen
  const ws = document.getElementById('welcomeScreen');
  if (ws) ws.style.display = 'none';

  const route = classifyQuery(text);
  setSourceTag(route.label, true);
  addUserMsg(text);

  // Show thinking
  const thinkEl = addThinking();

  let reply = '';
  try {
    // Build API messages
    const apiMsgs = conversationHistory.slice(-12).map(h => ({ role: h.role, content: h.content }));
    const memHit  = quickMemSearch(text);
    apiMsgs.push({ role: 'user', content: memHit ? `[Context: ${memHit}]\n\n${text}` : text });

    reply = await callApi(apiMsgs, route.model, buildSystem(route.engine));

    thinkEl.remove();
    const msgEl = addAIMsg(reply, route);

    updateSpeedPill(route.model);
    setSourceTag(route.label, false);

    conversationHistory.push({ role: 'user',      content: text  });
    conversationHistory.push({ role: 'assistant', content: reply });
    chatSessions.unshift({ preview: text.slice(0, 60), time: new Date().toLocaleString() });
    await persist();
    updateHistoryUI();

    // Background tasks (non-blocking)
    setTimeout(() => bgEval(text, reply, msgEl),   100);
    setTimeout(() => bgLearn(text, reply, msgEl),  300);

  } catch (err) {
    thinkEl.remove();
    addAIMsg('âš ï¸ ' + err.message + '\n\nTip: Check your API key in the drawer menu (â˜°) â†’ Change API Key.', route);
    setSourceTag('ERROR', false);
  }

  isBusy = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND: EVAL + LEARNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function bgEval(q, a, msgEl) {
  try {
    const reply = await callApi([{
      role: 'user',
      content: `Rate this AI response briefly. Q: "${q.slice(0,80)}" A: "${a.slice(0,150)}"\nReturn JSON only, no extra text: {"confidence":85,"accuracy":80,"relevance":90}`
    }], 'claude-haiku-4-5-20251001', null);

    const cleaned = reply.replace(/```json|```/g, '').trim();
    const p = JSON.parse(cleaned);
    appendEval(msgEl, {
      confidence: clamp(p.confidence ?? 75),
      accuracy:   clamp(p.accuracy   ?? 75),
      relevance:  clamp(p.relevance  ?? 75)
    });
  } catch(_) {}
}

async function bgLearn(userMsg, aiReply, msgEl) {
  if (!autosave) return;
  msgCounter++;
  if (msgCounter % 2 !== 0 && memories.length > 5) return;
  try {
    const reply = await callApi([{
      role: 'user',
      content: `Extract up to 2 facts/preferences about the USER from this chat. Return a JSON array of short strings only (no extra text, no markdown).\nUser: "${userMsg.slice(0,120)}"\nAI: "${aiReply.slice(0,180)}"\nReturn [] if nothing new.`
    }], 'claude-haiku-4-5-20251001', null);

    const cleaned = reply.replace(/```json|```/g, '').trim();
    const arr   = JSON.parse(cleaned);
    const items = Array.isArray(arr) ? arr.filter(s => typeof s === 'string' && s.length > 4) : [];
    if (items.length) {
      const now = new Date().toLocaleString();
      items.forEach(l => memories.push({ text: l, time: now }));
      appendMemIndicator(msgEl, items.length);
      updateMemUI();
      showToast(`âš¡ +${items.length} memory saved`);
      if (memories.length > COMPRESS_THRESHOLD) compressOldMemories();
      await persist();
    }
  } catch(_) {}
}

async function compressOldMemories() {
  if (memories.length < COMPRESS_THRESHOLD) return;
  const toCompress = memories.slice(0, 20);
  const recent     = memories.slice(20);
  try {
    const summary = await callApi([{
      role: 'user',
      content: `Compress these user facts into one short paragraph (max 200 chars):\n${toCompress.map(m=>m.text).join('\n')}`
    }], 'claude-haiku-4-5-20251001', null);
    if (summary) {
      memSummary = (memSummary ? memSummary + ' ' : '') + summary.trim();
      memories = recent;
      await persist();
    }
  } catch(_) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK MEM SEARCH (local, no API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickMemSearch(q) {
  if (!memories.length && !memSummary) return null;
  const words = q.toLowerCase().split(/\s+/).filter(w => w.length > 3);
  const hits  = memories.filter(m => words.some(w => m.text.toLowerCase().includes(w)));
  return hits.length ? hits.slice(-3).map(m => m.text).join('; ') : null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const g    = document.createElement('div');
  g.className = 'msg-group user';
  g.innerHTML = `<div class="msg-bubble user"><div class="msg-text">${esc(text)}</div></div>`;
  msgs.appendChild(g);
  scrollBottom();
}

function addAIMsg(text, route) {
  const msgs     = document.getElementById('messages');
  const g        = document.createElement('div');
  g.className    = 'msg-group';
  const chipCls  = route?.engine === 'deepseek' ? 'chip-deepseek' : route?.engine === 'haiku' ? 'chip-haiku' : 'chip-claude';
  const label    = route?.label || 'âœ¦ JARVIS';
  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-avatar">J</div>
      <div class="ai-name">JARVIS</div>
      <div class="source-chip ${chipCls}">${esc(label)}</div>
    </div>
    <div class="msg-bubble ai"><div class="msg-text">${esc(text)}</div></div>`;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function addThinking() {
  const msgs  = document.getElementById('messages');
  const g     = document.createElement('div');
  g.className = 'msg-group';
  g.innerHTML = `
    <div class="msg-meta"><div class="ai-avatar">J</div><div class="ai-name">JARVIS</div></div>
    <div class="thinking-bubble"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>`;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function appendEval(el, scores) {
  const bubble = el.querySelector('.msg-bubble');
  if (!bubble) return;
  const ev = document.createElement('div');
  ev.className = 'eval-section';
  ev.innerHTML = `
    <div class="eval-title">Self Evaluation</div>
    <div class="eval-row"><div class="eval-label">Confidence</div><div class="eval-track"><div class="eval-fill fill-a" data-w="${scores.confidence}"></div></div><div class="eval-num">${scores.confidence}%</div></div>
    <div class="eval-row"><div class="eval-label">Accuracy</div><div class="eval-track"><div class="eval-fill fill-b" data-w="${scores.accuracy}"></div></div><div class="eval-num">${scores.accuracy}%</div></div>
    <div class="eval-row"><div class="eval-label">Relevance</div><div class="eval-track"><div class="eval-fill fill-c" data-w="${scores.relevance}"></div></div><div class="eval-num">${scores.relevance}%</div></div>`;
  bubble.appendChild(ev);
  setTimeout(() => ev.querySelectorAll('.eval-fill').forEach(f => f.style.width = f.dataset.w + '%'), 80);
}

function appendMemIndicator(el, count) {
  const bubble = el.querySelector('.msg-bubble');
  if (!bubble) return;
  const mi = document.createElement('div');
  mi.className = 'mem-indicator';
  mi.textContent = `âš¡ +${count} memory insight${count > 1 ? 's' : ''} stored`;
  bubble.appendChild(mi);
}

function setSourceTag(label, active) {
  document.getElementById('sourceLabel').textContent = active ? 'THINKING...' : 'READY';
  document.getElementById('sourceTag').style.borderColor = active ? 'var(--accent)' : '';
}

function updateSpeedPill(model) {
  const pill = document.getElementById('speedPill');
  pill.textContent = model.includes('haiku') ? 'âš¡ Fast' : 'âœ¦ Smart';
  pill.className   = 'speed-pill ' + (model.includes('haiku') ? 'fast' : 'medium');
}

function scrollBottom() {
  const w = document.getElementById('messagesWrap');
  if (w) requestAnimationFrame(() => w.scrollTop = w.scrollHeight);
}

function esc(t) {
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE (persist / load)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function persist() {
  try { await window.storage.set('jarvis-mem',      JSON.stringify(memories)); }               catch(_) {}
  try { await window.storage.set('jarvis-memsummary', memSummary); }                            catch(_) {}
  try { await window.storage.set('jarvis-history',  JSON.stringify(conversationHistory.slice(-30))); } catch(_) {}
  try { await window.storage.set('jarvis-sessions', JSON.stringify(chatSessions.slice(-20))); } catch(_) {}
}

async function load() {
  if (!API_KEY) { showKeyScreen(); return; }
  hideKeyScreen();
  try { const r = await window.storage.get('jarvis-mem');      memories            = JSON.parse(r.value); } catch(_) { memories = []; }
  try { const r = await window.storage.get('jarvis-memsummary'); memSummary         = r.value; }            catch(_) {}
  try { const r = await window.storage.get('jarvis-history');  conversationHistory  = JSON.parse(r.value); } catch(_) { conversationHistory = []; }
  try { const r = await window.storage.get('jarvis-sessions'); chatSessions         = JSON.parse(r.value); } catch(_) { chatSessions = []; }
  try { const r = await window.storage.get('jarvis-profile');  profile              = JSON.parse(r.value); } catch(_) {}
  try {
    const r = await window.storage.get('jarvis-theme');
    document.body.setAttribute('data-theme', r.value);
    document.querySelectorAll('.theme-swatch').forEach(s => s.classList.toggle('active', s.dataset.theme === r.value));
  } catch(_) {}
  applyProfileUI();
  updateMemUI();
  updateHistoryUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAutosave() {
  autosave = !autosave;
  document.getElementById('autosaveSwitch').classList.toggle('on', autosave);
  showToast(autosave ? 'ğŸ§  Auto-save ON' : 'â¸ Auto-save OFF');
}

function updateMemUI() {
  document.getElementById('memCount').textContent = `${memories.length} Memor${memories.length !== 1 ? 'ies' : 'y'}`;
}

function openMemModal() {
  const body = document.getElementById('memModalBody');
  if (!memories.length && !memSummary) {
    body.innerHTML = `<div style="text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);padding:28px">No memories yet. Start chatting!</div>`;
  } else {
    let html = '';
    if (memSummary) html += `<div class="mem-entry" style="border-left-color:var(--accent2)"><div class="mem-entry-tag">COMPRESSED SUMMARY</div><div class="mem-entry-text">${esc(memSummary)}</div></div>`;
    html += [...memories].reverse().map(m => `
      <div class="mem-entry">
        <div class="mem-entry-tag">Learned</div>
        <div class="mem-entry-text">${esc(m.text)}</div>
        <div class="mem-entry-time">${esc(m.time)}</div>
      </div>`).join('');
    html += `<button class="drawer-btn danger-btn" onclick="clearMemory()" style="margin-top:10px;width:100%">ğŸ—‘ Clear All Memories</button>`;
    body.innerHTML = html;
  }
  document.getElementById('memModal').classList.add('open');
}

function closeMemModal(e) {
  if (!e || e.target === document.getElementById('memModal')) {
    document.getElementById('memModal').classList.remove('open');
  }
}

async function clearMemory() {
  if (!confirm('Clear all memories?')) return;
  memories = []; memSummary = '';
  await persist();
  updateMemUI();
  closeMemModal();
  showToast('Memories cleared');
}

function openDrawer()  { document.getElementById('drawer').classList.add('open');    document.getElementById('drawerOverlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }

function applyProfileUI() {
  document.getElementById('profileName').textContent   = profile.name;
  document.getElementById('profileEmoji').textContent  = profile.emoji;
  document.getElementById('profileHandle').textContent = profile.bio;
  document.getElementById('inputName').value  = profile.name;
  document.getElementById('inputEmoji').value = profile.emoji;
  document.getElementById('inputBio').value   = profile.bio;
  document.getElementById('logoSub').textContent = `Personal AI Â· ${profile.name}`;
}

async function saveProfile() {
  profile.name  = document.getElementById('inputName').value.trim()  || 'Abhilas Rawat';
  profile.emoji = document.getElementById('inputEmoji').value.trim() || 'ğŸ‘¤';
  profile.bio   = document.getElementById('inputBio').value.trim()   || 'Creator & Owner';
  try { await window.storage.set('jarvis-profile', JSON.stringify(profile)); } catch(_) {}
  applyProfileUI();
  showToast('Profile saved âœ“');
}

function applyTheme(theme, el) {
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
  if (el) el.classList.add('active');
  try { window.storage.set('jarvis-theme', theme); } catch(_) {}
}

function updateHistoryUI() {
  const list = document.getElementById('historyList');
  if (!chatSessions.length) {
    list.innerHTML = `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:12px 0">No chat history yet</div>`;
    return;
  }
  list.innerHTML = chatSessions.slice(0, 15).map(s => `
    <div class="history-item">
      <div class="history-icon">ğŸ’¬</div>
      <div class="history-text">${esc(s.preview)}</div>
      <div class="history-time">${esc(s.time?.split(',')[0] || '')}</div>
    </div>`).join('');
}

async function clearAll() {
  if (!confirm('Clear ALL data? This cannot be undone.')) return;
  memories = []; memSummary = ''; conversationHistory = []; chatSessions = [];
  await persist();
  updateMemUI(); updateHistoryUI();
  closeDrawer();
  showToast('All data cleared');
  location.reload();
}

function handleKey(e)    { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function autoResize(el)  { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 140) + 'px'; }
function useChip(text)   { const i = document.getElementById('msgInput'); i.value = text; autoResize(i); sendMessage(); }
function clamp(n)        { return Math.min(100, Math.max(0, n)); }

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
</script>
</body>
</html>
