<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jarvis">
<meta name="application-name" content="Jarvis">
<meta name="theme-color" content="#0a0a0f">
<title>JARVIS ‚Äî Abhilas Rawat's Personal AI</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Jarvis%22%2C%22short_name%22%3A%22Jarvis%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0f%22%2C%22theme_color%22%3A%22%230a0a0f%22%7D">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #16161f;
    --surface3: #1c1c28;
    --border: #1f1f2e;
    --border2: #2a2a3e;
    --accent: #4f8ef7;
    --accent2: #7c3aed;
    --accent3: #06d6a0;
    --accent-glow: rgba(79,142,247,0.15);
    --text: #e8eaf0;
    --text2: #a0a8c0;
    --muted: #4a5070;
    --success: #06d6a0;
    --danger: #ff4757;
    --claude-color: #d4a017;
    --deepseek-color: #4f8ef7;
  }
  [data-theme="light"] {
    --bg:#f5f5fa;--surface:#fff;--surface2:#f0f0f8;--surface3:#e8e8f0;
    --border:#dddde8;--border2:#c8c8d8;--text:#1a1a2e;--text2:#4a4a6a;
    --muted:#8888a8;--accent-glow:rgba(79,142,247,0.08);
  }
  [data-theme="midnight"] {
    --bg:#000005;--surface:#080810;--surface2:#0d0d18;--border:#151520;--border2:#1e1e2e;
  }
  [data-theme="forest"] {
    --bg:#0a0f0a;--surface:#0f160f;--surface2:#141e14;--border:#1a281a;
    --accent:#4ade80;--accent2:#16a34a;--accent3:#86efac;
  }
  [data-theme="sunset"] {
    --bg:#0f0a0a;--surface:#160f0f;--surface2:#1e1414;--border:#281a1a;
    --accent:#f97316;--accent2:#dc2626;--accent3:#fbbf24;
  }

  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;overflow:hidden;}
  body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;flex-direction:column;transition:background .3s,color .3s;}

  /* HEADER */
  .header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:56px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;position:relative;z-index:20;}
  .logo-area{display:flex;align-items:center;gap:10px;}
  .logo-ring{width:34px;height:34px;border-radius:50%;border:2px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent3),var(--accent)) border-box;display:flex;align-items:center;justify-content:center;animation:hue-spin 4s linear infinite;font-size:14px;}
  @keyframes hue-spin{to{filter:hue-rotate(360deg);}}
  .logo-name{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .logo-sub{font-size:9px;color:var(--muted);letter-spacing:1.5px;font-family:'JetBrains Mono',monospace;margin-top:-2px;}

  .header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;}
  .source-tag{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);transition:all .4s;}
  .source-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  @keyframes pdot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(.8);}}

  /* Speed indicator */
  .speed-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;border:1px solid var(--border2);background:var(--surface2);color:var(--muted);transition:all .3s;}
  .speed-pill.fast{color:var(--accent3);border-color:rgba(6,214,160,.3);background:rgba(6,214,160,.07);}
  .speed-pill.medium{color:var(--claude-color);border-color:rgba(212,160,23,.3);background:rgba(212,160,23,.07);}

  .header-right{display:flex;align-items:center;gap:10px;}
  .mem-badge{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);border:1px solid rgba(6,214,160,.2);background:rgba(6,214,160,.06);cursor:pointer;transition:all .2s;white-space:nowrap;}
  .mem-badge:hover{background:rgba(6,214,160,.12);}
  .mem-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  .hamburger{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);background:var(--surface2);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;transition:all .2s;flex-shrink:0;}
  .hamburger:hover{border-color:var(--accent);background:var(--accent-glow);}
  .hamburger span{display:block;width:16px;height:1.5px;background:var(--text2);border-radius:2px;}

  /* APP BODY */
  .app-body{display:flex;flex:1;overflow:hidden;position:relative;}

  /* DRAWER */
  .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;}
  .drawer-overlay.open{opacity:1;pointer-events:all;}
  .drawer{position:fixed;right:-340px;top:0;bottom:0;width:320px;background:var(--surface);border-left:1px solid var(--border);z-index:50;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);overflow:hidden;}
  .drawer.open{right:0;}
  .drawer-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
  .drawer-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .drawer-close{width:28px;height:28px;border-radius:8px;border:1px solid var(--border2);background:none;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
  .drawer-close:hover{background:var(--surface3);color:var(--text);}
  .drawer-body{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
  .drawer-section{padding:16px 20px;border-bottom:1px solid var(--border);}
  .drawer-section-title{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px;}
  .profile-card{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:var(--surface2);border:1px solid var(--border2);margin-bottom:12px;}
  .profile-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;box-shadow:0 0 20px var(--accent-glow);}
  .profile-info h3{font-size:14px;font-weight:600;color:var(--text);}
  .profile-info p{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
  .owner-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:8px;background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--accent3);font-size:9px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:5px;}
  .setting-item{margin-bottom:14px;}
  .setting-label{font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:500;}
  .setting-input{width:100%;padding:9px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;}
  .setting-input:focus{border-color:var(--accent);}
  .theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
  .theme-swatch{height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:white;}
  .theme-swatch.active{border-color:white;box-shadow:0 0 12px rgba(255,255,255,.3);}
  .theme-swatch:hover{transform:scale(1.05);}
  .history-item{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:6px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:10px;}
  .history-item:hover{border-color:var(--border2);background:var(--surface3);}
  .history-icon{font-size:14px;flex-shrink:0;margin-top:1px;}
  .history-text{font-size:12px;color:var(--text2);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
  .history-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);flex-shrink:0;}
  .drawer-btn{width:100%;padding:10px;border-radius:10px;border:1px solid var(--accent);background:rgba(79,142,247,.1);color:var(--accent);font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:4px;}
  .drawer-btn:hover{background:rgba(79,142,247,.2);}
  .danger-btn{border-color:var(--danger);background:rgba(255,71,87,.08);color:var(--danger);}
  .danger-btn:hover{background:rgba(255,71,87,.15);}

  /* CHAT */
  .chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
  .autosave-strip{position:absolute;top:12px;left:16px;z-index:10;}
  .toggle-wrap{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border2);cursor:pointer;transition:all .2s;user-select:none;}
  .toggle-wrap:hover{border-color:var(--accent3);}
  .toggle-switch{width:28px;height:15px;border-radius:8px;background:var(--border2);position:relative;transition:background .3s;flex-shrink:0;}
  .toggle-switch.on{background:var(--accent3);}
  .toggle-knob{position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:white;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
  .toggle-switch.on .toggle-knob{left:15px;}
  .toggle-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--text2);}

  .messages-wrap{flex:1;overflow-y:auto;padding:60px 0 20px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;display:flex;flex-direction:column;}
  .messages-inner{width:100%;max-width:780px;margin:0 auto;padding:0 24px;display:flex;flex-direction:column;gap:0;flex:1;}

  /* Welcome */
  .welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:20px;padding:40px 20px;}
  .orb-inner{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:white;letter-spacing:2px;}
  @keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}
  .welcome-title{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .welcome-sub{font-size:15px;color:var(--text2);max-width:500px;line-height:1.7;}
  .owner-line{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);border:1px solid var(--border2);padding:6px 16px;border-radius:20px;background:var(--surface2);}
  .owner-line span{color:var(--accent3);font-weight:600;}
  .suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px;max-width:600px;}
  .sug-chip{padding:9px 16px;border-radius:22px;border:1px solid var(--border2);background:var(--surface2);font-size:13px;color:var(--text2);cursor:pointer;transition:all .2s;}
  .sug-chip:hover{border-color:var(--accent);color:var(--text);background:var(--accent-glow);}

  /* Messages */
  .msg-group{padding:16px 0;animation:fadeUp .25s ease-out;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .msg-group.user{display:flex;flex-direction:column;align-items:flex-end;}
  .msg-bubble{max-width:75%;padding:14px 18px;border-radius:18px;font-size:14.5px;line-height:1.75;}
  .msg-bubble.ai{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px;max-width:100%;}
  .msg-bubble.user{background:linear-gradient(135deg,rgba(79,142,247,.25),rgba(124,58,237,.2));border:1px solid rgba(79,142,247,.25);border-top-right-radius:4px;}
  .msg-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
  .ai-avatar{width:24px;height:24px;border-radius:7px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Orbitron',monospace;color:white;flex-shrink:0;}
  .ai-name{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .source-chip{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.5px;}
  .chip-claude{background:rgba(212,160,23,.1);border:1px solid rgba(212,160,23,.25);color:var(--claude-color);}
  .chip-deepseek{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.25);color:var(--deepseek-color);}
  .chip-haiku{background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.25);color:var(--accent3);}

  /* Speed badge on message */
  .speed-badge{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-left:auto;}

  .msg-text{white-space:pre-wrap;word-break:break-word;}

  /* Streaming cursor */
  .cursor{display:inline-block;width:2px;height:1em;background:var(--accent);vertical-align:text-bottom;animation:blink .7s steps(1) infinite;margin-left:1px;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

  /* Eval */
  .eval-section{margin-top:14px;padding:12px 14px;border-radius:10px;background:rgba(0,0,0,.2);border:1px solid var(--border);}
  .eval-title{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;}
  .eval-row{display:flex;align-items:center;gap:10px;margin-bottom:7px;}
  .eval-row:last-child{margin-bottom:0;}
  .eval-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);width:76px;flex-shrink:0;}
  .eval-track{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
  .eval-fill{height:100%;border-radius:2px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1);}
  .fill-a{background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .fill-b{background:linear-gradient(90deg,var(--accent3),#34d399);}
  .fill-c{background:linear-gradient(90deg,#f59e0b,#fcd34d);}
  .eval-num{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text2);width:28px;text-align:right;}
  .mem-indicator{display:flex;align-items:center;gap:5px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent3);letter-spacing:.5px;}

  /* Thinking */
  .thinking-bubble{background:var(--surface2);border:1px solid var(--border);border-radius:18px;border-top-left-radius:4px;padding:14px 18px;display:inline-flex;align-items:center;gap:6px;}
  .t-dot{width:7px;height:7px;border-radius:50%;animation:tdot 1.4s ease-in-out infinite;}
  .t-dot:nth-child(1){background:var(--accent);}
  .t-dot:nth-child(2){background:var(--accent2);animation-delay:.2s;}
  .t-dot:nth-child(3){background:var(--accent3);animation-delay:.4s;}
  @keyframes tdot{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-8px);}}

  /* INPUT */
  .input-zone{padding:16px 24px 20px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
  .input-container{max-width:780px;margin:0 auto;}
  .input-box{display:flex;align-items:flex-end;gap:10px;background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:12px 14px;transition:border-color .25s,box-shadow .25s;}
  .input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
  #msgInput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Inter',sans-serif;font-size:15px;line-height:1.6;resize:none;max-height:160px;min-height:24px;}
  #msgInput::placeholder{color:var(--muted);}
  .send-btn{width:40px;height:40px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all .2s;box-shadow:0 4px 12px var(--accent-glow);}
  .send-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px var(--accent-glow);}
  .send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
  .input-hint{text-align:center;font-size:11px;color:var(--muted);margin-top:10px;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;}

  /* TOAST */
  .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);padding:10px 18px;border-radius:12px;background:rgba(6,214,160,.15);border:1px solid rgba(6,214,160,.35);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent3);z-index:100;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

  /* Memory Modal */
  .mem-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:60;display:none;align-items:center;justify-content:center;}
  .mem-modal-overlay.open{display:flex;}
  .mem-modal{width:560px;max-height:80vh;background:var(--surface);border:1px solid var(--border2);border-radius:20px;display:flex;flex-direction:column;animation:modalIn .3s ease-out;overflow:hidden;}
  @keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px);}to{opacity:1;transform:none;}}
  .mem-modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
  .mem-modal-title{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent3);}
  .mem-modal-body{overflow-y:auto;padding:20px 24px;flex:1;}
  .mem-entry{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:8px;border-left:3px solid var(--accent3);}
  .mem-entry-tag{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--accent3);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
  .mem-entry-text{font-size:13px;color:var(--text);line-height:1.5;}
  .mem-entry-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-top:4px;}

  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body data-theme="dark">

<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="header">
  <div class="logo-area">
    <div class="logo-ring">‚¨°</div>
    <div>
      <div class="logo-name">JARVIS</div>
      <div class="logo-sub" id="logoSub">Personal AI ¬∑ Abhilas Rawat</div>
    </div>
  </div>

  <div class="header-center">
    <div class="source-tag" id="sourceTag">
      <div class="source-dot"></div>
      <span id="sourceLabel">READY</span>
    </div>
    <div class="speed-pill" id="speedPill">‚ö° ‚Äî</div>
  </div>

  <div class="header-right">
    <div class="mem-badge" id="memBadge" onclick="openMemModal()">
      <div class="mem-dot"></div>
      <span id="memCount">0 Memories</span>
    </div>
    <div class="hamburger" onclick="openDrawer()">
      <span></span><span></span><span></span>
    </div>
  </div>
</div>

<!-- APP BODY -->
<div class="app-body">
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

  <!-- DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-title">MENU</div>
      <button class="drawer-close" onclick="closeDrawer()">√ó</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-section">
        <div class="drawer-section-title">Profile</div>
        <div class="profile-card">
          <div class="profile-avatar" id="profileEmoji">üë§</div>
          <div class="profile-info">
            <h3 id="profileName">Abhilas Rawat</h3>
            <p id="profileHandle">Creator & Owner</p>
            <div class="owner-badge">üëë SOLE OWNER</div>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-label">Your Name</div>
          <input class="setting-input" id="inputName" value="Abhilas Rawat" placeholder="Your name"/>
        </div>
        <div class="setting-item">
          <div class="setting-label">Profile Emoji</div>
          <input class="setting-input" id="inputEmoji" value="üë§" placeholder="Emoji" maxlength="4"/>
        </div>
        <div class="setting-item">
          <div class="setting-label">Bio</div>
          <input class="setting-input" id="inputBio" value="Creator & Owner" placeholder="Short description"/>
        </div>
        <button class="drawer-btn" onclick="saveProfile()">Save Profile</button>
      </div>

      <div class="drawer-section">
        <div class="drawer-section-title">Color Theme</div>
        <div class="theme-grid">
          <div class="theme-swatch active" style="background:linear-gradient(135deg,#0a0a0f,#4f8ef7)" data-theme="dark" onclick="applyTheme('dark',this)">Dark</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#000005,#7c3aed)" data-theme="midnight" onclick="applyTheme('midnight',this)">Night</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#f5f5fa,#4f8ef7);color:#1a1a2e" data-theme="light" onclick="applyTheme('light',this)">Light</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#0a0f0a,#4ade80)" data-theme="forest" onclick="applyTheme('forest',this)">Forest</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#0f0a0a,#f97316)" data-theme="sunset" onclick="applyTheme('sunset',this)">Sunset</div>
        </div>
      </div>

      <div class="drawer-section">
        <div class="drawer-section-title">Previous Chats</div>
        <div id="historyList">
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:16px 0">No chat history yet</div>
        </div>
        <button class="drawer-btn danger-btn" onclick="clearAll()" style="margin-top:8px">üóë Clear All Data</button>
      </div>
    </div>
  </div>

  <!-- MAIN CHAT -->
  <div class="chat-main">
    <div class="autosave-strip">
      <div class="toggle-wrap" onclick="toggleAutosave()">
        <div class="toggle-switch on" id="autosaveSwitch"><div class="toggle-knob"></div></div>
        <div class="toggle-label">AUTO-SAVE MEMORY</div>
      </div>
    </div>

    <div class="messages-wrap" id="messagesWrap">
      <div class="messages-inner" id="messages">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="orb-inner">J</div>
          <div class="welcome-title">JARVIS</div>
          <div class="welcome-sub">Your personal AI ‚Äî engineered exclusively for <strong>Abhilas Rawat</strong>.<br>Streaming responses ¬∑ Smart model routing ¬∑ Persistent memory ¬∑ Always learning.</div>
          <div class="owner-line">Created by <span>Abhilas Rawat</span> ¬∑ Sole Owner ¬∑ Private & Personal</div>
          <div class="suggestions">
            <div class="sug-chip" onclick="useChip('Write me a compelling short story about a time traveler')">‚úçÔ∏è Write a story</div>
            <div class="sug-chip" onclick="useChip('Debug this Python code:\nfor i in range(10)\n  print(i)')">üõ†Ô∏è Debug code</div>
            <div class="sug-chip" onclick="useChip('Analyze the pros and cons of learning Rust vs Go in 2025')">üîç Rust vs Go</div>
            <div class="sug-chip" onclick="useChip('Solve: find the derivative of x¬≥ + 2x¬≤ - 5x + 1')">‚à´ Solve math</div>
            <div class="sug-chip" onclick="useChip('What do you remember about me?')">üß† What do you know?</div>
            <div class="sug-chip" onclick="useChip('Give me 5 innovative startup ideas in AI for 2025')">üí° Startup ideas</div>
          </div>
        </div>
      </div>
    </div>

    <div class="input-zone">
      <div class="input-container">
        <div class="input-box">
          <textarea id="msgInput" placeholder="Message Jarvis..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚Üë</button>
        </div>
        <div class="input-hint">Enter to send ¬∑ Shift+Enter for newline ¬∑ Streaming ¬∑ Auto-routing ¬∑ Always learning</div>
      </div>
    </div>
  </div>
</div>

<!-- Memory Modal -->
<div class="mem-modal-overlay" id="memModal" onclick="closeMemModal(event)">
  <div class="mem-modal">
    <div class="mem-modal-header">
      <div class="mem-modal-title">üß† MEMORY VAULT</div>
      <button class="drawer-close" onclick="closeMemModal()">√ó</button>
    </div>
    <div class="mem-modal-body" id="memModalBody"></div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let memories = [];            // compressed memory store
let conversationHistory = []; // last N turns
let chatSessions = [];
let autosave = true;
let isThinking = false;
let msgCounter = 0;           // for deferred background tasks
let profile = { name:'Abhilas Rawat', emoji:'üë§', bio:'Creator & Owner' };

// ============================================================
// OPTIMIZATION 1: COMPRESSED MEMORY
// We store at most 40 raw memories, then compress older ones into a summary
// so the system prompt stays short ‚Üí faster API response
// ============================================================
const MAX_RAW_MEM = 40;
const COMPRESS_THRESHOLD = 35;
let memSummary = ''; // compressed summary of older memories

async function compressOldMemories() {
  if (memories.length < COMPRESS_THRESHOLD) return;
  const toCompress = memories.slice(0, 20);
  const recent = memories.slice(20);
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001', // fast model for compression
        max_tokens:300,
        messages:[{
          role:'user',
          content:`Compress these user facts into a brief summary paragraph (max 200 chars). Keep all unique info:\n${toCompress.map(m=>m.text).join('\n')}\n\nOne paragraph only:`
        }]
      })
    });
    const data = await res.json();
    const summary = data.content?.[0]?.text?.trim() || '';
    if (summary) {
      memSummary = (memSummary ? memSummary + ' ' : '') + summary;
      memories = recent;
      await persist();
    }
  } catch(e) {}
}

function buildMemContext() {
  const parts = [];
  if (memSummary) parts.push(`Summary of known facts: ${memSummary}`);
  if (memories.length) parts.push(memories.slice(-15).map(m => `‚Ä¢ ${m.text}`).join('\n'));
  return parts.join('\n');
}

// ============================================================
// OPTIMIZATION 2: SMART MODEL ROUTING
// Simple/short/casual ‚Üí Haiku (fast, cheap)
// Code/math/technical ‚Üí DeepSeek persona on Sonnet
// Writing/analysis/complex ‚Üí Claude Sonnet
// ============================================================
function classifyQuery(q) {
  const t = q.toLowerCase().trim();
  const words = t.split(/\s+/).length;

  // Very short / casual ‚Üí Haiku (fastest)
  const casual = ['hi','hello','hey','thanks','ok','okay','yes','no','sure','what','who','when','where','how are you'];
  if (words <= 6 && casual.some(c => t.startsWith(c))) {
    return { model:'haiku', engine:'haiku', label:'‚ö° JARVIS ‚Äî Fast' };
  }

  // Code & technical ‚Üí Sonnet in DeepSeek mode
  const codeKw = ['code','debug','function','bug','error','syntax','program','script','algorithm','compile','runtime','exception','class','method','variable','loop','array','object','api','import','module','library','github','regex','sql','query','database','html','css','javascript','python','java','rust','go','typescript','react','node','flask','django','dockerfile','bash','shell','terminal'];
  if (codeKw.some(k => t.includes(k))) {
    return { model:'sonnet', engine:'deepseek', label:'‚óà JARVIS ‚Äî Technical' };
  }

  // Math / science ‚Üí Sonnet in DeepSeek mode
  const mathKw = ['solve','calculate','integral','derivative','equation','math','matrix','vector','probability','statistics','formula','proof','theorem','compute','differentiate','integrate','algebra','geometry','trigonometry','physics','chemistry','calculus'];
  if (mathKw.some(k => t.includes(k))) {
    return { model:'sonnet', engine:'deepseek', label:'‚óà JARVIS ‚Äî Technical' };
  }

  // Simple factual (short) ‚Üí Haiku
  if (words <= 10 && !t.includes('explain') && !t.includes('analyze') && !t.includes('write')) {
    return { model:'haiku', engine:'haiku', label:'‚ö° JARVIS ‚Äî Fast' };
  }

  // Writing / analysis / complex ‚Üí Sonnet mode
  return { model:'sonnet', engine:'claude', label:'‚ú¶ JARVIS ‚Äî Reasoning' };
}

function getModelId(model) {
  return model === 'haiku' ? 'claude-haiku-4-5-20251001' : 'claude-sonnet-4-20250514';
}

// ============================================================
// SYSTEM PROMPT ‚Äî kept lean so token count stays low
// ============================================================
function buildSystem(engine) {
  const memCtx = buildMemContext();
  const engineNote = engine === 'deepseek'
    ? 'Mode: Technical ‚Äî be precise, structured, technical. Minimal prose.'
    : engine === 'haiku'
    ? 'Mode: Fast ‚Äî be concise and direct. 1-3 sentences unless more is truly needed.'
    : 'Mode: Reasoning ‚Äî be analytical, clear, and thorough.';

  return `You are JARVIS, the exclusive personal AI of Abhilas Rawat (creator & sole owner). Be direct, personalized, intelligent.
${engineNote}${memCtx ? '\n\nUser memory:\n' + memCtx : ''}`;
}

// ============================================================
// OPTIMIZATION 3: STREAMING RESPONSES
// Words appear live as they generate ‚Äî no wait for full reply
// ============================================================
async function streamReply(messages, route, textEl, cursorEl) {
  const t0 = Date.now();
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      model: getModelId(route.model),
      max_tokens: route.model === 'haiku' ? 600 : 1000,
      system: buildSystem(route.engine),
      messages,
      stream: true
    })
  });

  if (!res.ok) throw new Error(`API error ${res.status}`);

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let fullText = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream:true });
    const lines = chunk.split('\n');
    for (const line of lines) {
      if (!line.startsWith('data:')) continue;
      const data = line.slice(5).trim();
      if (data === '[DONE]') break;
      try {
        const parsed = JSON.parse(data);
        const delta = parsed.delta?.text || '';
        if (delta) {
          fullText += delta;
          textEl.textContent = fullText;
          cursorEl.style.display = 'inline-block';
          scrollBottom();
        }
      } catch(e) {}
    }
  }

  cursorEl.style.display = 'none';
  const elapsed = ((Date.now() - t0) / 1000).toFixed(1);
  return { text: fullText, elapsed };
}

// ============================================================
// OPTIMIZATION 4: BACKGROUND EVAL + LEARNING
// Answer is shown immediately; eval/learning happen silently after
// ============================================================
async function bgEval(q, a, msgEl) {
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001', // fast model for eval
        max_tokens:80,
        messages:[{ role:'user', content:`Rate AI response. Q="${q.slice(0,100)}" A="${a.slice(0,200)}"\nJSON only: {"confidence":85,"accuracy":80,"relevance":90}` }]
      })
    });
    const data = await res.json();
    const txt = (data.content?.[0]?.text||'{}').replace(/```json|```/g,'').trim();
    const p = JSON.parse(txt);
    appendEval(msgEl, {
      confidence: clamp(p.confidence??75),
      accuracy:   clamp(p.accuracy??75),
      relevance:  clamp(p.relevance??75)
    });
  } catch(e) {}
}

async function bgLearn(userMsg, aiReply, msgEl) {
  if (!autosave) return;
  // Only extract learnings every 2nd message to reduce API calls
  msgCounter++;
  if (msgCounter % 2 !== 0 && memories.length > 5) return;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001',
        max_tokens:160,
        messages:[{ role:'user', content:`Extract up to 2 important facts/preferences about the USER from this exchange. Return ONLY a JSON array of short strings (<80 chars each). Return [] if nothing new.\nUser: "${userMsg.slice(0,150)}"\nAI: "${aiReply.slice(0,200)}"\nJSON only:` }]
      })
    });
    const data = await res.json();
    const txt = (data.content?.[0]?.text||'[]').replace(/```json|```/g,'').trim();
    const arr = JSON.parse(txt);
    const items = Array.isArray(arr) ? arr.filter(s=>typeof s==='string'&&s.length>5) : [];
    if (items.length) {
      const now = new Date().toLocaleString();
      items.forEach(l => memories.push({ text:l, time:now }));
      appendMemIndicator(msgEl, items.length);
      updateMemUI();
      showToast(`‚ö° +${items.length} memory insight${items.length>1?'s':''} saved`);
      if (memories.length > COMPRESS_THRESHOLD) compressOldMemories();
      await persist();
    }
  } catch(e) {}
}

// ============================================================
// SEND ‚Äî fully optimized flow
// ============================================================
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || isThinking) return;

  isThinking = true;
  document.getElementById('sendBtn').disabled = true;
  input.value = '';
  input.style.height = 'auto';

  const ws = document.getElementById('welcomeScreen');
  if (ws) ws.style.display = 'none';

  // Route
  const route = classifyQuery(text);
  setSourceTag(route.label, true);

  addUserMsg(text);
  const thinkEl = addThinking();

  try {
    // Build messages (keep history short for speed)
    const apiMsgs = conversationHistory.slice(-12).map(h=>({ role:h.role, content:h.content }));
    const memHit = quickMemSearch(text);
    const userContent = memHit ? `[Context: ${memHit}]\n\n${text}` : text;
    apiMsgs.push({ role:'user', content:userContent });

    // Render streaming bubble immediately (remove thinking first)
    thinkEl.remove();
    const { msgEl, textEl, cursorEl } = addStreamingBubble(route);

    // STREAM the reply ‚Äî words appear live ‚Üì
    const { text: reply, elapsed } = await streamReply(apiMsgs, route, textEl, cursorEl);

    // Update speed pill
    updateSpeedPill(elapsed, route.model);
    setSourceTag(route.label, false);

    // Update history
    conversationHistory.push({ role:'user', content:text });
    conversationHistory.push({ role:'assistant', content:reply });
    chatSessions.unshift({ preview:text.slice(0,60), time:new Date().toLocaleString() });
    await persist();
    updateHistoryUI();

    // BACKGROUND: eval + learning (doesn't block the reply)
    setTimeout(() => bgEval(text, reply, msgEl), 100);
    setTimeout(() => bgLearn(text, reply, msgEl), 200);

  } catch(err) {
    thinkEl.remove();
    addAIMsg(`Something went wrong: ${err.message}`, route);
    setSourceTag('READY', false);
  }

  isThinking = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('msgInput').focus();
}

// Quick local memory search (no API call needed)
function quickMemSearch(q) {
  if (!memories.length && !memSummary) return null;
  const words = q.toLowerCase().split(/\s+/).filter(w=>w.length>3);
  const hits = memories.filter(m => words.some(w => m.text.toLowerCase().includes(w)));
  if (!hits.length) return null;
  return hits.slice(-3).map(m=>m.text).join('; ');
}

// ============================================================
// DOM HELPERS
// ============================================================
function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group user';
  g.innerHTML = `<div class="msg-bubble user"><div class="msg-text">${escHtml(text)}</div></div>`;
  msgs.appendChild(g);
  scrollBottom();
}

function addStreamingBubble(route) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group';

  const chipClass = route.engine==='deepseek'?'chip-deepseek':route.engine==='haiku'?'chip-haiku':'chip-claude';

  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-avatar">J</div>
      <div class="ai-name">JARVIS</div>
      <div class="source-chip ${chipClass}">${route.label}</div>
    </div>
    <div class="msg-bubble ai">
      <div class="msg-text" id="streamText"></div><span class="cursor" id="streamCursor"></span>
    </div>
  `;
  msgs.appendChild(g);
  scrollBottom();
  return {
    msgEl: g,
    textEl: g.querySelector('#streamText'),
    cursorEl: g.querySelector('#streamCursor')
  };
}

function addAIMsg(text, route) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group';
  const chipClass = route?.engine==='deepseek'?'chip-deepseek':route?.engine==='haiku'?'chip-haiku':'chip-claude';
  const label = route?.label || '‚ú¶ JARVIS';
  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-avatar">J</div>
      <div class="ai-name">JARVIS</div>
      <div class="source-chip ${chipClass}">${label}</div>
    </div>
    <div class="msg-bubble ai"><div class="msg-text">${escHtml(text)}</div></div>
  `;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function addThinking() {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group';
  g.innerHTML = `
    <div class="msg-meta"><div class="ai-avatar">J</div><div class="ai-name">JARVIS</div></div>
    <div class="thinking-bubble"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>
  `;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function appendEval(el, scores) {
  const bubble = el.querySelector('.msg-bubble');
  if (!bubble) return;
  const ev = document.createElement('div');
  ev.className = 'eval-section';
  ev.innerHTML = `
    <div class="eval-title">Self Evaluation</div>
    <div class="eval-row"><div class="eval-label">Confidence</div><div class="eval-track"><div class="eval-fill fill-a" data-w="${scores.confidence}"></div></div><div class="eval-num">${scores.confidence}%</div></div>
    <div class="eval-row"><div class="eval-label">Accuracy</div><div class="eval-track"><div class="eval-fill fill-b" data-w="${scores.accuracy}"></div></div><div class="eval-num">${scores.accuracy}%</div></div>
    <div class="eval-row"><div class="eval-label">Relevance</div><div class="eval-track"><div class="eval-fill fill-c" data-w="${scores.relevance}"></div></div><div class="eval-num">${scores.relevance}%</div></div>
  `;
  bubble.appendChild(ev);
  setTimeout(() => ev.querySelectorAll('.eval-fill').forEach(f => f.style.width = f.dataset.w+'%'), 80);
}

function appendMemIndicator(el, count) {
  const bubble = el.querySelector('.msg-bubble');
  if (!bubble) return;
  const mi = document.createElement('div');
  mi.className = 'mem-indicator';
  mi.innerHTML = `‚ö° +${count} memory insight${count>1?'s':''} stored`;
  bubble.appendChild(mi);
}

function setSourceTag(label, active) {
  const tag = document.getElementById('sourceTag');
  document.getElementById('sourceLabel').textContent = active ? `ROUTING ‚Üí ${label.replace(/[^A-Z\s‚óà‚ú¶‚ö°‚Äî]/g,'').trim()}` : 'READY';
  tag.style.borderColor = active ? 'var(--accent)' : '';
}

function updateSpeedPill(elapsed, model) {
  const pill = document.getElementById('speedPill');
  const fast = parseFloat(elapsed) < 3;
  pill.textContent = `‚ö° ${elapsed}s`;
  pill.className = `speed-pill ${fast ? 'fast' : 'medium'}`;
}

function scrollBottom() {
  const w = document.getElementById('messagesWrap');
  requestAnimationFrame(() => w.scrollTop = w.scrollHeight);
}

function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ============================================================
// STORAGE
// ============================================================
async function load() {
  try { const r = await window.storage.get('jarvis-mem'); if(r) memories = JSON.parse(r.value); } catch(e) { memories=[]; }
  try { const r = await window.storage.get('jarvis-memsummary'); if(r) memSummary = r.value; } catch(e) {}
  try { const r = await window.storage.get('jarvis-history'); if(r) conversationHistory = JSON.parse(r.value); } catch(e) { conversationHistory=[]; }
  try { const r = await window.storage.get('jarvis-sessions'); if(r) chatSessions = JSON.parse(r.value); } catch(e) { chatSessions=[]; }
  try { const r = await window.storage.get('jarvis-profile'); if(r) profile = JSON.parse(r.value); } catch(e) {}
  try { const r = await window.storage.get('jarvis-theme'); if(r) { document.body.setAttribute('data-theme',r.value); document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.toggle('active',s.dataset.theme===r.value)); } } catch(e) {}
  applyProfileUI();
  updateMemUI();
  updateHistoryUI();
}

async function persist() {
  try { await window.storage.set('jarvis-mem', JSON.stringify(memories)); } catch(e) {}
  try { await window.storage.set('jarvis-memsummary', memSummary); } catch(e) {}
  try { await window.storage.set('jarvis-history', JSON.stringify(conversationHistory.slice(-30))); } catch(e) {}
  try { await window.storage.set('jarvis-sessions', JSON.stringify(chatSessions.slice(-20))); } catch(e) {}
}

// ============================================================
// UI HELPERS
// ============================================================
function toggleAutosave() {
  autosave = !autosave;
  document.getElementById('autosaveSwitch').classList.toggle('on', autosave);
  showToast(autosave ? 'üß† Auto-save ON' : '‚è∏ Auto-save OFF');
}

function updateMemUI() {
  document.getElementById('memCount').textContent = `${memories.length} Memor${memories.length!==1?'ies':'y'}`;
}

function openMemModal() {
  const body = document.getElementById('memModalBody');
  if (!memories.length && !memSummary) {
    body.innerHTML = `<div style="text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);padding:30px">No memories yet. Start chatting!</div>`;
  } else {
    let html = '';
    if (memSummary) {
      html += `<div class="mem-entry" style="border-left-color:var(--accent2)"><div class="mem-entry-tag">COMPRESSED SUMMARY</div><div class="mem-entry-text">${escHtml(memSummary)}</div></div>`;
    }
    html += [...memories].reverse().map(m=>`
      <div class="mem-entry">
        <div class="mem-entry-tag">Learned</div>
        <div class="mem-entry-text">${escHtml(m.text)}</div>
        <div class="mem-entry-time">${m.time}</div>
      </div>
    `).join('');
    html += `<button class="drawer-btn danger-btn" onclick="clearMemory()" style="margin-top:8px;width:100%">üóë Clear All Memories</button>`;
    body.innerHTML = html;
  }
  document.getElementById('memModal').classList.add('open');
}

function closeMemModal(e) {
  if (!e || e.target===document.getElementById('memModal')) document.getElementById('memModal').classList.remove('open');
}

async function clearMemory() {
  if (!confirm('Clear all memories?')) return;
  memories=[]; memSummary='';
  await persist();
  updateMemUI();
  closeMemModal();
  showToast('Memories cleared');
}

function openDrawer() { document.getElementById('drawer').classList.add('open'); document.getElementById('drawerOverlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }

function applyProfileUI() {
  document.getElementById('profileName').textContent = profile.name;
  document.getElementById('profileEmoji').textContent = profile.emoji;
  document.getElementById('profileHandle').textContent = profile.bio;
  document.getElementById('inputName').value = profile.name;
  document.getElementById('inputEmoji').value = profile.emoji;
  document.getElementById('inputBio').value = profile.bio;
  document.getElementById('logoSub').textContent = `Personal AI ¬∑ ${profile.name}`;
}

async function saveProfile() {
  profile.name = document.getElementById('inputName').value.trim()||'Abhilas Rawat';
  profile.emoji = document.getElementById('inputEmoji').value.trim()||'üë§';
  profile.bio = document.getElementById('inputBio').value.trim()||'Creator & Owner';
  try { await window.storage.set('jarvis-profile', JSON.stringify(profile)); } catch(e) {}
  applyProfileUI();
  showToast('Profile saved');
}

function applyTheme(theme, el) {
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.remove('active'));
  if (el) el.classList.add('active');
  try { window.storage.set('jarvis-theme', theme); } catch(e) {}
}

function updateHistoryUI() {
  const list = document.getElementById('historyList');
  if (!chatSessions.length) {
    list.innerHTML = `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:16px 0">No chat history yet</div>`;
    return;
  }
  list.innerHTML = chatSessions.slice(0,15).map(s=>`
    <div class="history-item">
      <div class="history-icon">üí¨</div>
      <div class="history-text">${escHtml(s.preview)}</div>
      <div class="history-time">${s.time?.split(',')[0]||''}</div>
    </div>
  `).join('');
}

async function clearAll() {
  if (!confirm('Clear ALL data?')) return;
  memories=[]; memSummary=''; conversationHistory=[]; chatSessions=[];
  await persist();
  updateMemUI(); updateHistoryUI();
  closeDrawer();
  showToast('All data cleared');
  location.reload();
}

function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,160)+'px'; }
function useChip(text) { document.getElementById('msgInput').value=text; autoResize(document.getElementById('msgInput')); sendMessage(); }
function clamp(n) { return Math.min(100,Math.max(0,n)); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 3000);
}

// INIT
load();
</script>
</body>
</html>
