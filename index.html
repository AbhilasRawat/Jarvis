<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jarvis">
<meta name="application-name" content="Jarvis">
<meta name="theme-color" content="#0a0a0f">
<title>JARVIS ‚Äî Abhilas Rawat's Personal AI</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Jarvis%22%2C%22short_name%22%3A%22Jarvis%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0f%22%2C%22theme_color%22%3A%22%230a0a0f%22%7D">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg:#0a0a0f; --surface:#111118; --surface2:#16161f; --surface3:#1c1c28;
    --border:#1f1f2e; --border2:#2a2a3e;
    --accent:#4f8ef7; --accent2:#7c3aed; --accent3:#06d6a0;
    --accent-glow:rgba(79,142,247,0.15);
    --text:#e8eaf0; --text2:#a0a8c0; --muted:#4a5070;
    --danger:#ff4757;
    --groq-color:#f97316; --gemini-color:#4f8ef7;
  }
  [data-theme="light"]{--bg:#f5f5fa;--surface:#fff;--surface2:#f0f0f8;--surface3:#e8e8f0;--border:#dddde8;--border2:#c8c8d8;--text:#1a1a2e;--text2:#4a4a6a;--muted:#8888a8;--accent-glow:rgba(79,142,247,0.08);}
  [data-theme="midnight"]{--bg:#000005;--surface:#080810;--surface2:#0d0d18;--border:#151520;--border2:#1e1e2e;}
  [data-theme="forest"]{--bg:#0a0f0a;--surface:#0f160f;--surface2:#141e14;--border:#1a281a;--accent:#4ade80;--accent2:#16a34a;--accent3:#86efac;}
  [data-theme="sunset"]{--bg:#0f0a0a;--surface:#160f0f;--surface2:#1e1414;--border:#281a1a;--accent:#f97316;--accent2:#dc2626;--accent3:#fbbf24;}

  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;overflow:hidden;}
  body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;flex-direction:column;transition:background .3s,color .3s;}
  #appWrapper{flex:1;display:none;flex-direction:column;height:100%;overflow:hidden;}

  .header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:56px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;position:relative;z-index:20;}
  .logo-area{display:flex;align-items:center;gap:10px;}
  .logo-ring{width:34px;height:34px;border-radius:50%;border:2px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent3),var(--accent)) border-box;display:flex;align-items:center;justify-content:center;animation:hue-spin 4s linear infinite;font-size:14px;}
  @keyframes hue-spin{to{filter:hue-rotate(360deg);}}
  .logo-name{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .logo-sub{font-size:9px;color:var(--muted);letter-spacing:1.5px;font-family:'JetBrains Mono',monospace;margin-top:-2px;}
  .header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;}
  .source-tag{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);transition:all .4s;}
  .source-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  @keyframes pdot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(.8);}}
  .speed-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;border:1px solid var(--border2);background:var(--surface2);color:var(--muted);transition:all .3s;}
  .speed-pill.fast{color:var(--accent3);border-color:rgba(6,214,160,.3);background:rgba(6,214,160,.07);}
  .speed-pill.medium{color:var(--groq-color);border-color:rgba(249,115,22,.3);background:rgba(249,115,22,.07);}
  .header-right{display:flex;align-items:center;gap:10px;}
  .mem-badge{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);border:1px solid rgba(6,214,160,.2);background:rgba(6,214,160,.06);cursor:pointer;transition:all .2s;white-space:nowrap;}
  .mem-badge:hover{background:rgba(6,214,160,.12);}
  .mem-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
  .hamburger{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);background:var(--surface2);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;transition:all .2s;flex-shrink:0;}
  .hamburger:hover{border-color:var(--accent);background:var(--accent-glow);}
  .hamburger span{display:block;width:16px;height:1.5px;background:var(--text2);border-radius:2px;}
  .app-body{display:flex;flex:1;overflow:hidden;position:relative;}

  .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;}
  .drawer-overlay.open{opacity:1;pointer-events:all;}
  .drawer{position:fixed;right:-340px;top:0;bottom:0;width:320px;background:var(--surface);border-left:1px solid var(--border);z-index:50;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);overflow:hidden;}
  .drawer.open{right:0;}
  .drawer-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
  .drawer-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .drawer-close{width:28px;height:28px;border-radius:8px;border:1px solid var(--border2);background:none;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
  .drawer-close:hover{background:var(--surface3);color:var(--text);}
  .drawer-body{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
  .drawer-section{padding:16px 20px;border-bottom:1px solid var(--border);}
  .drawer-section-title{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px;}
  .profile-card{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:var(--surface2);border:1px solid var(--border2);margin-bottom:12px;}
  .profile-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;box-shadow:0 0 20px var(--accent-glow);}
  .profile-info h3{font-size:14px;font-weight:600;color:var(--text);}
  .profile-info p{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
  .owner-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:8px;background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--accent3);font-size:9px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:5px;}
  .setting-item{margin-bottom:14px;}
  .setting-label{font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:500;}
  .setting-input{width:100%;padding:9px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;}
  .setting-input:focus{border-color:var(--accent);}
  .theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
  .theme-swatch{height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:white;}
  .theme-swatch.active{border-color:white;box-shadow:0 0 12px rgba(255,255,255,.3);}
  .theme-swatch:hover{transform:scale(1.05);}
  .history-item{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:6px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:10px;}
  .history-item:hover{border-color:var(--border2);background:var(--surface3);}
  .history-icon{font-size:14px;flex-shrink:0;margin-top:1px;}
  .history-text{font-size:12px;color:var(--text2);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
  .history-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);flex-shrink:0;}
  .drawer-btn{width:100%;padding:10px;border-radius:10px;border:1px solid var(--accent);background:rgba(79,142,247,.1);color:var(--accent);font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:4px;}
  .drawer-btn:hover{background:rgba(79,142,247,.2);}
  .danger-btn{border-color:var(--danger);background:rgba(255,71,87,.08);color:var(--danger);}
  .danger-btn:hover{background:rgba(255,71,87,.15);}
  .engine-status-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:10px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:10px;}
  .engine-groq{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.25);color:var(--groq-color);}
  .engine-gemini{background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.25);color:var(--gemini-color);}

  .chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
  .autosave-strip{position:absolute;top:12px;left:16px;z-index:10;}
  .toggle-wrap{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border2);cursor:pointer;transition:all .2s;user-select:none;}
  .toggle-wrap:hover{border-color:var(--accent3);}
  .toggle-switch{width:28px;height:15px;border-radius:8px;background:var(--border2);position:relative;transition:background .3s;flex-shrink:0;}
  .toggle-switch.on{background:var(--accent3);}
  .toggle-knob{position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:white;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
  .toggle-switch.on .toggle-knob{left:15px;}
  .toggle-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--text2);}
  .messages-wrap{flex:1;overflow-y:auto;padding:60px 0 20px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;display:flex;flex-direction:column;}
  .messages-inner{width:100%;max-width:780px;margin:0 auto;padding:0 24px;display:flex;flex-direction:column;gap:0;flex:1;}

  .welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:20px;padding:40px 20px;}
  .orb-inner{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:white;letter-spacing:2px;}
  @keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}
  .welcome-title{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .welcome-sub{font-size:15px;color:var(--text2);max-width:500px;line-height:1.7;}
  .owner-line{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);border:1px solid var(--border2);padding:6px 16px;border-radius:20px;background:var(--surface2);}
  .owner-line span{color:var(--accent3);font-weight:600;}
  .engine-badges{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .engine-badge{padding:5px 14px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;}
  .badge-groq{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.3);color:var(--groq-color);}
  .badge-gemini{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);color:var(--gemini-color);}
  .suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px;max-width:600px;}
  .sug-chip{padding:9px 16px;border-radius:22px;border:1px solid var(--border2);background:var(--surface2);font-size:13px;color:var(--text2);cursor:pointer;transition:all .2s;}
  .sug-chip:hover{border-color:var(--accent);color:var(--text);background:var(--accent-glow);}

  .msg-group{padding:16px 0;animation:fadeUp .25s ease-out;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .msg-group.user{display:flex;flex-direction:column;align-items:flex-end;}
  .msg-bubble{max-width:75%;padding:14px 18px;border-radius:18px;font-size:14.5px;line-height:1.75;}
  .msg-bubble.ai{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px;max-width:100%;}
  .msg-bubble.user{background:linear-gradient(135deg,rgba(79,142,247,.25),rgba(124,58,237,.2));border:1px solid rgba(79,142,247,.25);border-top-right-radius:4px;}
  .msg-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
  .ai-avatar{width:24px;height:24px;border-radius:7px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;font-family:'Orbitron',monospace;color:white;flex-shrink:0;}
  .ai-name{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .source-chip{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.5px;}
  .chip-groq{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.25);color:var(--groq-color);}
  .chip-gemini{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.25);color:var(--gemini-color);}

  .msg-text{white-space:pre-wrap;word-break:break-word;}
  .msg-text code{font-family:'JetBrains Mono',monospace;font-size:13px;background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.18);padding:1px 5px;border-radius:4px;color:var(--accent);}
  .msg-text pre{background:var(--surface3);border:1px solid var(--border2);border-radius:10px;padding:14px;overflow-x:auto;margin:10px 0;}
  .msg-text pre code{background:none;border:none;padding:0;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.6;}
  .msg-text strong{color:var(--text);font-weight:600;}
  .msg-text em{font-style:italic;color:var(--text2);}
  .msg-text a{color:var(--accent);text-decoration:underline;}
  .msg-text ul,.msg-text ol{padding-left:20px;margin:6px 0;}
  .msg-text li{margin-bottom:4px;}
  .msg-text h1,.msg-text h2,.msg-text h3{font-family:'Orbitron',monospace;margin:14px 0 6px;}
  .msg-text h1{font-size:18px;} .msg-text h2{font-size:15px;} .msg-text h3{font-size:13px;}
  .msg-text blockquote{border-left:3px solid var(--accent2);padding-left:12px;color:var(--text2);font-style:italic;margin:8px 0;}
  .cursor{display:inline-block;width:2px;height:1em;background:var(--accent);vertical-align:text-bottom;animation:blink .7s steps(1) infinite;margin-left:1px;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

  .eval-section{margin-top:14px;padding:12px 14px;border-radius:10px;background:rgba(0,0,0,.2);border:1px solid var(--border);}
  .eval-title{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;}
  .eval-row{display:flex;align-items:center;gap:10px;margin-bottom:7px;}
  .eval-row:last-child{margin-bottom:0;}
  .eval-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);width:76px;flex-shrink:0;}
  .eval-track{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
  .eval-fill{height:100%;border-radius:2px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1);}
  .fill-a{background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .fill-b{background:linear-gradient(90deg,var(--accent3),#34d399);}
  .fill-c{background:linear-gradient(90deg,#f59e0b,#fcd34d);}
  .eval-num{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text2);width:28px;text-align:right;}
  .mem-indicator{display:flex;align-items:center;gap:5px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent3);}

  .thinking-bubble{background:var(--surface2);border:1px solid var(--border);border-radius:18px;border-top-left-radius:4px;padding:14px 18px;display:inline-flex;align-items:center;gap:6px;}
  .t-dot{width:7px;height:7px;border-radius:50%;animation:tdot 1.4s ease-in-out infinite;}
  .t-dot:nth-child(1){background:var(--accent);}
  .t-dot:nth-child(2){background:var(--accent2);animation-delay:.2s;}
  .t-dot:nth-child(3){background:var(--accent3);animation-delay:.4s;}
  @keyframes tdot{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-8px);}}

  .input-zone{padding:16px 24px 20px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
  .input-container{max-width:780px;margin:0 auto;}
  .input-box{display:flex;align-items:flex-end;gap:10px;background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:12px 14px;transition:border-color .25s,box-shadow .25s;}
  .input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
  #msgInput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Inter',sans-serif;font-size:15px;line-height:1.6;resize:none;max-height:160px;min-height:24px;}
  #msgInput::placeholder{color:var(--muted);}
  .send-btn{width:40px;height:40px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all .2s;box-shadow:0 4px 12px var(--accent-glow);}
  .send-btn:hover{transform:scale(1.05);}
  .send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
  .send-btn.loading{animation:btn-pulse .8s ease-in-out infinite;}
  @keyframes btn-pulse{0%,100%{opacity:.5;}50%{opacity:1;}}
  .input-hint{text-align:center;font-size:11px;color:var(--muted);margin-top:10px;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;}
  .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);padding:10px 18px;border-radius:12px;background:rgba(6,214,160,.15);border:1px solid rgba(6,214,160,.35);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent3);z-index:100;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .mem-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:60;display:none;align-items:center;justify-content:center;}
  .mem-modal-overlay.open{display:flex;}
  .mem-modal{width:560px;max-height:80vh;background:var(--surface);border:1px solid var(--border2);border-radius:20px;display:flex;flex-direction:column;animation:modalIn .3s ease-out;overflow:hidden;}
  @keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px);}to{opacity:1;transform:none;}}
  .mem-modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
  .mem-modal-title{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent3);}
  .mem-modal-body{overflow-y:auto;padding:20px 24px;flex:1;}
  .mem-entry{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:8px;border-left:3px solid var(--accent3);}
  .mem-entry-tag{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--accent3);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
  .mem-entry-text{font-size:13px;color:var(--text);line-height:1.5;}
  .mem-entry-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-top:4px;}
  ::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body data-theme="dark">

<!-- ===================== KEY SETUP SCREEN ===================== -->
<div id="keyScreen" style="display:none;position:fixed;inset:0;z-index:200;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:16px;overflow-y:auto;">
  <div style="font-family:'Orbitron',monospace;font-size:24px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">JARVIS</div>
  <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:18px;font-weight:900;color:white;animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--accent-glow);">J</div>
  <div style="text-align:center;max-width:440px;">
    <div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px;">Setup your FREE AI Engines</div>
    <div style="font-size:12px;color:var(--text2);line-height:1.7;">JARVIS uses two free AI engines ‚Äî <span style="color:var(--groq-color);font-weight:600;">Groq</span> for fast everyday chat and <span style="color:var(--gemini-color);font-weight:600;">Gemini</span> for deep knowledge. Both are 100% free. Your keys never leave your browser.</div>
  </div>
  <div style="width:100%;max-width:440px;display:flex;flex-direction:column;gap:12px;">

    <!-- GROQ KEY -->
    <div style="padding:14px;border-radius:12px;background:var(--surface2);border:1px solid rgba(249,115,22,.3);">
      <div style="font-size:13px;font-weight:600;color:var(--groq-color);margin-bottom:4px;">‚ö° Groq API Key ‚Äî Casual chat, coding, creative writing</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">Free at <a href="https://console.groq.com/keys" target="_blank" style="color:var(--groq-color);">console.groq.com/keys</a> ‚Äî No credit card</div>
      <input id="groqKeyInput" type="password" placeholder="gsk_..." onkeydown="handleKeyInput(event)"
        style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(249,115,22,.3);background:var(--surface3);color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;"/>
      <div id="groqKeyError" style="font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:14px;margin-top:4px;"></div>
    </div>

    <!-- GEMINI KEY -->
    <div style="padding:14px;border-radius:12px;background:var(--surface2);border:1px solid rgba(79,142,247,.3);">
      <div style="font-size:13px;font-weight:600;color:var(--gemini-color);margin-bottom:4px;">üåê Gemini API Key ‚Äî Knowledge, science, history, academics</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">Free at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--gemini-color);">aistudio.google.com/app/apikey</a> ‚Äî No credit card</div>
      <input id="geminiKeyInput" type="password" placeholder="AIza..." onkeydown="handleKeyInput(event)"
        style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(79,142,247,.3);background:var(--surface3);color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;"/>
      <div id="geminiKeyError" style="font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:14px;margin-top:4px;"></div>
    </div>

    <div id="keyGlobalError" style="font-size:12px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:16px;text-align:center;"></div>
    <button onclick="saveApiKeys()" style="padding:13px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-size:15px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;letter-spacing:1px;">
      ACTIVATE JARVIS ‚ö°
    </button>
    <div style="text-align:center;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;">Both keys are 100% FREE ¬∑ Stored only in your browser</div>
  </div>
</div>

<!-- ===================== MAIN APP ===================== -->
<div id="appWrapper" style="display:none;flex-direction:column;height:100%;width:100%">
<div class="toast" id="toast"></div>

<div class="header">
  <div class="logo-area">
    <div class="logo-ring">‚¨°</div>
    <div>
      <div class="logo-name">JARVIS</div>
      <div class="logo-sub" id="logoSub">Personal AI ¬∑ Abhilas Rawat</div>
    </div>
  </div>
  <div class="header-center">
    <div class="source-tag" id="sourceTag">
      <div class="source-dot"></div>
      <span id="sourceLabel">READY</span>
    </div>
    <div class="speed-pill" id="speedPill">‚ö° ‚Äî</div>
  </div>
  <div class="header-right">
    <div class="mem-badge" onclick="openMemModal()">
      <div class="mem-dot"></div>
      <span id="memCount">0 Memories</span>
    </div>
    <div class="hamburger" onclick="openDrawer()">
      <span></span><span></span><span></span>
    </div>
  </div>
</div>

<div class="app-body">
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-title">MENU</div>
      <button class="drawer-close" onclick="closeDrawer()">√ó</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-section">
        <div class="drawer-section-title">Profile</div>
        <div class="profile-card">
          <div class="profile-avatar" id="profileEmoji">üë§</div>
          <div class="profile-info">
            <h3 id="profileName">Abhilas Rawat</h3>
            <p id="profileHandle">Creator & Owner</p>
            <div class="owner-badge">üëë SOLE OWNER</div>
          </div>
        </div>
        <div class="setting-item"><div class="setting-label">Your Name</div><input class="setting-input" id="inputName" value="Abhilas Rawat"/></div>
        <div class="setting-item"><div class="setting-label">Profile Emoji</div><input class="setting-input" id="inputEmoji" value="üë§" maxlength="4"/></div>
        <div class="setting-item"><div class="setting-label">Bio</div><input class="setting-input" id="inputBio" value="Creator & Owner"/></div>
        <button class="drawer-btn" onclick="saveProfile()">Save Profile</button>
      </div>

      <div class="drawer-section">
        <div class="drawer-section-title">AI Engines (Both Free)</div>
        <div class="engine-status-row engine-groq">
          <span>‚ö° Groq ‚Äî Chat & Code</span><span>‚óè ACTIVE</span>
        </div>
        <div class="engine-status-row engine-gemini">
          <span>üåê Gemini ‚Äî Knowledge</span><span>‚óè ACTIVE</span>
        </div>
      </div>

      <div class="drawer-section">
        <div class="drawer-section-title">Color Theme</div>
        <div class="theme-grid">
          <div class="theme-swatch active" style="background:linear-gradient(135deg,#0a0a0f,#4f8ef7)" data-theme="dark" onclick="applyTheme('dark',this)">Dark</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#000005,#7c3aed)" data-theme="midnight" onclick="applyTheme('midnight',this)">Night</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#f5f5fa,#4f8ef7);color:#1a1a2e" data-theme="light" onclick="applyTheme('light',this)">Light</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#0a0f0a,#4ade80)" data-theme="forest" onclick="applyTheme('forest',this)">Forest</div>
          <div class="theme-swatch" style="background:linear-gradient(135deg,#0f0a0a,#f97316)" data-theme="sunset" onclick="applyTheme('sunset',this)">Sunset</div>
        </div>
      </div>

      <div class="drawer-section">
        <div class="drawer-section-title">Previous Chats</div>
        <div id="historyList"><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:16px 0">No chat history yet</div></div>
        <button class="drawer-btn danger-btn" onclick="resetApiKeys()" style="margin-top:4px">üîë Change API Keys</button>
        <button class="drawer-btn danger-btn" onclick="clearAll()" style="margin-top:8px">üóë Clear All Data</button>
      </div>
    </div>
  </div>

  <div class="chat-main">
    <div class="autosave-strip">
      <div class="toggle-wrap" onclick="toggleAutosave()">
        <div class="toggle-switch on" id="autosaveSwitch"><div class="toggle-knob"></div></div>
        <div class="toggle-label">AUTO-SAVE MEMORY</div>
      </div>
    </div>

    <div class="messages-wrap" id="messagesWrap">
      <div class="messages-inner" id="messages">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="orb-inner">J</div>
          <div class="welcome-title">JARVIS</div>
          <div class="welcome-sub">Your personal AI ‚Äî engineered exclusively for <strong>Abhilas Rawat</strong>.<br>Dual-engine intelligence ¬∑ Streaming ¬∑ Persistent memory ¬∑ 100% Free.</div>
          <div class="owner-line">Created by <span>Abhilas Rawat</span> ¬∑ Sole Owner ¬∑ Private & Personal</div>
          <div class="engine-badges">
            <div class="engine-badge badge-groq">‚ö° Groq ‚Äî Fast Chat & Code</div>
            <div class="engine-badge badge-gemini">üåê Gemini ‚Äî Deep Knowledge</div>
          </div>
          <div class="suggestions">
            <div class="sug-chip" onclick="useChip('Hey! How are you doing today?')">üëã Just say hi</div>
            <div class="sug-chip" onclick="useChip('Write me a short story about a time traveler')">‚úçÔ∏è Write a story</div>
            <div class="sug-chip" onclick="useChip('Explain quantum entanglement in simple terms')">üî¨ Explain science</div>
            <div class="sug-chip" onclick="useChip('Debug this Python code:\nfor i in range(10)\n  print(i)')">üõ†Ô∏è Debug code</div>
            <div class="sug-chip" onclick="useChip('What was the cause of World War 1?')">üìö History question</div>
            <div class="sug-chip" onclick="useChip('What do you remember about me?')">üß† What do you know?</div>
          </div>
        </div>
      </div>
    </div>

    <div class="input-zone">
      <div class="input-container">
        <div class="input-box">
          <textarea id="msgInput" placeholder="Message Jarvis..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚Üë</button>
        </div>
        <div class="input-hint">Enter to send ¬∑ Shift+Enter for newline ¬∑ Auto-routes between Groq & Gemini ¬∑ Always free</div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="mem-modal-overlay" id="memModal" onclick="closeMemModal(event)">
  <div class="mem-modal">
    <div class="mem-modal-header">
      <div class="mem-modal-title">üß† MEMORY VAULT</div>
      <button class="drawer-close" onclick="closeMemModal()">√ó</button>
    </div>
    <div class="mem-modal-body" id="memModalBody"></div>
  </div>
</div>

<script>
// ============================================================
// STORAGE POLYFILL ‚Äî GitHub Pages compatible
// ============================================================
if (!window.storage) {
  window.storage = {
    get: async (key) => {
      const value = localStorage.getItem(key);
      if (value === null) throw new Error('Not found: ' + key);
      return { key, value, shared: false };
    },
    set: async (key, value) => {
      try { localStorage.setItem(key, String(value)); return { key, value, shared: false }; } catch(e) { return null; }
    },
    delete: async (key) => { localStorage.removeItem(key); return { key, deleted: true }; },
    list: async (prefix) => ({ keys: Object.keys(localStorage).filter(k => !prefix || k.startsWith(prefix)), prefix })
  };
}

// ============================================================
// API CONFIG ‚Äî Both 100% FREE
// ============================================================
let GROQ_API_KEY   = localStorage.getItem('jarvis-groq-key')   || '';
let GEMINI_API_KEY = localStorage.getItem('jarvis-gemini-key') || '';

// Groq: OpenAI-compatible, free, no CORS issues
const GROQ_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';
// Gemini: Google AI Studio free tier, native browser CORS
const GEMINI_ENDPOINT = () =>
  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:streamGenerateContent?alt=sse&key=${GEMINI_API_KEY}`;

// ============================================================
// KEY SCREEN
// ============================================================
function showKeyScreen() {
  document.getElementById('keyScreen').style.display = 'flex';
  document.getElementById('appWrapper').style.display = 'none';
}
function hideKeyScreen() {
  document.getElementById('keyScreen').style.display = 'none';
  document.getElementById('appWrapper').style.display = 'flex';
}
function saveApiKeys() {
  const groq   = document.getElementById('groqKeyInput').value.trim();
  const gemini = document.getElementById('geminiKeyInput').value.trim();
  document.getElementById('groqKeyError').textContent   = '';
  document.getElementById('geminiKeyError').textContent = '';
  document.getElementById('keyGlobalError').textContent = '';
  let valid = true;
  if (!groq || !groq.startsWith('gsk_')) {
    document.getElementById('groqKeyError').textContent = '‚ö†Ô∏è Groq keys start with gsk_ ‚Äî get one free at console.groq.com';
    valid = false;
  }
  if (!gemini || !gemini.startsWith('AIza')) {
    document.getElementById('geminiKeyError').textContent = '‚ö†Ô∏è Gemini keys start with AIza ‚Äî get one free at aistudio.google.com';
    valid = false;
  }
  if (!valid) return;
  GROQ_API_KEY   = groq;
  GEMINI_API_KEY = gemini;
  localStorage.setItem('jarvis-groq-key',   groq);
  localStorage.setItem('jarvis-gemini-key', gemini);
  hideKeyScreen();
  showToast('üîë JARVIS activated! Both engines ready ‚Äî 100% free!');
  load();
}
function resetApiKeys() {
  if (!confirm('Remove API keys and return to setup?')) return;
  GROQ_API_KEY = ''; GEMINI_API_KEY = '';
  localStorage.removeItem('jarvis-groq-key');
  localStorage.removeItem('jarvis-gemini-key');
  showKeyScreen();
}
function handleKeyInput(e) {
  if (e.key === 'Enter') saveApiKeys();
  ['groqKeyError','geminiKeyError','keyGlobalError'].forEach(id => document.getElementById(id).textContent = '');
}

// ============================================================
// STATE
// ============================================================
let memories = [], conversationHistory = [], chatSessions = [];
let autosave = true, isThinking = false, msgCounter = 0;
let profile = { name:'Abhilas Rawat', emoji:'üë§', bio:'Creator & Owner' };
let memSummary = '';
const COMPRESS_THRESHOLD = 35;

// ============================================================
// SMART ROUTING
// Core rule: Gemini daily quota is precious ‚Üí use it only for
//            real knowledge/academic questions.
//            Everything else ‚Üí Groq (unlimited free).
// ============================================================
function classifyQuery(q) {
  const t = q.toLowerCase().trim();

  // Knowledge, facts, academic ‚Üí Gemini
  const knowledgeKw = [
    'explain','what is','what are','who is','who was','how does','how do','why does','why do','define','meaning',
    'history','historical','ancient','civilization','war','empire','revolution','century','decade',
    'science','physics','chemistry','biology','astronomy','geography','ecology',
    'math','solve','calculate','equation','formula','theorem','proof','algebra','calculus','integral','derivative',
    'medicine','medical','disease','virus','symptoms','health','nutrition','diet',
    'economics','economy','inflation','gdp','stock','finance','investment',
    'philosophy','ethics','psychology','sociology','anthropology',
    'literature','author','book','novel','poem','wrote','written by',
    'government','politics','constitution','law','rights','democracy',
    'technology history','invention','discovered','invented','founded',
    'quantum','relativity','evolution','dna','atom','molecule','periodic',
    'culture','religion','language','tradition','mythology',
    'facts about','tell me about','information about','learn about','teach me',
    'how was','when was','where is','what happened','explain how'
  ];
  if (knowledgeKw.some(k => t.includes(k))) {
    return { engine:'gemini', label:'üåê JARVIS via Gemini', chipClass:'chip-gemini' };
  }

  // Everything else ‚Üí Groq (casual, code, creative, opinions, personal)
  return { engine:'groq', label:'‚ö° JARVIS via Groq', chipClass:'chip-groq' };
}

// ============================================================
// SYSTEM PROMPT
// ============================================================
function buildSystem(engine) {
  const mem = buildMemContext();
  const mode = engine === 'gemini'
    ? 'Mode: Knowledge ‚Äî provide accurate, thorough, well-structured answers with examples.'
    : 'Mode: Conversational ‚Äî be friendly, natural, and direct. Match the user\'s energy.';
  return `You are JARVIS, the exclusive personal AI of Abhilas Rawat (creator & sole owner). Be helpful, personalized, and intelligent.\n${mode}${mem ? '\n\nWhat you know about the user:\n' + mem : ''}`;
}

// ============================================================
// GROQ STREAMING ‚Äî OpenAI SSE format
// Uses llama-3.1-8b-instant for simple, llama-3.3-70b-versatile for complex
// ============================================================
async function streamGroq(apiMsgs, system, textEl, cursorEl, simple) {
  const res = await fetch(GROQ_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${GROQ_API_KEY}` },
    body: JSON.stringify({
      model: simple ? 'llama-3.1-8b-instant' : 'llama-3.3-70b-versatile',
      stream: true,
      max_tokens: simple ? 400 : 900,
      messages: [{ role:'system', content:system }, ...apiMsgs]
    })
  });
  if (!res.ok) {
    let m = `Groq error ${res.status}`;
    try { const d = await res.json(); m = d.error?.message || m; } catch(e) {}
    throw new Error(m);
  }
  return await readOpenAIStream(res, textEl, cursorEl);
}

async function readOpenAIStream(res, textEl, cursorEl) {
  const reader = res.body.getReader();
  const dec = new TextDecoder();
  let full = '', buf = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buf += dec.decode(value, { stream:true });
    const lines = buf.split('\n');
    buf = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data:')) continue;
      const d = line.slice(5).trim();
      if (d === '[DONE]') break;
      try {
        const delta = JSON.parse(d).choices?.[0]?.delta?.content || '';
        if (delta) { full += delta; textEl.innerHTML = renderMarkdown(full); cursorEl.style.display='inline-block'; scrollBottom(); }
      } catch(e) {}
    }
  }
  cursorEl.style.display = 'none';
  textEl.innerHTML = renderMarkdown(full);
  return full;
}

// ============================================================
// GEMINI STREAMING ‚Äî Google SSE format
// Falls back to Groq automatically if quota exceeded
// ============================================================
async function streamGemini(apiMsgs, system, textEl, cursorEl) {
  // Convert to Gemini format (role must be "user" or "model")
  const contents = apiMsgs.map(m => ({
    role: m.role === 'assistant' ? 'model' : 'user',
    parts: [{ text: m.content }]
  }));

  const res = await fetch(GEMINI_ENDPOINT(), {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({
      system_instruction: { parts:[{ text: system }] },
      contents,
      generationConfig: { maxOutputTokens:1024, temperature:0.75 }
    })
  });

  // If Gemini quota hit ‚Üí silently fall back to Groq
  if (res.status === 429 || res.status === 503 || res.status === 500) {
    showToast('‚ö° Gemini limit reached ‚Äî switching to Groq');
    return await streamGroq(apiMsgs, system, textEl, cursorEl, false);
  }
  if (!res.ok) {
    let m = `Gemini error ${res.status}`;
    try { const d = await res.json(); m = d.error?.message || m; } catch(e) {}
    // Also fallback on auth errors (wrong key) gracefully
    showToast('‚ö†Ô∏è Gemini error ‚Äî switching to Groq');
    return await streamGroq(apiMsgs, system, textEl, cursorEl, false);
  }

  const reader = res.body.getReader();
  const dec = new TextDecoder();
  let full = '', buf = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buf += dec.decode(value, { stream:true });
    const lines = buf.split('\n');
    buf = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data:')) continue;
      const d = line.slice(5).trim();
      if (!d || d === '[DONE]') continue;
      try {
        const delta = JSON.parse(d).candidates?.[0]?.content?.parts?.[0]?.text || '';
        if (delta) { full += delta; textEl.innerHTML = renderMarkdown(full); cursorEl.style.display='inline-block'; scrollBottom(); }
      } catch(e) {}
    }
  }
  cursorEl.style.display = 'none';
  textEl.innerHTML = renderMarkdown(full);
  return full;
}

// ============================================================
// STREAM DISPATCHER
// ============================================================
async function streamReply(apiMsgs, route, textEl, cursorEl) {
  const t0 = Date.now();
  const system = buildSystem(route.engine);
  const isSimple = apiMsgs[apiMsgs.length-1]?.content?.split(' ')?.length <= 8;
  let text;
  if (route.engine === 'gemini') {
    text = await streamGemini(apiMsgs, system, textEl, cursorEl);
  } else {
    text = await streamGroq(apiMsgs, system, textEl, cursorEl, isSimple);
  }
  return { text, elapsed: ((Date.now() - t0) / 1000).toFixed(1) };
}

// ============================================================
// BACKGROUND LEARNING ‚Äî uses Groq (free, fast, unlimited)
// ============================================================
async function bgLearn(userMsg, aiReply, msgEl) {
  if (!autosave) return;
  msgCounter++;
  if (msgCounter % 2 !== 0 && memories.length > 5) return;
  try {
    const res = await fetch(GROQ_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${GROQ_API_KEY}` },
      body: JSON.stringify({
        model:'llama-3.1-8b-instant', max_tokens:120,
        messages:[{ role:'user', content:`Extract up to 2 key facts/preferences about the USER from this. Return ONLY a JSON array of short strings (<80 chars). Return [] if nothing notable.\nUser: "${userMsg.slice(0,150)}"\nAI: "${aiReply.slice(0,180)}"\nJSON:` }]
      })
    });
    const data = await res.json();
    const txt = (data.choices?.[0]?.message?.content||'[]').replace(/```json|```/g,'').trim();
    const arr = JSON.parse(txt);
    const items = Array.isArray(arr) ? arr.filter(s => typeof s==='string' && s.length>5) : [];
    if (items.length) {
      const now = new Date().toLocaleString();
      items.forEach(l => memories.push({ text:l, time:now }));
      appendMemIndicator(msgEl, items.length);
      updateMemUI();
      showToast(`‚ö° +${items.length} memory insight${items.length>1?'s':''} saved`);
      if (memories.length > COMPRESS_THRESHOLD) compressOldMemories();
      await persist();
    }
  } catch(e) {}
}

async function bgEval(q, a, msgEl) {
  try {
    const res = await fetch(GROQ_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${GROQ_API_KEY}` },
      body: JSON.stringify({
        model:'llama-3.1-8b-instant', max_tokens:70,
        messages:[{ role:'user', content:`Rate this AI response. Q="${q.slice(0,80)}" A="${a.slice(0,160)}"\nJSON only: {"confidence":85,"accuracy":80,"relevance":90}` }]
      })
    });
    const data = await res.json();
    const txt = (data.choices?.[0]?.message?.content||'{}').replace(/```json|```/g,'').trim();
    const p = JSON.parse(txt);
    appendEval(msgEl, { confidence:clamp(p.confidence??75), accuracy:clamp(p.accuracy??75), relevance:clamp(p.relevance??75) });
  } catch(e) {}
}

async function compressOldMemories() {
  if (memories.length < COMPRESS_THRESHOLD) return;
  const toCompress = memories.slice(0,20), recent = memories.slice(20);
  try {
    const res = await fetch(GROQ_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${GROQ_API_KEY}` },
      body: JSON.stringify({
        model:'llama-3.1-8b-instant', max_tokens:160,
        messages:[{ role:'user', content:`Compress these user facts into one short paragraph (max 180 chars):\n${toCompress.map(m=>m.text).join('\n')}\n\nOne paragraph only:` }]
      })
    });
    const data = await res.json();
    const summary = data.choices?.[0]?.message?.content?.trim()||'';
    if (summary) { memSummary = (memSummary?memSummary+' ':'')+summary; memories=recent; await persist(); }
  } catch(e) {}
}

// ============================================================
// SEND MESSAGE
// ============================================================
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || isThinking) return;

  isThinking = true;
  const btn = document.getElementById('sendBtn');
  btn.disabled = true; btn.classList.add('loading');
  input.value = ''; input.style.height = 'auto';

  const ws = document.getElementById('welcomeScreen');
  if (ws) ws.style.display = 'none';

  const route = classifyQuery(text);
  setSourceTag(route.label, true);
  addUserMsg(text);
  const thinkEl = addThinking();
  let thinkRemoved = false;

  try {
    const apiMsgs = conversationHistory.slice(-12).map(h => ({ role:h.role, content:h.content }));
    const memHit = quickMemSearch(text);
    apiMsgs.push({ role:'user', content: memHit ? `[Memory: ${memHit}]\n\n${text}` : text });

    thinkEl.remove(); thinkRemoved = true;

    const { msgEl, textEl, cursorEl } = addStreamingBubble(route);
    const { text: reply, elapsed } = await streamReply(apiMsgs, route, textEl, cursorEl);

    updateSpeedPill(elapsed);
    setSourceTag(route.label, false);
    conversationHistory.push({ role:'user', content:text });
    conversationHistory.push({ role:'assistant', content:reply });
    chatSessions.unshift({ preview:text.slice(0,60), time:new Date().toLocaleString() });
    await persist();
    updateHistoryUI();

    setTimeout(() => bgEval(text, reply, msgEl), 150);
    setTimeout(() => bgLearn(text, reply, msgEl), 300);
  } catch(err) {
    if (!thinkRemoved) { try { thinkEl.remove(); } catch(e) {} }
    addAIMsg(`‚ö†Ô∏è Error: ${err.message}\n\nTip: Check your API keys in the menu (‚ò∞).`, route || { engine:'groq', label:'‚ö° JARVIS', chipClass:'chip-groq' });
    setSourceTag('READY', false);
  }

  isThinking = false;
  btn.disabled = false; btn.classList.remove('loading');
  document.getElementById('msgInput').focus();
}

// ============================================================
// MEMORY HELPERS
// ============================================================
function buildMemContext() {
  const p = [];
  if (memSummary) p.push(`Summary: ${memSummary}`);
  if (memories.length) p.push(memories.slice(-15).map(m=>`‚Ä¢ ${m.text}`).join('\n'));
  return p.join('\n');
}
function quickMemSearch(q) {
  if (!memories.length && !memSummary) return null;
  const words = q.toLowerCase().split(/\s+/).filter(w=>w.length>3);
  const hits = memories.filter(m => words.some(w => m.text.toLowerCase().includes(w)));
  return hits.length ? hits.slice(-3).map(m=>m.text).join('; ') : null;
}

// ============================================================
// MARKDOWN RENDERER
// ============================================================
function renderMarkdown(text) {
  const codeBlocks=[], inlineCodes=[];
  let s = text.replace(/```([\w]*)\n?([\s\S]*?)```/g, (_,lang,code) => {
    codeBlocks.push(`<pre><code>${escHtml(code.trim())}</code></pre>`);
    return `\x00C${codeBlocks.length-1}\x00`;
  }).replace(/`([^`]+)`/g, (_,code) => {
    inlineCodes.push(`<code>${escHtml(code)}</code>`);
    return `\x00I${inlineCodes.length-1}\x00`;
  });
  s = escHtml(s);
  s = s.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>');
  s = s.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
  s = s.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
  s = s.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');
  s = s.replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  s = s.replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
  s = s.replace(/\x00C(\d+)\x00/g,(_,i)=>codeBlocks[+i]).replace(/\x00I(\d+)\x00/g,(_,i)=>inlineCodes[+i]);
  return s;
}

// ============================================================
// DOM HELPERS
// ============================================================
function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group user';
  g.innerHTML = `<div class="msg-bubble user"><div class="msg-text">${escHtml(text)}</div></div>`;
  msgs.appendChild(g); scrollBottom();
}
function addStreamingBubble(route) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div'); g.className = 'msg-group';
  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-avatar">J</div>
      <div class="ai-name">JARVIS</div>
      <div class="source-chip ${route.chipClass}">${escHtml(route.label)}</div>
    </div>
    <div class="msg-bubble ai">
      <div class="msg-text stream-text"></div><span class="cursor stream-cursor"></span>
    </div>`;
  msgs.appendChild(g); scrollBottom();
  return { msgEl:g, textEl:g.querySelector('.stream-text'), cursorEl:g.querySelector('.stream-cursor') };
}
function addAIMsg(text, route) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div'); g.className = 'msg-group';
  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-avatar">J</div>
      <div class="ai-name">JARVIS</div>
      <div class="source-chip ${route?.chipClass||'chip-groq'}">${escHtml(route?.label||'‚ö° JARVIS')}</div>
    </div>
    <div class="msg-bubble ai"><div class="msg-text">${renderMarkdown(text)}</div></div>`;
  msgs.appendChild(g); scrollBottom(); return g;
}
function addThinking() {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div'); g.className = 'msg-group';
  g.innerHTML = `<div class="msg-meta"><div class="ai-avatar">J</div><div class="ai-name">JARVIS</div></div><div class="thinking-bubble"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>`;
  msgs.appendChild(g); scrollBottom(); return g;
}
function appendEval(el, s) {
  const b = el.querySelector('.msg-bubble'); if(!b) return;
  const ev = document.createElement('div'); ev.className='eval-section';
  ev.innerHTML=`<div class="eval-title">Self Evaluation</div>
    <div class="eval-row"><div class="eval-label">Confidence</div><div class="eval-track"><div class="eval-fill fill-a" data-w="${s.confidence}"></div></div><div class="eval-num">${s.confidence}%</div></div>
    <div class="eval-row"><div class="eval-label">Accuracy</div><div class="eval-track"><div class="eval-fill fill-b" data-w="${s.accuracy}"></div></div><div class="eval-num">${s.accuracy}%</div></div>
    <div class="eval-row"><div class="eval-label">Relevance</div><div class="eval-track"><div class="eval-fill fill-c" data-w="${s.relevance}"></div></div><div class="eval-num">${s.relevance}%</div></div>`;
  b.appendChild(ev);
  setTimeout(()=>ev.querySelectorAll('.eval-fill').forEach(f=>f.style.width=f.dataset.w+'%'),80);
}
function appendMemIndicator(el, count) {
  const b = el.querySelector('.msg-bubble'); if(!b) return;
  const mi = document.createElement('div'); mi.className='mem-indicator';
  mi.innerHTML=`‚ö° +${count} memory insight${count>1?'s':''} stored`;
  b.appendChild(mi);
}
function setSourceTag(label, active) {
  document.getElementById('sourceLabel').textContent = active ? `ROUTING ‚Üí ${label}` : 'READY';
  document.getElementById('sourceTag').style.borderColor = active ? 'var(--accent)' : '';
}
function updateSpeedPill(elapsed) {
  const pill=document.getElementById('speedPill'), fast=parseFloat(elapsed)<2;
  pill.textContent=`‚ö° ${elapsed}s`;
  pill.className=`speed-pill ${fast?'fast':'medium'}`;
}
function scrollBottom() { requestAnimationFrame(()=>{ const w=document.getElementById('messagesWrap'); w.scrollTop=w.scrollHeight; }); }

// ============================================================
// UTILS
// ============================================================
function escHtml(t) { return t?String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''; }
function clamp(n) { return Math.min(100,Math.max(0,n)); }
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,160)+'px'; }
function useChip(text) { document.getElementById('msgInput').value=text; autoResize(document.getElementById('msgInput')); sendMessage(); }
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),3000);
}

// ============================================================
// PERSIST
// ============================================================
async function persist() {
  try { await window.storage.set('jarvis-mem',JSON.stringify(memories)); } catch(e){}
  try { await window.storage.set('jarvis-memsummary',memSummary); } catch(e){}
  try { await window.storage.set('jarvis-history',JSON.stringify(conversationHistory.slice(-30))); } catch(e){}
  try { await window.storage.set('jarvis-sessions',JSON.stringify(chatSessions.slice(-20))); } catch(e){}
}

// ============================================================
// UI
// ============================================================
function toggleAutosave() { autosave=!autosave; document.getElementById('autosaveSwitch').classList.toggle('on',autosave); showToast(autosave?'üß† Auto-save ON':'‚è∏ Auto-save OFF'); }
function updateMemUI() { document.getElementById('memCount').textContent=`${memories.length} Memor${memories.length!==1?'ies':'y'}`; }
function openMemModal() {
  const body=document.getElementById('memModalBody');
  if (!memories.length&&!memSummary) { body.innerHTML=`<div style="text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);padding:30px">No memories yet. Start chatting!</div>`; }
  else {
    let h='';
    if(memSummary) h+=`<div class="mem-entry" style="border-left-color:var(--accent2)"><div class="mem-entry-tag">COMPRESSED SUMMARY</div><div class="mem-entry-text">${escHtml(memSummary)}</div></div>`;
    h+=[...memories].reverse().map(m=>`<div class="mem-entry"><div class="mem-entry-tag">Learned</div><div class="mem-entry-text">${escHtml(m.text)}</div><div class="mem-entry-time">${m.time}</div></div>`).join('');
    h+=`<button class="drawer-btn danger-btn" onclick="clearMemory()" style="margin-top:8px;width:100%">üóë Clear All Memories</button>`;
    body.innerHTML=h;
  }
  document.getElementById('memModal').classList.add('open');
}
function closeMemModal(e) { if(!e||e.target===document.getElementById('memModal')) document.getElementById('memModal').classList.remove('open'); }
async function clearMemory() { if(!confirm('Clear all memories?')) return; memories=[];memSummary=''; await persist(); updateMemUI(); closeMemModal(); showToast('Memories cleared'); }
function openDrawer() { document.getElementById('drawer').classList.add('open'); document.getElementById('drawerOverlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }
function applyProfileUI() {
  document.getElementById('profileName').textContent=profile.name;
  document.getElementById('profileEmoji').textContent=profile.emoji;
  document.getElementById('profileHandle').textContent=profile.bio;
  document.getElementById('inputName').value=profile.name;
  document.getElementById('inputEmoji').value=profile.emoji;
  document.getElementById('inputBio').value=profile.bio;
  document.getElementById('logoSub').textContent=`Personal AI ¬∑ ${profile.name}`;
}
async function saveProfile() {
  profile.name=document.getElementById('inputName').value.trim()||'Abhilas Rawat';
  profile.emoji=document.getElementById('inputEmoji').value.trim()||'üë§';
  profile.bio=document.getElementById('inputBio').value.trim()||'Creator & Owner';
  try{await window.storage.set('jarvis-profile',JSON.stringify(profile));}catch(e){}
  applyProfileUI(); showToast('Profile saved');
}
function applyTheme(theme,el) {
  document.body.setAttribute('data-theme',theme);
  document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.remove('active'));
  if(el) el.classList.add('active');
  try{window.storage.set('jarvis-theme',theme);}catch(e){}
}
function updateHistoryUI() {
  const list=document.getElementById('historyList');
  if(!chatSessions.length){list.innerHTML=`<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:16px 0">No chat history yet</div>`;return;}
  list.innerHTML=chatSessions.slice(0,15).map(s=>`<div class="history-item"><div class="history-icon">üí¨</div><div class="history-text">${escHtml(s.preview)}</div><div class="history-time">${s.time?.split(',')[0]||''}</div></div>`).join('');
}
async function clearAll() {
  if(!confirm('Clear ALL data?')) return;
  memories=[];memSummary='';conversationHistory=[];chatSessions=[];
  await persist(); updateMemUI(); updateHistoryUI(); closeDrawer();
  showToast('All data cleared'); location.reload();
}

// ============================================================
// BOOT
// ============================================================
async function load() {
  if (!GROQ_API_KEY || !GEMINI_API_KEY) { showKeyScreen(); return; }
  hideKeyScreen();
  try{const r=await window.storage.get('jarvis-mem');if(r)memories=JSON.parse(r.value);}catch(e){memories=[];}
  try{const r=await window.storage.get('jarvis-memsummary');if(r)memSummary=r.value;}catch(e){}
  try{const r=await window.storage.get('jarvis-history');if(r)conversationHistory=JSON.parse(r.value);}catch(e){conversationHistory=[];}
  try{const r=await window.storage.get('jarvis-sessions');if(r)chatSessions=JSON.parse(r.value);}catch(e){chatSessions=[];}
  try{const r=await window.storage.get('jarvis-profile');if(r)profile=JSON.parse(r.value);}catch(e){}
  try{const r=await window.storage.get('jarvis-theme');if(r){document.body.setAttribute('data-theme',r.value);document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.toggle('active',s.dataset.theme===r.value));}}catch(e){}
  applyProfileUI(); updateMemUI(); updateHistoryUI();
}

load();
</script>
</body>
</html>
