<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JARVIS">
<meta name="theme-color" content="#0a0a0f">
<title>JARVIS ‚Äî Abhilas Rawat's Personal AI</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500&display=swap');

:root{
  --bg:#0a0a0f;--surface:#111118;--surface2:#16161f;--surface3:#1c1c28;
  --border:#1f1f2e;--border2:#2a2a3e;
  --accent:#4f8ef7;--accent2:#7c3aed;--accent3:#06d6a0;
  --accent-glow:rgba(79,142,247,0.15);
  --text:#e8eaf0;--text2:#a0a8c0;--muted:#4a5070;
  --danger:#ff4757;--gem:#34a853;--groq:#f59e0b;
}
[data-theme="midnight"]{--bg:#000008;--surface:#08080f;--surface2:#0d0d1a;--surface3:#111120;--border:#13132a;--border2:#1a1a35;--accent:#818cf8;--accent2:#a78bfa;--accent3:#34d399;--accent-glow:rgba(129,140,248,0.12);--text:#e0e7ff;--text2:#a5b4fc;--muted:#4c4f7a;}
[data-theme="light"]{--bg:#f4f6fb;--surface:#ffffff;--surface2:#eef1f8;--surface3:#e4e9f5;--border:#d8dff0;--border2:#c4cde8;--accent:#3b72f0;--accent2:#6d28d9;--accent3:#059669;--accent-glow:rgba(59,114,240,0.1);--text:#111827;--text2:#374151;--muted:#9ca3af;}
[data-theme="forest"]{--bg:#080f0a;--surface:#0e1a10;--surface2:#132016;--surface3:#1a2a1d;--border:#1e3222;--border2:#263d2a;--accent:#4ade80;--accent2:#22c55e;--accent3:#86efac;--accent-glow:rgba(74,222,128,0.12);--text:#ecfdf5;--text2:#a7f3d0;--muted:#4d7a58;}
[data-theme="sunset"]{--bg:#0f080a;--surface:#1a0e10;--surface2:#221318;--surface3:#2a1920;--border:#3a1f26;--border2:#4a2830;--accent:#fb923c;--accent2:#f43f5e;--accent3:#fbbf24;--accent-glow:rgba(251,146,60,0.15);--text:#fff1ee;--text2:#fca5a5;--muted:#7c4a4a;}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;transition:background .3s,color .3s;}

/* SETUP SCREEN */
#setupScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:30px 20px 20px;gap:0;overflow-y:auto;}
.s-logo{font-family:'Orbitron',monospace;font-size:30px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;}
.s-orb{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:#fff;animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 50px var(--accent-glow);margin-bottom:16px;}
.s-tag{font-size:13px;color:var(--text2);text-align:center;margin-bottom:20px;line-height:1.6;max-width:320px;}
.s-card{width:100%;max-width:400px;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:18px;margin-bottom:12px;}
.s-card-top{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.s-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.gem-ic{background:rgba(52,168,83,.15);border:1px solid rgba(52,168,83,.3);}
.groq-ic{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);}
.s-card-name{font-size:14px;font-weight:600;color:var(--text);}
.s-card-role{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.s-free{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;margin-bottom:10px;}
.gem-free{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.groq-free{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#f59e0b;}
.s-steps{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
.s-step{display:flex;align-items:flex-start;gap:8px;font-size:11px;color:var(--text2);line-height:1.5;}
.s-num{width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;flex-shrink:0;margin-top:1px;}
.gn{background:linear-gradient(135deg,#34a853,#0f9d58);}
.qn{background:linear-gradient(135deg,#f59e0b,#d97706);}
.s-step a{color:var(--accent);text-decoration:none;}
.s-input{width:100%;padding:11px 13px;border-radius:10px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;transition:border-color .2s;margin-bottom:5px;}
.s-input:focus{border-color:var(--accent);}
.s-err{font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:15px;margin-bottom:3px;}
.s-hint{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;text-align:center;margin-bottom:10px;}
.s-btn{width:100%;max-width:400px;padding:14px;border-radius:13px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:15px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;letter-spacing:.5px;transition:opacity .2s;margin-top:4px;}
.s-btn:hover{opacity:.92;}
.s-skip{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;text-align:center;cursor:pointer;margin-top:10px;text-decoration:underline;}

/* APP */
#appWrapper{display:none;flex-direction:column;height:100%;width:100%;position:fixed;inset:0;}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:0 14px;height:56px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;position:relative;z-index:20;}
.logo-area{display:flex;align-items:center;gap:10px;}
.logo-ring{width:34px;height:34px;border-radius:50%;border:2px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent3),var(--accent)) border-box;display:flex;align-items:center;justify-content:center;animation:hue-spin 4s linear infinite;font-size:14px;}
@keyframes hue-spin{to{filter:hue-rotate(360deg);}}
.logo-name{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-sub{font-size:9px;color:var(--muted);letter-spacing:1px;font-family:'JetBrains Mono',monospace;margin-top:-2px;}
.header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:5px;}
.status-tag{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);transition:all .3s;}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(.7);}}
.eng-pill{display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;border:1px solid var(--border2);background:var(--surface2);color:var(--muted);transition:all .3s;}
.ep-gem{color:var(--gem);border-color:rgba(52,168,83,.35);background:rgba(52,168,83,.08);}
.ep-groq{color:var(--groq);border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08);}
.header-right{display:flex;align-items:center;gap:7px;}
.mem-badge{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);border:1px solid rgba(6,214,160,.2);background:rgba(6,214,160,.06);cursor:pointer;transition:all .2s;white-space:nowrap;}
.mem-badge:hover{background:rgba(6,214,160,.12);}
.mem-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
.hamburger{width:36px;height:36px;border-radius:10px;border:1px solid var(--border2);background:var(--surface2);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;transition:all .2s;flex-shrink:0;}
.hamburger:hover{border-color:var(--accent);}
.hamburger span{display:block;width:16px;height:1.5px;background:var(--text2);border-radius:2px;}

/* BODY */
.app-body{display:flex;flex:1;overflow:hidden;position:relative;}

/* DRAWER */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;}
.drawer-overlay.open{opacity:1;pointer-events:all;}
.drawer{position:fixed;right:-310px;top:0;bottom:0;width:290px;background:var(--surface);border-left:1px solid var(--border);z-index:50;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);}
.drawer.open{right:0;}
.dhead{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.dtitle{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.dclose{width:26px;height:26px;border-radius:7px;border:1px solid var(--border2);background:none;color:var(--text2);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;}
.dbody{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.dsec{padding:13px 16px;border-bottom:1px solid var(--border);}
.dsec-t{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:11px;}
.pcard{display:flex;align-items:center;gap:11px;padding:11px;border-radius:12px;background:var(--surface2);border:1px solid var(--border2);margin-bottom:11px;}
.pav{width:42px;height:42px;border-radius:11px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.pname{font-size:13px;font-weight:600;color:var(--text);}
.pbio{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.obadge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:8px;background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--accent3);font-size:9px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:4px;}
.si{margin-bottom:10px;}
.sl{font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.sinput{width:100%;padding:8px 11px;border-radius:8px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;}
.sinput:focus{border-color:var(--accent);}
.ai-panel{padding:10px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border2);margin-bottom:8px;}
.ai-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.ai-row:last-child{margin-bottom:0;}
.ai-lbl{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.ai-dot{width:7px;height:7px;border-radius:50%;}
.dot-ok{background:#34a853;}
.dot-off{background:var(--muted);}
.tgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;}
.tsw{height:30px;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:white;}
.tsw.active{border-color:white;box-shadow:0 0 8px rgba(255,255,255,.3);}
.hitem{padding:8px 10px;border-radius:9px;border:1px solid var(--border);background:var(--surface2);margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}
.hicon{font-size:12px;flex-shrink:0;margin-top:1px;}
.htext{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.htime{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);flex-shrink:0;}
.dbtn{width:100%;padding:9px;border-radius:9px;border:1px solid var(--accent);background:rgba(79,142,247,.1);color:var(--accent);font-family:'Inter',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:5px;display:block;}
.dbtn:hover{background:rgba(79,142,247,.2);}
.ddanger{border-color:var(--danger)!important;background:rgba(255,71,87,.08)!important;color:var(--danger)!important;}

/* CHAT */
.chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.autosave-strip{position:absolute;top:11px;left:12px;z-index:10;}
.twrap{display:flex;align-items:center;gap:7px;padding:5px 11px;border-radius:20px;background:var(--surface2);border:1px solid var(--border2);cursor:pointer;user-select:none;}
.tsw2{width:26px;height:14px;border-radius:7px;background:var(--border2);position:relative;transition:background .3s;flex-shrink:0;}
.tsw2.on{background:var(--accent3);}
.tknob{position:absolute;top:2px;left:2px;width:10px;height:10px;border-radius:50%;background:white;transition:left .25s;}
.tsw2.on .tknob{left:14px;}
.tlbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text2);}
.msgs-wrap{flex:1;overflow-y:auto;padding:56px 0 14px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;display:flex;flex-direction:column;}
.msgs-inner{width:100%;max-width:740px;margin:0 auto;padding:0 14px;display:flex;flex-direction:column;gap:0;flex:1;}

/* WELCOME */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:54vh;text-align:center;gap:14px;padding:24px 14px;}
.w-orb{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));animation:orb-pulse 3s ease-in-out infinite;box-shadow:0 0 50px var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:white;}
@keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
.w-title{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;letter-spacing:6px;background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.w-sub{font-size:13px;color:var(--text2);max-width:400px;line-height:1.7;}
.w-engines{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.we{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;}
.we-gem{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.we-groq{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#f59e0b;}
.owner-line{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);border:1px solid var(--border2);padding:4px 13px;border-radius:20px;background:var(--surface2);}
.owner-line span{color:var(--accent3);font-weight:600;}
.chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:500px;}
.chip{padding:7px 13px;border-radius:20px;border:1px solid var(--border2);background:var(--surface2);font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s;}
.chip:hover{border-color:var(--accent);color:var(--text);}

/* MESSAGES */
.msg-group{padding:12px 0;animation:fadeUp .2s ease-out;}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.msg-group.user{display:flex;flex-direction:column;align-items:flex-end;}
.bubble{max-width:78%;padding:11px 15px;border-radius:17px;font-size:14px;line-height:1.75;}
.bubble.ai{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px;max-width:100%;}
.bubble.user{background:linear-gradient(135deg,rgba(79,142,247,.22),rgba(124,58,237,.18));border:1px solid rgba(79,142,247,.22);border-top-right-radius:4px;}
.mmeta{display:flex;align-items:center;gap:7px;margin-bottom:7px;}
.aav{width:22px;height:22px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;font-family:'Orbitron',monospace;color:white;flex-shrink:0;}
.anm{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.echip{display:flex;align-items:center;gap:3px;padding:2px 7px;border-radius:9px;font-family:'JetBrains Mono',monospace;font-size:8px;}
.ec-gem{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.ec-groq{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#f59e0b;}
.ec-err{background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.3);color:var(--danger);}
.msg-txt{white-space:pre-wrap;word-break:break-word;}

/* THINKING */
.tbbl{background:var(--surface2);border:1px solid var(--border);border-radius:17px;border-top-left-radius:4px;padding:13px 17px;display:inline-flex;align-items:center;gap:5px;}
.tdot{width:7px;height:7px;border-radius:50%;animation:tdot 1.4s ease-in-out infinite;}
.tdot:nth-child(1){background:var(--accent);}
.tdot:nth-child(2){background:var(--accent2);animation-delay:.2s;}
.tdot:nth-child(3){background:var(--accent3);animation-delay:.4s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-8px);}}

/* EVAL */
.eval-box{margin-top:11px;padding:9px 11px;border-radius:9px;background:rgba(0,0,0,.2);border:1px solid var(--border);}
.eval-t{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:7px;}
.eval-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.eval-row:last-child{margin-bottom:0;}
.elbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);width:70px;flex-shrink:0;}
.etrack{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
.efill{height:100%;border-radius:2px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1);}
.fa{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.fb{background:linear-gradient(90deg,var(--accent3),#34d399);}
.fc{background:linear-gradient(90deg,#34a853,#f59e0b);}
.enum{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text2);width:26px;text-align:right;}
.mind{display:flex;align-items:center;gap:4px;margin-top:7px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--accent3);}

/* INPUT */
.input-zone{padding:11px 14px 16px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
.input-container{max-width:740px;margin:0 auto;}
.input-box{display:flex;align-items:flex-end;gap:9px;background:var(--surface);border:1px solid var(--border2);border-radius:17px;padding:9px 11px;transition:border-color .25s,box-shadow .25s;}
.input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
#msgInput{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Inter',sans-serif;font-size:15px;line-height:1.6;resize:none;max-height:130px;min-height:24px;}
#msgInput::placeholder{color:var(--muted);}
.send-btn{width:36px;height:36px;border-radius:9px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;transition:all .2s;}
.send-btn:hover{transform:scale(1.06);}
.send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.ihint{text-align:center;font-size:9px;color:var(--muted);margin-top:7px;font-family:'JetBrains Mono',monospace;}

/* TOAST */
.toast{position:fixed;bottom:85px;left:50%;transform:translateX(-50%) translateY(18px);padding:8px 15px;border-radius:11px;background:rgba(6,214,160,.14);border:1px solid rgba(6,214,160,.32);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);z-index:900;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* MEMORY MODAL */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:14px;}
.moverlay.open{display:flex;}
.mmodal{width:100%;max-width:500px;max-height:80vh;background:var(--surface);border:1px solid var(--border2);border-radius:18px;display:flex;flex-direction:column;animation:modalIn .25s ease-out;overflow:hidden;}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(7px);}to{opacity:1;transform:none;}}
.mhead{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.mtitle{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--accent3);}
.mbody{overflow-y:auto;padding:14px 18px;flex:1;}
.mentry{padding:10px 12px;border-radius:9px;border:1px solid var(--border);background:var(--surface2);margin-bottom:6px;border-left:3px solid var(--accent3);}
.metag{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--accent3);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;}
.metext{font-size:13px;color:var(--text);line-height:1.5;}
.metime{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);margin-top:3px;}

/* SOURCES BAR */
.bubble.ai{position:relative;}
.src-bar{position:absolute;top:8px;right:10px;display:flex;align-items:center;gap:3px;z-index:2;}
.src-ic{width:20px;height:20px;border-radius:5px;background:var(--surface3);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:9px;flex-shrink:0;}
.src-ic img{width:14px;height:14px;object-fit:contain;display:block;}
.src-plus{width:20px;height:20px;border-radius:5px;background:rgba(79,142,247,.15);border:1px solid rgba(79,142,247,.3);color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s;flex-shrink:0;}
.src-plus:hover{background:rgba(79,142,247,.3);}
.src-panel{margin-top:10px;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,.25);border:1px solid var(--border);display:none;}
.src-panel.open{display:block;}
.src-panel-t{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;}
.src-lnk{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:7px;background:var(--surface2);border:1px solid var(--border);margin-bottom:5px;text-decoration:none;transition:border-color .2s;}
.src-lnk:hover{border-color:var(--accent);}
.src-lnk:last-child{margin-bottom:0;}
.src-fav{width:18px;height:18px;border-radius:4px;background:var(--surface3);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:8px;flex-shrink:0;}
.src-fav img{width:12px;height:12px;object-fit:contain;display:block;}
.src-info{flex:1;overflow:hidden;}
.src-ttl{font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.src-dom{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.src-arr{font-size:10px;color:var(--muted);flex-shrink:0;}
/* WEB SEARCH BADGE */
.ws-strip{position:absolute;top:11px;left:12px;z-index:10;}
.ws-badge{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:20px;background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.25);font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--accent);}
.ws-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:pdot 2s ease-in-out infinite;}
/* SESSION HISTORY */
.sess-item{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);margin-bottom:6px;cursor:pointer;transition:border-color .2s;}
.sess-item:hover{border-color:var(--accent);}
.sess-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.sess-date{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);}
.sess-cnt{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);}
.sess-prev{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sov{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:300;display:none;align-items:center;justify-content:center;padding:14px;}
.sov.open{display:flex;}
.smodal{width:100%;max-width:520px;max-height:85vh;background:var(--surface);border:1px solid var(--border2);border-radius:18px;display:flex;flex-direction:column;animation:modalIn .25s ease-out;overflow:hidden;}
.shead{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.stitle{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.sbody{overflow-y:auto;flex:1;}
.smsg{border-bottom:1px solid var(--border);padding:14px 18px;}
.swho{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.swho.u{color:var(--accent);}
.swho.a{color:var(--groq);}
.stxt{font-size:13px;color:var(--text2);line-height:1.6;white-space:pre-wrap;word-break:break-word;}

::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setupScreen">
  <div class="s-logo">JARVIS</div>
  <div class="s-orb">J</div>
  <div class="s-tag">Your personal AI ‚Äî powered by <strong>Gemini</strong> &amp; <strong>Groq</strong>.<br>Both 100% free. Enter one or both keys.</div>

  <!-- Gemini -->
  <div class="s-card">
    <div class="s-card-top">
      <div class="s-icon gem-ic">üåê</div>
      <div>
        <div class="s-card-name">Google Gemini</div>
        <div class="s-card-role">General ¬∑ Writing ¬∑ Creative ¬∑ Reasoning</div>
      </div>
    </div>
    <div class="s-free gem-free">‚úÖ FREE ‚Äî 1500 requests/day</div>
    <div class="s-steps">
      <div class="s-step"><div class="s-num gn">1</div><div>Go to <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div></div>
      <div class="s-step"><div class="s-num gn">2</div><div>Sign in with Google ‚Üí tap <strong>Create API Key</strong></div></div>
      <div class="s-step"><div class="s-num gn">3</div><div>Copy &amp; paste below</div></div>
    </div>
    <input id="gemKey" class="s-input" type="password" placeholder="AIzaSy..." autocomplete="off"/>
    <div id="gemErr" class="s-err"></div>
  </div>

  <!-- Groq -->
  <div class="s-card">
    <div class="s-card-top">
      <div class="s-icon groq-ic">‚ö°</div>
      <div>
        <div class="s-card-name">Groq</div>
        <div class="s-card-role">Coding ¬∑ Math ¬∑ Debugging ¬∑ Fast answers</div>
      </div>
    </div>
    <div class="s-free groq-free">‚úÖ FREE ‚Äî Very generous limits</div>
    <div class="s-steps">
      <div class="s-step"><div class="s-num qn">1</div><div>Go to <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></div></div>
      <div class="s-step"><div class="s-num qn">2</div><div>Sign up with Google ‚Üí tap <strong>Create API Key</strong></div></div>
      <div class="s-step"><div class="s-num qn">3</div><div>Copy &amp; paste below</div></div>
    </div>
    <input id="groqKey" class="s-input" type="password" placeholder="gsk_..." autocomplete="off"/>
    <div id="groqErr" class="s-err"></div>
  </div>

  <div class="s-hint">‚ö° Enter at least one key ¬∑ Both = maximum power</div>
  <button class="s-btn" onclick="activate()">ACTIVATE JARVIS ‚ö°</button>
  <div class="s-skip" onclick="skipSetup()">Already set up ‚Äî go to app</div>
</div>

<!-- MAIN APP -->
<div id="appWrapper">
  <div class="toast" id="toast"></div>

  <div class="header">
    <div class="logo-area">
      <div class="logo-ring">‚¨°</div>
      <div>
        <div class="logo-name">JARVIS</div>
        <div class="logo-sub" id="logoSub">Personal AI ¬∑ Abhilas Rawat</div>
      </div>
    </div>
    <div class="header-center">
      <div class="status-tag" id="statusTag">
        <div class="status-dot"></div>
        <span id="statusLbl">READY</span>
      </div>
      <div class="eng-pill" id="engPill">‚Äî ‚Äî</div>
    </div>
    <div class="header-right">
      <div class="mem-badge" onclick="openMem()">
        <div class="mem-dot"></div>
        <span id="memCount">0 Memories</span>
      </div>
      <div class="hamburger" onclick="openDrawer()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <div class="app-body">
    <div class="drawer-overlay" id="doverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="drawer">
      <div class="dhead">
        <div class="dtitle">SETTINGS</div>
        <button class="dclose" onclick="closeDrawer()">√ó</button>
      </div>
      <div class="dbody">
        <div class="dsec">
          <div class="dsec-t">Profile</div>
          <div class="pcard">
            <div class="pav" id="pEmoji">üë§</div>
            <div>
              <div class="pname" id="pName">Abhilas Rawat</div>
              <div class="pbio" id="pBio">Creator &amp; Owner</div>
              <div class="obadge">üëë SOLE OWNER</div>
            </div>
          </div>
          <div class="si"><div class="sl">Name</div><input class="sinput" id="iName" value="Abhilas Rawat"/></div>
          <div class="si"><div class="sl">Emoji</div><input class="sinput" id="iEmoji" value="üë§" maxlength="4"/></div>
          <div class="si"><div class="sl">Bio</div><input class="sinput" id="iBio" value="Creator &amp; Owner"/></div>
          <button class="dbtn" onclick="saveProfile()">Save Profile</button>
        </div>
        <div class="dsec">
          <div class="dsec-t">AI Engines</div>
          <div class="ai-panel">
            <div class="ai-row"><span class="ai-lbl">üåê Gemini (General)</span><div class="ai-dot" id="gemDot"></div></div>
            <div class="ai-row"><span class="ai-lbl">‚ö° Groq (Technical)</span><div class="ai-dot" id="groqDot"></div></div>
          </div>
          <button class="dbtn" onclick="goSetup()">üîë Change API Keys</button>
        </div>
        <div class="dsec">
          <div class="dsec-t">Color Theme</div>
          <div class="tgrid">
            <div class="tsw active" style="background:linear-gradient(135deg,#0a0a0f,#4f8ef7)" data-theme="dark" onclick="applyTheme('dark',this)">Dark</div>
            <div class="tsw" style="background:linear-gradient(135deg,#000008,#818cf8)" data-theme="midnight" onclick="applyTheme('midnight',this)">Night</div>
            <div class="tsw" style="background:linear-gradient(135deg,#f4f6fb,#3b72f0);color:#111" data-theme="light" onclick="applyTheme('light',this)">Light</div>
            <div class="tsw" style="background:linear-gradient(135deg,#080f0a,#4ade80)" data-theme="forest" onclick="applyTheme('forest',this)">Forest</div>
            <div class="tsw" style="background:linear-gradient(135deg,#0f080a,#fb923c)" data-theme="sunset" onclick="applyTheme('sunset',this)">Sunset</div>
          </div>
        </div>
        <div class="dsec">
          <div class="dsec-t">Session History</div>
          <div id="histList"><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:12px 0">No past sessions yet</div></div>
        </div>
        <div class="dsec">
          <div class="dsec-t">Data</div>
          <button class="dbtn ddanger" onclick="clearAll()">üóë Clear All Data</button>
        </div>
      </div>
    </div>

    <div class="chat-main">
      <div class="ws-strip">
        <div class="ws-badge"><div class="ws-dot"></div>WEB SEARCH ON</div>
      </div>
      <div class="msgs-wrap" id="msgsWrap">
        <div class="msgs-inner" id="msgs">
          <div class="welcome" id="welcome">
            <div class="w-orb">J</div>
            <div class="w-title">JARVIS</div>
            <div class="w-sub">Your personal AI ‚Äî built exclusively for <strong>Abhilas Rawat</strong>.<br>Web search always on. AI + real internet combined for every answer.</div>
            <div class="w-engines">
              <div class="we we-gem">üåê Gemini ‚Äî General</div>
              <div class="we we-groq">‚ö° Groq ‚Äî Technical</div>
              <div class="we" style="background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);color:var(--accent)">üîç Web Search ‚Äî Always On</div>
            </div>
            <div class="owner-line">Created by <span>Abhilas Rawat</span> ¬∑ Sole Owner ¬∑ Private &amp; Personal</div>
            <div class="chips">
              <div class="chip" onclick="useChip('Who are you and what can you do for me?')">ü§ñ Who are you?</div>
              <div class="chip" onclick="useChip('Write a Python function to sort a list of dictionaries by a key')">üõ†Ô∏è Python sorting</div>
              <div class="chip" onclick="useChip('Write a short sci-fi story about AI becoming conscious')">‚úçÔ∏è Write a story</div>
              <div class="chip" onclick="useChip('Solve: integrate x squared times e to the power x dx')">‚à´ Solve integral</div>
              <div class="chip" onclick="useChip('What do you remember about me?')">üß† Your memories</div>
              <div class="chip" onclick="useChip('What are the biggest AI breakthroughs of 2025?')">üí° AI in 2025</div>
            </div>
          </div>
        </div>
      </div>
      <div class="input-zone">
        <div class="input-container">
          <div class="input-box">
            <textarea id="msgInput" placeholder="Message Jarvis..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="send()">‚Üë</button>
          </div>
          <div class="ihint">Enter to send ¬∑ Shift+Enter for newline ¬∑ Web search always on ¬∑ Free</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Session History Modal -->
<div class="sov" id="sessModal" onclick="closeSessMod(event)">
  <div class="smodal">
    <div class="shead">
      <div class="stitle" id="sessTitle">SESSION</div>
      <button class="dclose" onclick="closeSessMod()">√ó</button>
    </div>
    <div class="sbody" id="sessBody"></div>
  </div>
</div>

<!-- Memory Modal -->
<div class="moverlay" id="memModal" onclick="closeMem(event)">
  <div class="mmodal">
    <div class="mhead">
      <div class="mtitle">üß† MEMORY VAULT</div>
      <button class="dclose" onclick="closeMem()">√ó</button>
    </div>
    <div class="mbody" id="memBody"></div>
  </div>
</div>

<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STORAGE POLYFILL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
if (!window.storage) {
  window.storage = {
    get: async k => { const v = localStorage.getItem(k); if (v === null) throw new Error('nf'); return {key:k,value:v}; },
    set: async (k,v) => { localStorage.setItem(k,String(v)); return {key:k,value:v}; },
    delete: async k => { localStorage.removeItem(k); return {key:k,deleted:true}; }
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let GEM_KEY  = localStorage.getItem('j-gem')  || '';
let GROQ_KEY = localStorage.getItem('j-groq') || '';

const GEM_URL  = () => `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEM_KEY}`;
const GROQ_URL = 'https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL = 'llama-3.3-70b-versatile';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function activate() {
  const gk = (document.getElementById('gemKey').value||'').trim();
  const qk = (document.getElementById('groqKey').value||'').trim();
  document.getElementById('gemErr').textContent = '';
  document.getElementById('groqErr').textContent = '';
  let err = false;
  if (gk && !gk.startsWith('AIza')) { document.getElementById('gemErr').textContent = '‚ö†Ô∏è Gemini keys start with AIza'; err=true; }
  if (qk && !qk.startsWith('gsk_')) { document.getElementById('groqErr').textContent = '‚ö†Ô∏è Groq keys start with gsk_'; err=true; }
  if (!gk && !qk) { document.getElementById('gemErr').textContent = '‚ö†Ô∏è Enter at least one key'; err=true; }
  if (err) return;
  if (gk) { GEM_KEY=gk; localStorage.setItem('j-gem',gk); }
  if (qk) { GROQ_KEY=qk; localStorage.setItem('j-groq',qk); }
  showApp();
}

function skipSetup() {
  if (!GEM_KEY && !GROQ_KEY) { document.getElementById('gemErr').textContent = '‚ö†Ô∏è No saved keys found'; return; }
  showApp();
}

function showApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('appWrapper').style.display = 'flex';
  updateDots();
  load();
}

function goSetup() {
  closeDrawer();
  document.getElementById('setupScreen').style.display = 'flex';
  document.getElementById('appWrapper').style.display = 'none';
  if (GEM_KEY)  document.getElementById('gemKey').value  = GEM_KEY;
  if (GROQ_KEY) document.getElementById('groqKey').value = GROQ_KEY;
}

['gemKey','groqKey'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => {
    document.getElementById('gemErr').textContent = '';
    document.getElementById('groqErr').textContent = '';
    if (e.key === 'Enter') activate();
  });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   API CALLERS ‚Äî with web search
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GROQ_SEARCH_TOOL = {
  type:'function',
  function:{
    name:'web_search',
    description:'Search the web for current real-time information',
    parameters:{type:'object',properties:{query:{type:'string'}},required:['query']}
  }
};

async function callGemini(userMsg, sys, history) {
  if (!GEM_KEY) throw new Error('NO_GEM_KEY');
  const contents = [];
  (history||[]).forEach(h => contents.push({ role:h.role==='assistant'?'model':'user', parts:[{text:h.content}] }));
  contents.push({ role:'user', parts:[{text:userMsg}] });
  const res = await fetch(GEM_URL(), {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      system_instruction:{parts:[{text:sys}]}, contents,
      generationConfig:{maxOutputTokens:1500,temperature:0.9},
      tools:[{googleSearch:{}}]
    })
  });
  if (!res.ok) { const j=await res.json().catch(()=>{}); throw new Error(j?.error?.message||`Gemini ${res.status}`); }
  const d = await res.json();
  const txt = d.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!txt) throw new Error('Gemini returned empty response');
  const sources = [];
  const chunks = d.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
  chunks.forEach(ch => { if (ch.web?.uri) sources.push({url:ch.web.uri, title:ch.web.title||ch.web.uri}); });
  return {text:txt, sources};
}

async function callGroq(userMsg, sys, history) {
  if (!GROQ_KEY) throw new Error('NO_GROQ_KEY');
  const messages = [{role:'system',content:sys}];
  (history||[]).forEach(h => messages.push({role:h.role,content:h.content}));
  messages.push({role:'user',content:userMsg});
  const res1 = await fetch(GROQ_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${GROQ_KEY}`},
    body: JSON.stringify({model:GROQ_MODEL, messages, max_tokens:1500, temperature:0.7, tools:[GROQ_SEARCH_TOOL], tool_choice:'required'})
  });
  if (!res1.ok) { const j=await res1.json().catch(()=>{}); throw new Error(j?.error?.message||`Groq ${res1.status}`); }
  const d1 = await res1.json();
  const msg1 = d1.choices?.[0]?.message;
  // With tool_choice:'required', Groq WILL call the tool
  // But handle both cases safely
  const toolCalls = msg1?.tool_calls;
  if (toolCalls?.length) {
    const tc = toolCalls[0];
    let query = userMsg;
    try { query = JSON.parse(tc.function.arguments).query || userMsg; } catch(_){}
    let searchResult = '';
    let sources = [];

    // Helper: decode DDG redirect URLs to real URLs
    function decodeDDGUrl(u) {
      try {
        if (!u) return null;
        if (u.includes('duckduckgo.com/l/?')) {
          const uddg = new URL(u).searchParams.get('uddg');
          return uddg ? decodeURIComponent(uddg) : null;
        }
        if (u.startsWith('http') && !u.includes('duckduckgo.com')) return u;
        return null;
      } catch(_) { return null; }
    }

    // Helper: generate smart known-source URLs from query keywords
    function smartSources(q) {
      const result = [];
      const qLow = q.toLowerCase().replace(/[^a-z0-9 ]/g,'').trim();
      const wikiSlug = qLow.replace(/\s+/g,'_');
      const wikiSearch = encodeURIComponent(qLow);
      // Wikipedia is always a valid source
      result.push({url:`https://en.wikipedia.org/wiki/${wikiSlug}`, title:`Wikipedia ‚Äî ${q}`});
      // Topic-based sources
      const topics = {
        code:['developer.mozilla.org','stackoverflow.com','github.com'],
        javascript:['developer.mozilla.org','javascript.info','stackoverflow.com'],
        python:['docs.python.org','realpython.com','stackoverflow.com'],
        html:['developer.mozilla.org','w3schools.com'],
        css:['developer.mozilla.org','css-tricks.com'],
        react:['react.dev','stackoverflow.com'],
        math:['mathworld.wolfram.com','brilliant.org','khanacademy.org'],
        physics:['hyperphysics.phy-astr.gsu.edu','britannica.com','khanacademy.org'],
        chemistry:['chemguide.co.uk','britannica.com','khanacademy.org'],
        biology:['biology-online.org','britannica.com','khanacademy.org'],
        history:['britannica.com','history.com'],
        science:['britannica.com','livescience.com','sciencedaily.com'],
        health:['healthline.com','webmd.com','mayoclinic.org'],
        news:['reuters.com','bbc.com/news','apnews.com'],
        ai:['arxiv.org','mit.edu','openai.com/blog'],
        finance:['investopedia.com','bloomberg.com'],
        law:['law.cornell.edu','justia.com'],
      };
      for (const [kw, domains] of Object.entries(topics)) {
        if (qLow.includes(kw)) {
          domains.slice(0,2).forEach(d => {
            result.push({url:`https://${d}/search?q=${wikiSearch}`, title:`${d} ‚Äî ${q}`});
          });
          break;
        }
      }
      // Always add Britannica + Khan as fallback
      if (!qLow.match(/code|javascript|python|html|css|react/)) {
        result.push({url:`https://www.britannica.com/search?query=${wikiSearch}`, title:`Britannica ‚Äî ${q}`});
        result.push({url:`https://www.khanacademy.org/search?page_search_query=${wikiSearch}`, title:`Khan Academy ‚Äî ${q}`});
      }
      return result.slice(0,6);
    }

    try {
      const ddRes = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
      const dd = await ddRes.json();
      const parts = [];
      if (dd.AbstractText) parts.push(dd.AbstractText);
      if (dd.Answer) parts.push('Answer: '+dd.Answer);
      if (dd.RelatedTopics?.length) parts.push(dd.RelatedTopics.slice(0,3).map(t=>t.Text||'').filter(Boolean).join(' | '));
      searchResult = parts.join('\n') || '';
      // Extract REAL urls (decode DDG redirects)
      if (dd.AbstractURL && !dd.AbstractURL.includes('duckduckgo.com')) {
        sources.push({url:dd.AbstractURL, title:dd.AbstractSource||query});
      }
      (dd.RelatedTopics||[]).slice(0,8).forEach(t => {
        const realUrl = decodeDDGUrl(t.FirstURL);
        if (realUrl) sources.push({url:realUrl, title:t.Text?.slice(0,55)||realUrl});
      });
    } catch(_) {}

    // Always supplement with smart known sources to guarantee we have sources
    const smart = smartSources(query);
    smart.forEach(s => {
      if (!sources.find(x => x.url === s.url)) sources.push(s);
    });
    sources = sources.slice(0,8);

    if (!searchResult) searchResult = `Web search performed for: "${query}". Providing comprehensive answer based on current knowledge.`;
    const messages2 = [...messages,
      {role:'assistant', content:null, tool_calls:toolCalls},
      {role:'tool', tool_call_id:tc.id, content:searchResult}
    ];
    const res2 = await fetch(GROQ_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${GROQ_KEY}`},
      body: JSON.stringify({model:GROQ_MODEL, messages:messages2, max_tokens:1500, temperature:0.7})
    });
    if (!res2.ok) { const j=await res2.json().catch(()=>{}); throw new Error(j?.error?.message||`Groq ${res2.status}`); }
    const d2 = await res2.json();
    const txt = d2.choices?.[0]?.message?.content;
    if (!txt) throw new Error('Groq returned empty response');
    return {text:txt, sources};
  }
  // Fallback: direct answer (shouldn't happen with tool_choice:'required')
  const txt = msg1?.content;
  if (!txt) throw new Error('Groq returned empty response');
  return {text:txt, sources:[]};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SMART CALL ‚Äî auto fallback
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function smartCall(msg, sys, history, prefer) {
  const order = prefer === 'groq'
    ? [{name:'groq',fn:()=>callGroq(msg,sys,history)},{name:'gemini',fn:()=>callGemini(msg,sys,history)}]
    : [{name:'gemini',fn:()=>callGemini(msg,sys,history)},{name:'groq',fn:()=>callGroq(msg,sys,history)}];
  const available = order.filter(e => e.name==='gemini' ? !!GEM_KEY : !!GROQ_KEY);
  if (!available.length) throw new Error('No API keys set up. Tap ‚ò∞ ‚Üí Change API Keys.');
  let lastErr = null;
  for (const eng of available) {
    try {
      const result = await eng.fn(); // now returns {text, sources}
      return {text:result.text, sources:result.sources||[], engine:eng.name};
    } catch(e) {
      lastErr = e;
    }
  }
  const msg2 = lastErr?.message || 'Unknown error';
  const isQuota = msg2.toLowerCase().includes('quota') || msg2.toLowerCase().includes('rate') || msg2.toLowerCase().includes('limit');
  if (isQuota) throw new Error('Rate limit reached on both AIs. Wait 1 minute ‚Äî resets automatically.');
  throw new Error(msg2);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROUTING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function route(q) {
  const t = q.toLowerCase();
  const tech = ['code','debug','function','bug','error','syntax','program','script','algorithm',
    'class','method','variable','loop','array','api','import','module','html','css',
    'javascript','python','java','rust','typescript','react','node','bash','shell','git',
    'solve','calculate','integral','derivative','equation','math','matrix','probability',
    'formula','theorem','algebra','geometry','calculus','physics','chemistry'];
  return tech.some(k => t.includes(k)) ? 'groq' : 'gemini';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SYSTEM PROMPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSys(engine) {
  const mem = buildMemCtx();
  const note = engine==='groq'
    ? 'You are in Technical Mode. ALWAYS use the web_search tool before answering ‚Äî search for the most current, accurate information. Be precise, give working code/solutions, show reasoning step by step.'
    : 'You are in General Mode. Be warm, clear, creative, and accurate. Google Search grounding is enabled ‚Äî use it to find real information.';
  return `You are JARVIS, the exclusive personal AI of Abhilas Rawat. He built you, he owns you, you serve only him. Be direct, intelligent, and genuinely helpful.\n${note}\nAlways combine web search results with your own knowledge for maximum accuracy.${mem?'\n\nWhat you know about Abhilas:\n'+mem:''}`;
}

function buildMemCtx() {
  const p = [];
  if (memSum) p.push('Summary: '+memSum);
  if (mems.length) p.push(mems.slice(-12).map(m=>'‚Ä¢ '+m.t).join('\n'));
  return p.join('\n');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let mems = [];
let sessionHist = [];    // messages in THIS session only (fresh per app open)
let allSessions = [];    // all past saved sessions
let autosave = true;
let busy = false;
let mc = 0;
let memSum = '';
let prof = {name:'Abhilas Rawat',emoji:'üë§',bio:'Creator & Owner'};
const COMPRESS_AT = 35;
const SESSION_ID = Date.now(); // unique ID for this session

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEND
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function send() {
  const inp = document.getElementById('msgInput');
  const txt = inp.value.trim();
  if (!txt || busy) return;
  busy=true;
  document.getElementById('sendBtn').disabled=true;
  inp.value=''; inp.style.height='auto';
  const w=document.getElementById('welcome'); if(w) w.style.display='none';
  setStatus(true,'SEARCHING...');
  addUser(txt);
  const think=addThink();
  try {
    const pref = route(txt);
    setEng(pref, false);
    const memHit = memSearch(txt);
    const userMsg = memHit ? `[Memory: ${memHit}]\n\n${txt}` : txt;
    const {text:reply, sources, engine} = await smartCall(userMsg, buildSys(pref), sessionHist.slice(-10), pref);
    think.remove();
    const mel = addAI(reply, engine, sources||[]);
    setEng(engine, true);
    setStatus(false,'READY');
    sessionHist.push({role:'user',content:txt});
    sessionHist.push({role:'assistant',content:reply});
    await saveSession();
    setTimeout(()=>bgEval(txt,reply,mel,engine),200);
    setTimeout(()=>bgLearn(txt,reply,mel),500);
  } catch(e) {
    think.remove();
    addAI('‚ö†Ô∏è '+e.message, 'err', []);
    setStatus(false,'ERROR');
  }
  busy=false;
  document.getElementById('sendBtn').disabled=false;
  inp.focus();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BACKGROUND EVAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function bgEval(q,a,el,eng) {
  const p=`Rate this AI response quality. Q:"${q.slice(0,80)}" A:"${a.slice(0,150)}"\nReturn only valid JSON: {"confidence":85,"accuracy":80,"relevance":90}`;
  try {
    let raw='';
    if (eng==='groq'&&GROQ_KEY) { const r=await callGroq(p,'Return only valid JSON, nothing else.',[]); raw=r.text; }
    else if (GEM_KEY) { const r=await callGemini(p,'Return only valid JSON, nothing else.',[]); raw=r.text; }
    else return;
    const j=JSON.parse(raw.replace(/```json|```/g,'').trim());
    showEval(el,{c:clamp(j.confidence??75),a:clamp(j.accuracy??75),r:clamp(j.relevance??75)});
  } catch(_) {}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BACKGROUND LEARN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function bgLearn(userMsg,reply,el) {
  if (!autosave) return;
  mc++; if(mc%2!==0&&mems.length>5) return;
  const p=`Extract up to 2 facts about the USER from this chat. Return only a JSON array of short strings. Return [] if nothing new.\nUser:"${userMsg.slice(0,120)}"\nAI:"${reply.slice(0,180)}"`;
  try {
    let raw='';
    if (GEM_KEY) { const r=await callGemini(p,'Return only a valid JSON array of strings, no markdown.',[]); raw=r.text; }
    else if (GROQ_KEY) { const r=await callGroq(p,'Return only a valid JSON array of strings, no markdown.',[]); raw=r.text; }
    else return;
    const arr=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const items=Array.isArray(arr)?arr.filter(s=>typeof s==='string'&&s.length>4):[];
    if (items.length) {
      const now=new Date().toLocaleString();
      items.forEach(l=>mems.push({t:l,time:now}));
      showMemInd(el,items.length); updateMemUI();
      showToast(`‚ö° +${items.length} memory saved`);
      if (mems.length>COMPRESS_AT) compressMem();
      await persist();
    }
  } catch(_) {}
}

async function compressMem() {
  if (mems.length<COMPRESS_AT) return;
  const toC=mems.slice(0,20); const recent=mems.slice(20);
  const p=`Compress these facts into one short paragraph (max 200 chars):\n${toC.map(m=>m.t).join('\n')}`;
  try {
    let s='';
    if (GEM_KEY) { const r=await callGemini(p,'Return only the paragraph, nothing else.',[]); s=r.text; }
    else if (GROQ_KEY) { const r=await callGroq(p,'Return only the paragraph, nothing else.',[]); s=r.text; }
    if (s) { memSum=(memSum?memSum+' ':'')+s.trim(); mems=recent; await persist(); }
  } catch(_) {}
}

function memSearch(q) {
  if (!mems.length&&!memSum) return null;
  const words=q.toLowerCase().split(/\s+/).filter(w=>w.length>3);
  const hits=mems.filter(m=>words.some(w=>m.t.toLowerCase().includes(w)));
  return hits.length?hits.slice(-3).map(m=>m.t).join('; '):null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addUser(txt) {
  const g=mk('div','msg-group user');
  g.innerHTML=`<div class="bubble user"><div class="msg-txt">${esc(txt)}</div></div>`;
  document.getElementById('msgs').appendChild(g); sb();
}

function addAI(txt, eng, sources) {
  const g=mk('div','msg-group');
  const cls=eng==='groq'?'ec-groq':eng==='err'?'ec-err':'ec-gem';
  const lbl=eng==='groq'?'‚ö° Groq':eng==='err'?'‚ö†Ô∏è Error':'üåê Gemini';
  g.innerHTML=`<div class="mmeta"><div class="aav">J</div><div class="anm">JARVIS</div><div class="echip ${cls}">${lbl}</div></div><div class="bubble ai"><div class="msg-txt">${esc(txt)}</div></div>`;
  document.getElementById('msgs').appendChild(g);
  if (sources && sources.length > 0) {
    const bubble = g.querySelector('.bubble.ai');
    bubble.style.paddingTop = '34px';
    // Sources bar (top-right icons)
    const bar = mk('div','src-bar');
    const top3 = sources.slice(0,3);
    const extra = sources.length - 3;
    top3.forEach(src => {
      const ic = mk('div','src-ic');
      try {
        const domain = new URL(src.url).hostname;
        const img = document.createElement('img');
        img.src = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
        img.onerror = () => { ic.textContent = 'üåê'; };
        ic.appendChild(img);
      } catch(_) { ic.textContent = 'üåê'; }
      ic.title = src.title||src.url;
      bar.appendChild(ic);
    });
    if (sources.length > 0) {
      const plus = mk('div','src-plus');
      plus.textContent = extra > 0 ? `+${extra}` : '‚Üó';
      plus.onclick = () => panel.classList.toggle('open');
      bar.appendChild(plus);
    }
    bubble.appendChild(bar);
    // Collapsible sources panel
    const panel = mk('div','src-panel');
    panel.innerHTML = `<div class="src-panel-t">Sources (${sources.length})</div>` +
      sources.map(s => {
        let domain = s.url;
        try { domain = new URL(s.url).hostname; } catch(_){}
        return `<a class="src-lnk" href="${esc(s.url)}" target="_blank" rel="noopener noreferrer">` +
          `<div class="src-fav"><img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" onerror="this.parentNode.textContent='üåê'"/></div>` +
          `<div class="src-info"><div class="src-ttl">${esc(s.title||domain)}</div><div class="src-dom">${esc(domain)}</div></div>` +
          `<div class="src-arr">‚Üó</div></a>`;
      }).join('');
    bubble.appendChild(panel);
  }
  sb(); return g;
}

function addThink() {
  const g=mk('div','msg-group');
  g.innerHTML=`<div class="mmeta"><div class="aav">J</div><div class="anm">JARVIS</div></div><div class="tbbl"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div><div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);margin-top:5px;animation:fadeUp .3s ease">üîç Searching web...</div>`;
  document.getElementById('msgs').appendChild(g); sb(); return g;
}

function showEval(el,s) {
  const b=el.querySelector('.bubble'); if(!b) return;
  const ev=mk('div','eval-box');
  ev.innerHTML=`<div class="eval-t">Self Evaluation</div>
    <div class="eval-row"><div class="elbl">Confidence</div><div class="etrack"><div class="efill fa" data-w="${s.c}"></div></div><div class="enum">${s.c}%</div></div>
    <div class="eval-row"><div class="elbl">Accuracy</div><div class="etrack"><div class="efill fb" data-w="${s.a}"></div></div><div class="enum">${s.a}%</div></div>
    <div class="eval-row"><div class="elbl">Relevance</div><div class="etrack"><div class="efill fc" data-w="${s.r}"></div></div><div class="enum">${s.r}%</div></div>`;
  b.appendChild(ev);
  setTimeout(()=>ev.querySelectorAll('.efill').forEach(f=>f.style.width=f.dataset.w+'%'),80);
}

function showMemInd(el,n) {
  const b=el.querySelector('.bubble'); if(!b) return;
  const m=mk('div','mind'); m.textContent=`‚ö° +${n} memory insight${n>1?'s':''} stored`; b.appendChild(m);
}

function setStatus(a,l) { document.getElementById('statusLbl').textContent=l; document.getElementById('statusTag').style.borderColor=a?'var(--accent)':''; }
function setEng(e,done) {
  const p=document.getElementById('engPill');
  p.textContent=e==='groq'?'‚ö° Groq':'üåê Gemini';
  p.className='eng-pill '+(e==='groq'?'ep-groq':'ep-gem');
}
function updateDots() {
  const gd=document.getElementById('gemDot'); const qd=document.getElementById('groqDot');
  if(gd) gd.className='ai-dot '+(GEM_KEY?'dot-ok':'dot-off');
  if(qd) qd.className='ai-dot '+(GROQ_KEY?'dot-ok':'dot-off');
}
function sb() { const w=document.getElementById('msgsWrap'); if(w) requestAnimationFrame(()=>w.scrollTop=w.scrollHeight); }
function mk(tag,cls) { const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clamp(n) { return Math.min(100,Math.max(0,n)); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STORAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function saveSession() {
  if (!sessionHist.length) return;
  const existing = allSessions.findIndex(s => s.id === SESSION_ID);
  const entry = {id:SESSION_ID, date:new Date().toLocaleString(), msgs:[...sessionHist], preview:sessionHist[0]?.content?.slice(0,60)||'Session'};
  if (existing >= 0) allSessions[existing] = entry;
  else allSessions.unshift(entry);
  if (allSessions.length > 30) allSessions = allSessions.slice(0,30);
  try{await window.storage.set('j-sessions',JSON.stringify(allSessions));}catch(_){}
  try{await window.storage.set('j-mems',JSON.stringify(mems));}catch(_){}
  try{await window.storage.set('j-msum',memSum);}catch(_){}
  updateHistUI();
}

async function persist() {
  try{await window.storage.set('j-mems',JSON.stringify(mems));}catch(_){}
  try{await window.storage.set('j-msum',memSum);}catch(_){}
  await saveSession();
}

async function load() {
  try{const r=await window.storage.get('j-mems');mems=JSON.parse(r.value);}catch(_){mems=[];}
  try{const r=await window.storage.get('j-msum');memSum=r.value;}catch(_){}
  try{const r=await window.storage.get('j-sessions');allSessions=JSON.parse(r.value);}catch(_){allSessions=[];}
  try{const r=await window.storage.get('j-prof');prof=JSON.parse(r.value);}catch(_){}
  try{const r=await window.storage.get('j-theme');document.body.setAttribute('data-theme',r.value);document.querySelectorAll('.tsw').forEach(s=>s.classList.toggle('active',s.dataset.theme===r.value));}catch(_){}
  try{const r=await window.storage.get('j-save');autosave=r.value!=='false';}catch(_){}
  applyProf(); updateMemUI(); updateHistUI(); updateDots();
}

// Auto-save session when app is closed/backgrounded
window.addEventListener('beforeunload', ()=>{ saveSession(); });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) saveSession(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleSave() { autosave=!autosave; try{window.storage.set('j-save',String(autosave));}catch(_){} showToast(autosave?'üß† Auto-save ON':'‚è∏ Auto-save OFF'); }
function updateMemUI() { document.getElementById('memCount').textContent=`${mems.length} Memor${mems.length!==1?'ies':'y'}`; }

function openMem() {
  const b=document.getElementById('memBody');
  if (!mems.length&&!memSum) {
    b.innerHTML='<div style="text-align:center;font-family:JetBrains Mono,monospace;font-size:11px;color:var(--muted);padding:28px">No memories yet. Start chatting!</div>';
  } else {
    let h='';
    if (memSum) h+=`<div class="mentry" style="border-left-color:var(--accent2)"><div class="metag">SUMMARY</div><div class="metext">${esc(memSum)}</div></div>`;
    h+=[...mems].reverse().map(m=>`<div class="mentry"><div class="metag">LEARNED</div><div class="metext">${esc(m.t)}</div><div class="metime">${esc(m.time)}</div></div>`).join('');
    h+=`<button class="dbtn ddanger" onclick="clearMems()" style="margin-top:10px;width:100%">üóë Clear Memories</button>`;
    b.innerHTML=h;
  }
  document.getElementById('memModal').classList.add('open');
}
function closeMem(e) { if(!e||e.target===document.getElementById('memModal')) document.getElementById('memModal').classList.remove('open'); }
async function clearMems() { if(!confirm('Clear all memories?')) return; mems=[]; memSum=''; await persist(); updateMemUI(); closeMem(); showToast('Memories cleared'); }

function openDrawer()  { document.getElementById('drawer').classList.add('open'); document.getElementById('doverlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('doverlay').classList.remove('open'); }

function applyProf() {
  document.getElementById('pName').textContent=prof.name;
  document.getElementById('pEmoji').textContent=prof.emoji;
  document.getElementById('pBio').textContent=prof.bio;
  document.getElementById('iName').value=prof.name;
  document.getElementById('iEmoji').value=prof.emoji;
  document.getElementById('iBio').value=prof.bio;
  document.getElementById('logoSub').textContent=`Personal AI ¬∑ ${prof.name}`;
}
async function saveProfile() {
  prof.name=document.getElementById('iName').value.trim()||'Abhilas Rawat';
  prof.emoji=document.getElementById('iEmoji').value.trim()||'üë§';
  prof.bio=document.getElementById('iBio').value.trim()||'Creator & Owner';
  try{await window.storage.set('j-prof',JSON.stringify(prof));}catch(_){}
  applyProf(); showToast('Profile saved ‚úì');
}
function applyTheme(t,el) {
  document.body.setAttribute('data-theme',t);
  document.querySelectorAll('.tsw').forEach(s=>s.classList.remove('active'));
  if(el) el.classList.add('active');
  try{window.storage.set('j-theme',t);}catch(_){}
}
function updateHistUI() {
  const l=document.getElementById('histList');
  const past = allSessions.filter(s=>s.id!==SESSION_ID);
  if (!past.length) { l.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--muted);text-align:center;padding:10px 0">No past sessions yet</div>'; return; }
  l.innerHTML=past.slice(0,15).map(s=>`<div class="sess-item" onclick="openSessMod(${s.id})"><div class="sess-top"><div class="sess-date">${esc(s.date?.split(',')[0]||'')}</div><div class="sess-cnt">${Math.floor((s.msgs?.length||0)/2)} msgs</div></div><div class="sess-prev">${esc(s.preview||'Session')}</div></div>`).join('');
}
function openSessMod(id) {
  const sess=allSessions.find(s=>s.id===id);
  if(!sess) return;
  document.getElementById('sessTitle').textContent=sess.date||'Session';
  const body=document.getElementById('sessBody');
  if(!sess.msgs?.length){body.innerHTML='<div style="padding:20px;color:var(--muted);font-size:12px">Empty session</div>';}
  else{body.innerHTML=sess.msgs.map(m=>`<div class="smsg"><div class="swho ${m.role==='user'?'u':'a'}">${m.role==='user'?'üë§ YOU':'ü§ñ JARVIS'}</div><div class="stxt">${esc(m.content)}</div></div>`).join('');}
  document.getElementById('sessModal').classList.add('open');
  closeDrawer();
}
function closeSessMod(e) { if(!e||e.target===document.getElementById('sessModal')) document.getElementById('sessModal').classList.remove('open'); }
async function clearAll() {
  if(!confirm('Clear ALL data?')) return;
  mems=[]; memSum=''; sessionHist=[]; allSessions=[];
  try{await window.storage.set('j-sessions','[]');}catch(_){}
  try{await window.storage.set('j-mems','[]');}catch(_){}
  try{await window.storage.set('j-msum','');}catch(_){}
  updateMemUI(); updateHistUI(); closeDrawer(); showToast('Cleared'); location.reload();
}
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,130)+'px'; }
function useChip(t) { const i=document.getElementById('msgInput'); i.value=t; autoResize(i); send(); }

function showToast(msg) {
  const t=document.getElementById('toast'); if(!t) return;
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),3000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOOT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function boot() {
  if (GEM_KEY || GROQ_KEY) { showApp(); }
  else {
    document.getElementById('setupScreen').style.display='flex';
    document.getElementById('appWrapper').style.display='none';
  }
})();
</script>
</body>
</html>
