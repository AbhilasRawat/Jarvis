<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JARVIS">
<meta name="theme-color" content="#0a0a0f">
<title>JARVIS â€” Abhilas Rawat's Personal AI</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0a0a0f; --surface:#111118; --surface2:#16161f; --surface3:#1c1c28;
  --border:#1f1f2e; --border2:#2a2a3e;
  --accent:#4f8ef7; --accent2:#7c3aed; --accent3:#06d6a0;
  --accent-glow:rgba(79,142,247,0.15);
  --text:#e8eaf0; --text2:#a0a8c0; --muted:#4a5070;
  --danger:#ff4757;
  --gem:#34a853; --ds:#60a5fa;
}
[data-theme="midnight"] {
  --bg:#000008; --surface:#08080f; --surface2:#0d0d1a; --surface3:#111120;
  --border:#13132a; --border2:#1a1a35;
  --accent:#818cf8; --accent2:#a78bfa; --accent3:#34d399;
  --accent-glow:rgba(129,140,248,0.12);
  --text:#e0e7ff; --text2:#a5b4fc; --muted:#4c4f7a;
}
[data-theme="light"] {
  --bg:#f4f6fb; --surface:#ffffff; --surface2:#eef1f8; --surface3:#e4e9f5;
  --border:#d8dff0; --border2:#c4cde8;
  --accent:#3b72f0; --accent2:#6d28d9; --accent3:#059669;
  --accent-glow:rgba(59,114,240,0.1);
  --text:#111827; --text2:#374151; --muted:#9ca3af;
}
[data-theme="forest"] {
  --bg:#080f0a; --surface:#0e1a10; --surface2:#132016; --surface3:#1a2a1d;
  --border:#1e3222; --border2:#263d2a;
  --accent:#4ade80; --accent2:#22c55e; --accent3:#86efac;
  --accent-glow:rgba(74,222,128,0.12);
  --text:#ecfdf5; --text2:#a7f3d0; --muted:#4d7a58;
}
[data-theme="sunset"] {
  --bg:#0f080a; --surface:#1a0e10; --surface2:#221318; --surface3:#2a1920;
  --border:#3a1f26; --border2:#4a2830;
  --accent:#fb923c; --accent2:#f43f5e; --accent3:#fbbf24;
  --accent-glow:rgba(251,146,60,0.15);
  --text:#fff1ee; --text2:#fca5a5; --muted:#7c4a4a;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;transition:background .3s,color .3s;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#setupScreen {
  position:fixed;inset:0;z-index:9999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:24px;gap:0;overflow-y:auto;
}
.setup-logo {
  font-family:'Orbitron',monospace;font-size:32px;font-weight:900;letter-spacing:6px;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:8px;
}
.setup-orb {
  width:80px;height:80px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',monospace;font-size:24px;font-weight:900;color:#fff;
  animation:orb-pulse 3s ease-in-out infinite;
  box-shadow:0 0 50px var(--accent-glow);
  margin-bottom:20px;
}
.setup-tagline {
  font-size:13px;color:var(--text2);text-align:center;margin-bottom:24px;line-height:1.6;
  max-width:340px;
}
.setup-card {
  width:100%;max-width:420px;background:var(--surface);border:1px solid var(--border2);
  border-radius:18px;padding:20px;margin-bottom:14px;
}
.setup-card-header {
  display:flex;align-items:center;gap:10px;margin-bottom:14px;
}
.setup-card-icon {
  width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.gem-icon{background:rgba(52,168,83,.15);border:1px solid rgba(52,168,83,.3);}
.ds-icon{background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.3);}
.setup-card-title{font-size:15px;font-weight:600;color:var(--text);}
.setup-card-sub{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.setup-free-badge {
  display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;margin-bottom:12px;
}
.gem-badge{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.ds-badge{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.3);color:#60a5fa;}
.setup-steps {
  display:flex;flex-direction:column;gap:7px;margin-bottom:14px;
}
.setup-step{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--text2);line-height:1.5;}
.step-num{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;flex-shrink:0;margin-top:1px;}
.gem-num{background:linear-gradient(135deg,#34a853,#0f9d58);}
.ds-num{background:linear-gradient(135deg,#60a5fa,#3b82f6);}
.setup-step a{color:var(--accent);text-decoration:none;}
.setup-input {
  width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border2);
  background:var(--surface2);color:var(--text);font-size:13px;
  font-family:'JetBrains Mono',monospace;outline:none;transition:border-color .2s;
  margin-bottom:6px;
}
.setup-input:focus{border-color:var(--accent);}
.setup-error{font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;min-height:16px;margin-bottom:4px;}
.setup-optional{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;text-align:center;}
.setup-activate {
  width:100%;max-width:420px;padding:15px;border-radius:14px;border:none;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff;font-size:16px;font-weight:700;font-family:'Inter',sans-serif;
  cursor:pointer;letter-spacing:.5px;transition:opacity .2s,transform .1s;
  margin-top:4px;
}
.setup-activate:hover{opacity:.92;transform:translateY(-1px);}
.setup-activate:active{transform:translateY(0);}
.setup-skip{
  font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;
  text-align:center;cursor:pointer;margin-top:10px;text-decoration:underline;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#appWrapper{display:none;flex-direction:column;height:100%;width:100%;position:fixed;inset:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;height:56px;
  border-bottom:1px solid var(--border);background:var(--surface);
  flex-shrink:0;position:relative;z-index:20;
}
.logo-area{display:flex;align-items:center;gap:10px;}
.logo-ring{
  width:34px;height:34px;border-radius:50%;
  border:2px solid transparent;
  background:linear-gradient(var(--surface),var(--surface)) padding-box,
    conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent3),var(--accent)) border-box;
  display:flex;align-items:center;justify-content:center;
  animation:hue-spin 4s linear infinite;font-size:14px;
}
@keyframes hue-spin{to{filter:hue-rotate(360deg);}}
.logo-name{
  font-family:'Orbitron',monospace;font-size:17px;font-weight:900;letter-spacing:4px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.logo-sub{font-size:9px;color:var(--muted);letter-spacing:1px;font-family:'JetBrains Mono',monospace;margin-top:-2px;}

.header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:5px;}
.status-tag{
  display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;
  border:1px solid var(--border2);background:var(--surface2);color:var(--text2);
  transition:all .3s;
}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(.7);}}
.engine-pill{
  display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:9px;
  border:1px solid var(--border2);background:var(--surface2);color:var(--muted);transition:all .3s;
}
.engine-pill.gem{color:var(--gem);border-color:rgba(52,168,83,.35);background:rgba(52,168,83,.08);}
.engine-pill.ds{color:var(--ds);border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.08);}
.engine-pill.both{color:var(--accent3);border-color:rgba(6,214,160,.35);background:rgba(6,214,160,.08);}

.header-right{display:flex;align-items:center;gap:7px;}
.mem-badge{
  display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:10px;
  color:var(--accent3);border:1px solid rgba(6,214,160,.2);background:rgba(6,214,160,.06);
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.mem-badge:hover{background:rgba(6,214,160,.12);}
.mem-dot{width:5px;height:5px;border-radius:50%;background:var(--accent3);animation:pdot 2s ease-in-out infinite;}
.hamburger{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border2);
  background:var(--surface2);cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;
  transition:all .2s;flex-shrink:0;
}
.hamburger:hover{border-color:var(--accent);}
.hamburger span{display:block;width:16px;height:1.5px;background:var(--text2);border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP BODY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-body{display:flex;flex:1;overflow:hidden;position:relative;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drawer-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);
  z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;
}
.drawer-overlay.open{opacity:1;pointer-events:all;}
.drawer{
  position:fixed;right:-310px;top:0;bottom:0;width:290px;
  background:var(--surface);border-left:1px solid var(--border);
  z-index:50;display:flex;flex-direction:column;
  transition:right .35s cubic-bezier(.4,0,.2,1);overflow:hidden;
}
.drawer.open{right:0;}
.drawer-head{
  padding:14px 16px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.drawer-title{
  font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.drawer-close{
  width:26px;height:26px;border-radius:7px;border:1px solid var(--border2);
  background:none;color:var(--text2);cursor:pointer;font-size:15px;
  display:flex;align-items:center;justify-content:center;
}
.drawer-body{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.d-section{padding:13px 16px;border-bottom:1px solid var(--border);}
.d-section-title{
  font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;
  color:var(--muted);text-transform:uppercase;margin-bottom:11px;
}
.profile-card{
  display:flex;align-items:center;gap:11px;padding:11px;border-radius:12px;
  background:var(--surface2);border:1px solid var(--border2);margin-bottom:11px;
}
.profile-avatar{
  width:42px;height:42px;border-radius:11px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;
}
.profile-name{font-size:13px;font-weight:600;color:var(--text);}
.profile-bio{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.owner-badge{
  display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:8px;
  background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);
  color:var(--accent3);font-size:9px;font-family:'JetBrains Mono',monospace;
  letter-spacing:1px;margin-top:4px;
}
.s-item{margin-bottom:10px;}
.s-label{font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.s-input{
  width:100%;padding:8px 11px;border-radius:8px;border:1px solid var(--border2);
  background:var(--surface2);color:var(--text);font-size:13px;
  font-family:'Inter',sans-serif;outline:none;transition:border-color .2s;
}
.s-input:focus{border-color:var(--accent);}
.theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;}
.theme-sw{
  height:30px;border-radius:7px;cursor:pointer;border:2px solid transparent;
  transition:all .2s;display:flex;align-items:center;justify-content:center;
  font-size:8px;font-weight:700;color:white;
}
.theme-sw.active{border-color:white;box-shadow:0 0 8px rgba(255,255,255,.3);}
.ai-status-panel{
  padding:10px 12px;border-radius:10px;background:var(--surface2);
  border:1px solid var(--border2);margin-bottom:8px;
}
.ai-status-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.ai-status-row:last-child{margin-bottom:0;}
.ai-name-label{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.ai-status-dot{width:7px;height:7px;border-radius:50%;}
.ai-ok{background:#34a853;}
.ai-off{background:var(--muted);}
.h-item{
  padding:8px 10px;border-radius:9px;border:1px solid var(--border);
  background:var(--surface2);margin-bottom:4px;
  display:flex;align-items:flex-start;gap:8px;
}
.h-icon{font-size:12px;flex-shrink:0;margin-top:1px;}
.h-text{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.h-time{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);flex-shrink:0;}
.d-btn{
  width:100%;padding:9px;border-radius:9px;border:1px solid var(--accent);
  background:rgba(79,142,247,.1);color:var(--accent);
  font-family:'Inter',sans-serif;font-size:12px;font-weight:600;
  cursor:pointer;transition:all .2s;margin-top:5px;display:block;
}
.d-btn:hover{background:rgba(79,142,247,.2);}
.d-danger{border-color:var(--danger)!important;background:rgba(255,71,87,.08)!important;color:var(--danger)!important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.autosave-strip{position:absolute;top:11px;left:12px;z-index:10;}
.toggle-wrap{
  display:flex;align-items:center;gap:7px;padding:5px 11px;border-radius:20px;
  background:var(--surface2);border:1px solid var(--border2);cursor:pointer;user-select:none;
}
.toggle-sw{width:26px;height:14px;border-radius:7px;background:var(--border2);position:relative;transition:background .3s;flex-shrink:0;}
.toggle-sw.on{background:var(--accent3);}
.toggle-knob{position:absolute;top:2px;left:2px;width:10px;height:10px;border-radius:50%;background:white;transition:left .25s;}
.toggle-sw.on .toggle-knob{left:14px;}
.toggle-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text2);}

.messages-wrap{
  flex:1;overflow-y:auto;padding:56px 0 14px;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
  display:flex;flex-direction:column;
}
.messages-inner{
  width:100%;max-width:740px;margin:0 auto;padding:0 14px;
  display:flex;flex-direction:column;gap:0;flex:1;
}

/* Welcome */
.welcome{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:54vh;text-align:center;gap:14px;padding:24px 14px;
}
.w-orb{
  width:78px;height:78px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  animation:orb-pulse 3s ease-in-out infinite;
  box-shadow:0 0 50px var(--accent-glow);
  display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:white;
}
@keyframes orb-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
.w-title{
  font-family:'Orbitron',monospace;font-size:24px;font-weight:900;letter-spacing:6px;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.w-sub{font-size:13px;color:var(--text2);max-width:420px;line-height:1.7;}
.w-engines{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.w-eng-badge{
  display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;
}
.w-gem{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.w-ds{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.3);color:#60a5fa;}
.owner-line{
  font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);
  border:1px solid var(--border2);padding:4px 13px;border-radius:20px;background:var(--surface2);
}
.owner-line span{color:var(--accent3);font-weight:600;}
.chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:520px;}
.chip{
  padding:7px 13px;border-radius:20px;border:1px solid var(--border2);
  background:var(--surface2);font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s;
}
.chip:hover{border-color:var(--accent);color:var(--text);}

/* Messages */
.msg-group{padding:12px 0;animation:fadeUp .2s ease-out;}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.msg-group.user{display:flex;flex-direction:column;align-items:flex-end;}
.bubble{max-width:78%;padding:11px 15px;border-radius:17px;font-size:14px;line-height:1.75;}
.bubble.ai{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px;max-width:100%;}
.bubble.user{
  background:linear-gradient(135deg,rgba(79,142,247,.22),rgba(124,58,237,.18));
  border:1px solid rgba(79,142,247,.22);border-top-right-radius:4px;
}
.msg-meta{display:flex;align-items:center;gap:7px;margin-bottom:7px;}
.ai-av{
  width:22px;height:22px;border-radius:6px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:900;font-family:'Orbitron',monospace;color:white;flex-shrink:0;
}
.ai-nm{
  font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:2px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.eng-chip{
  display:flex;align-items:center;gap:3px;padding:2px 7px;border-radius:9px;
  font-family:'JetBrains Mono',monospace;font-size:8px;
}
.e-gem{background:rgba(52,168,83,.1);border:1px solid rgba(52,168,83,.3);color:#34a853;}
.e-ds{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.3);color:#60a5fa;}
.e-both{background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--accent3);}
.msg-txt{white-space:pre-wrap;word-break:break-word;}

/* Thinking */
.thinking-bbl{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:17px;border-top-left-radius:4px;
  padding:13px 17px;display:inline-flex;align-items:center;gap:5px;
}
.t-dot{width:7px;height:7px;border-radius:50%;animation:tdot 1.4s ease-in-out infinite;}
.t-dot:nth-child(1){background:var(--accent);}
.t-dot:nth-child(2){background:var(--accent2);animation-delay:.2s;}
.t-dot:nth-child(3){background:var(--accent3);animation-delay:.4s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-8px);}}

/* Eval bars */
.eval-box{margin-top:11px;padding:9px 11px;border-radius:9px;background:rgba(0,0,0,.2);border:1px solid var(--border);}
.eval-title{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:7px;}
.eval-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.eval-row:last-child{margin-bottom:0;}
.eval-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);width:70px;flex-shrink:0;}
.eval-track{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
.eval-fill{height:100%;border-radius:2px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1);}
.fa{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.fb{background:linear-gradient(90deg,var(--accent3),#34d399);}
.fc{background:linear-gradient(90deg,#34a853,#60a5fa);}
.eval-n{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text2);width:26px;text-align:right;}
.mem-ind{display:flex;align-items:center;gap:4px;margin-top:7px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--accent3);}

/* INPUT */
.input-zone{padding:11px 14px 16px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
.input-container{max-width:740px;margin:0 auto;}
.input-box{
  display:flex;align-items:flex-end;gap:9px;
  background:var(--surface);border:1px solid var(--border2);border-radius:17px;
  padding:9px 11px;transition:border-color .25s,box-shadow .25s;
}
.input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
#msgInput{
  flex:1;background:none;border:none;outline:none;color:var(--text);
  font-family:'Inter',sans-serif;font-size:15px;line-height:1.6;
  resize:none;max-height:130px;min-height:24px;
}
#msgInput::placeholder{color:var(--muted);}
.send-btn{
  width:36px;height:36px;border-radius:9px;border:none;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;transition:all .2s;
}
.send-btn:hover{transform:scale(1.06);}
.send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.input-hint{text-align:center;font-size:9px;color:var(--muted);margin-top:7px;font-family:'JetBrains Mono',monospace;}

/* TOAST */
.toast{
  position:fixed;bottom:85px;left:50%;transform:translateX(-50%) translateY(18px);
  padding:8px 15px;border-radius:11px;
  background:rgba(6,214,160,.14);border:1px solid rgba(6,214,160,.32);
  font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);
  z-index:900;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Memory Modal */
.mem-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);
  z-index:200;display:none;align-items:center;justify-content:center;padding:14px;
}
.mem-overlay.open{display:flex;}
.mem-modal{
  width:100%;max-width:500px;max-height:80vh;background:var(--surface);
  border:1px solid var(--border2);border-radius:18px;
  display:flex;flex-direction:column;animation:modalIn .25s ease-out;overflow:hidden;
}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(7px);}to{opacity:1;transform:none;}}
.mem-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.mem-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--accent3);}
.mem-body{overflow-y:auto;padding:14px 18px;flex:1;}
.mem-entry{padding:10px 12px;border-radius:9px;border:1px solid var(--border);background:var(--surface2);margin-bottom:6px;border-left:3px solid var(--accent3);}
.mem-tag{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--accent3);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;}
.mem-text{font-size:13px;color:var(--text);line-height:1.5;}
.mem-time{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);margin-top:3px;}

/* Scrollbar */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setupScreen">
  <div class="setup-logo">JARVIS</div>
  <div class="setup-orb">J</div>
  <div class="setup-tagline">
    Your personal AI â€” powered by <strong>Google Gemini</strong> &amp; <strong>DeepSeek</strong>.<br>
    Both are completely free. Enter one or both keys below.
  </div>

  <!-- Gemini Card -->
  <div class="setup-card">
    <div class="setup-card-header">
      <div class="setup-card-icon gem-icon">ğŸŒ</div>
      <div>
        <div class="setup-card-title">Google Gemini</div>
        <div class="setup-card-sub">General Â· Writing Â· Reasoning Â· Creative</div>
      </div>
    </div>
    <div class="setup-free-badge gem-badge">âœ… FREE â€” No credit card needed</div>
    <div class="setup-steps">
      <div class="setup-step">
        <div class="step-num gem-num">1</div>
        <div>Go to <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></div>
      </div>
      <div class="setup-step">
        <div class="step-num gem-num">2</div>
        <div>Sign in with Google â†’ tap <strong>"Create API Key"</strong></div>
      </div>
      <div class="setup-step">
        <div class="step-num gem-num">3</div>
        <div>Copy and paste it below</div>
      </div>
    </div>
    <input id="geminiKey" class="setup-input" type="password" placeholder="AIzaSy..." autocomplete="off"/>
    <div id="geminiErr" class="setup-error"></div>
  </div>

  <!-- DeepSeek Card -->
  <div class="setup-card">
    <div class="setup-card-header">
      <div class="setup-card-icon ds-icon">âš¡</div>
      <div>
        <div class="setup-card-title">DeepSeek</div>
        <div class="setup-card-sub">Coding Â· Math Â· Debugging Â· Technical</div>
      </div>
    </div>
    <div class="setup-free-badge ds-badge">âœ… FREE tier â€” $0 to start</div>
    <div class="setup-steps">
      <div class="setup-step">
        <div class="step-num ds-num">1</div>
        <div>Go to <a href="https://platform.deepseek.com/api_keys" target="_blank">platform.deepseek.com/api_keys</a></div>
      </div>
      <div class="setup-step">
        <div class="step-num ds-num">2</div>
        <div>Sign up â†’ tap <strong>"Create new API key"</strong></div>
      </div>
      <div class="setup-step">
        <div class="step-num ds-num">3</div>
        <div>Copy and paste it below</div>
      </div>
    </div>
    <input id="deepseekKey" class="setup-input" type="password" placeholder="sk-..." autocomplete="off"/>
    <div id="deepseekErr" class="setup-error"></div>
  </div>

  <div class="setup-optional">âš¡ Enter at least one key to activate JARVIS</div>
  <button class="setup-activate" onclick="activateJarvis()">ACTIVATE JARVIS âš¡</button>
  <div class="setup-skip" onclick="trySkip()">I already set this up â€” go to app</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appWrapper">
  <div class="toast" id="toast"></div>

  <!-- HEADER -->
  <div class="header">
    <div class="logo-area">
      <div class="logo-ring">â¬¡</div>
      <div>
        <div class="logo-name">JARVIS</div>
        <div class="logo-sub" id="logoSub">Personal AI Â· Abhilas Rawat</div>
      </div>
    </div>
    <div class="header-center">
      <div class="status-tag" id="statusTag">
        <div class="status-dot"></div>
        <span id="statusLabel">READY</span>
      </div>
      <div class="engine-pill" id="enginePill">â€” â€”</div>
    </div>
    <div class="header-right">
      <div class="mem-badge" onclick="openMemModal()">
        <div class="mem-dot"></div>
        <span id="memCount">0 Memories</span>
      </div>
      <div class="hamburger" onclick="openDrawer()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- BODY -->
  <div class="app-body">
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- DRAWER -->
    <div class="drawer" id="drawer">
      <div class="drawer-head">
        <div class="drawer-title">SETTINGS</div>
        <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
      </div>
      <div class="drawer-body">

        <!-- Profile -->
        <div class="d-section">
          <div class="d-section-title">Profile</div>
          <div class="profile-card">
            <div class="profile-avatar" id="profileEmoji">ğŸ‘¤</div>
            <div>
              <div class="profile-name" id="profileName">Abhilas Rawat</div>
              <div class="profile-bio" id="profileHandle">Creator & Owner</div>
              <div class="owner-badge">ğŸ‘‘ SOLE OWNER</div>
            </div>
          </div>
          <div class="s-item"><div class="s-label">Name</div><input class="s-input" id="inputName" value="Abhilas Rawat"/></div>
          <div class="s-item"><div class="s-label">Emoji</div><input class="s-input" id="inputEmoji" value="ğŸ‘¤" maxlength="4"/></div>
          <div class="s-item"><div class="s-label">Bio</div><input class="s-input" id="inputBio" value="Creator & Owner"/></div>
          <button class="d-btn" onclick="saveProfile()">Save Profile</button>
        </div>

        <!-- AI Status -->
        <div class="d-section">
          <div class="d-section-title">AI Engines</div>
          <div class="ai-status-panel">
            <div class="ai-status-row">
              <span class="ai-name-label">ğŸŒ Gemini (General)</span>
              <div class="ai-status-dot" id="gemStatusDot"></div>
            </div>
            <div class="ai-status-row">
              <span class="ai-name-label">âš¡ DeepSeek (Technical)</span>
              <div class="ai-status-dot" id="dsStatusDot"></div>
            </div>
          </div>
          <button class="d-btn" onclick="goToSetup()">ğŸ”‘ Change API Keys</button>
        </div>

        <!-- Theme -->
        <div class="d-section">
          <div class="d-section-title">Color Theme</div>
          <div class="theme-grid">
            <div class="theme-sw active" style="background:linear-gradient(135deg,#0a0a0f,#4f8ef7)" data-theme="dark" onclick="applyTheme('dark',this)">Dark</div>
            <div class="theme-sw" style="background:linear-gradient(135deg,#000008,#818cf8)" data-theme="midnight" onclick="applyTheme('midnight',this)">Night</div>
            <div class="theme-sw" style="background:linear-gradient(135deg,#f4f6fb,#3b72f0);color:#1a1a2e" data-theme="light" onclick="applyTheme('light',this)">Light</div>
            <div class="theme-sw" style="background:linear-gradient(135deg,#080f0a,#4ade80)" data-theme="forest" onclick="applyTheme('forest',this)">Forest</div>
            <div class="theme-sw" style="background:linear-gradient(135deg,#0f080a,#fb923c)" data-theme="sunset" onclick="applyTheme('sunset',this)">Sunset</div>
          </div>
        </div>

        <!-- History -->
        <div class="d-section">
          <div class="d-section-title">Recent Chats</div>
          <div id="historyList">
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:12px 0">No chats yet</div>
          </div>
        </div>

        <!-- Danger -->
        <div class="d-section">
          <div class="d-section-title">Data</div>
          <button class="d-btn d-danger" onclick="clearAll()">ğŸ—‘ Clear All Data</button>
        </div>

      </div>
    </div>

    <!-- CHAT -->
    <div class="chat-main">
      <div class="autosave-strip">
        <div class="toggle-wrap" onclick="toggleAutosave()">
          <div class="toggle-sw on" id="autosaveSw"><div class="toggle-knob"></div></div>
          <div class="toggle-lbl">AUTO-SAVE MEMORY</div>
        </div>
      </div>

      <div class="messages-wrap" id="messagesWrap">
        <div class="messages-inner" id="messages">
          <div class="welcome" id="welcomeScreen">
            <div class="w-orb">J</div>
            <div class="w-title">JARVIS</div>
            <div class="w-sub">Your personal AI â€” engineered exclusively for <strong>Abhilas Rawat</strong>.<br>Automatically picks the best AI for every question.</div>
            <div class="w-engines">
              <div class="w-eng-badge w-gem">ğŸŒ Gemini â€” General & Creative</div>
              <div class="w-eng-badge w-ds">âš¡ DeepSeek â€” Code & Math</div>
            </div>
            <div class="owner-line">Created by <span>Abhilas Rawat</span> Â· Sole Owner Â· Private & Personal</div>
            <div class="chips">
              <div class="chip" onclick="useChip('Who are you and what can you do?')">ğŸ¤– Who are you?</div>
              <div class="chip" onclick="useChip('Write a Python function to reverse a linked list')">ğŸ› ï¸ Code: Reverse linked list</div>
              <div class="chip" onclick="useChip('Write me a short story about an astronaut who finds a hidden planet')">âœï¸ Write a story</div>
              <div class="chip" onclick="useChip('Solve: find the integral of xÂ² sin(x) dx')">âˆ« Solve integral</div>
              <div class="chip" onclick="useChip('What do you remember about me?')">ğŸ§  Your memories</div>
              <div class="chip" onclick="useChip('What are the top 5 AI trends in 2025?')">ğŸ’¡ AI trends 2025</div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-zone">
        <div class="input-container">
          <div class="input-box">
            <textarea id="msgInput" placeholder="Message Jarvis..." rows="1"
              onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
          </div>
          <div class="input-hint">Enter to send Â· Shift+Enter for newline Â· Powered by Gemini &amp; DeepSeek â€” Free</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Memory Modal -->
<div class="mem-overlay" id="memModal" onclick="closeMemModal(event)">
  <div class="mem-modal">
    <div class="mem-head">
      <div class="mem-title">ğŸ§  MEMORY VAULT</div>
      <button class="drawer-close" onclick="closeMemModal()">Ã—</button>
    </div>
    <div class="mem-body" id="memModalBody"></div>
  </div>
</div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORAGE POLYFILL â€” works in any real browser
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (!window.storage) {
  window.storage = {
    get: async (k) => {
      const v = localStorage.getItem(k);
      if (v === null) throw new Error('nf');
      return { key:k, value:v };
    },
    set: async (k, v) => { localStorage.setItem(k, String(v)); return {key:k,value:v}; },
    delete: async (k) => { localStorage.removeItem(k); return {key:k,deleted:true}; }
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEYS & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let GEMINI_KEY   = localStorage.getItem('jarvis-gemini-key')   || '';
let DEEPSEEK_KEY = localStorage.getItem('jarvis-deepseek-key') || '';

const GEMINI_URL   = () => `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
const DEEPSEEK_URL = 'https://api.deepseek.com/v1/chat/completions';
const DEEPSEEK_MODEL = 'deepseek-chat';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function activateJarvis() {
  const gk = (document.getElementById('geminiKey').value || '').trim();
  const dk = (document.getElementById('deepseekKey').value || '').trim();

  let hasError = false;
  document.getElementById('geminiErr').textContent = '';
  document.getElementById('deepseekErr').textContent = '';

  if (gk && !gk.startsWith('AIza')) {
    document.getElementById('geminiErr').textContent = 'âš ï¸ Gemini keys start with "AIza"';
    hasError = true;
  }
  if (dk && !dk.startsWith('sk-')) {
    document.getElementById('deepseekErr').textContent = 'âš ï¸ DeepSeek keys start with "sk-"';
    hasError = true;
  }
  if (!gk && !dk) {
    document.getElementById('geminiErr').textContent = 'âš ï¸ Enter at least one API key';
    hasError = true;
  }
  if (hasError) return;

  if (gk) { GEMINI_KEY = gk; localStorage.setItem('jarvis-gemini-key', gk); }
  if (dk) { DEEPSEEK_KEY = dk; localStorage.setItem('jarvis-deepseek-key', dk); }

  showApp();
}

function trySkip() {
  if (!GEMINI_KEY && !DEEPSEEK_KEY) {
    document.getElementById('geminiErr').textContent = 'âš ï¸ No saved keys found. Please enter at least one key.';
    return;
  }
  showApp();
}

function showSetup() {
  document.getElementById('setupScreen').style.display = 'flex';
  document.getElementById('appWrapper').style.display = 'none';
  // Pre-fill if keys exist
  if (GEMINI_KEY) document.getElementById('geminiKey').value = GEMINI_KEY;
  if (DEEPSEEK_KEY) document.getElementById('deepseekKey').value = DEEPSEEK_KEY;
}

function showApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('appWrapper').style.display = 'flex';
  updateEngineStatusUI();
  load();
}

function goToSetup() {
  closeDrawer();
  showSetup();
}

// Listen for Enter on key inputs
['geminiKey','deepseekKey'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => {
    document.getElementById('geminiErr').textContent = '';
    document.getElementById('deepseekErr').textContent = '';
    if (e.key === 'Enter') activateJarvis();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART ROUTING â€” decides which AI to use
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Returns: 'gemini' | 'deepseek' | 'gemini_fallback_ds' | 'ds_fallback_gemini'
function routeQuery(q) {
  const t = q.toLowerCase().trim();

  // Keywords that mean DeepSeek (technical)
  const technical = [
    'code','debug','function','bug','error','exception','syntax','program','script',
    'algorithm','compile','runtime','class','method','variable','loop','array','object',
    'api','import','module','library','regex','sql','query','database',
    'html','css','javascript','python','java','rust','go','typescript','react','node',
    'flask','django','dockerfile','bash','shell','terminal','git','github',
    'solve','calculate','integral','derivative','equation','math','matrix','vector',
    'probability','formula','proof','theorem','compute','algebra','geometry',
    'trigonometry','calculus','physics','chemistry','differentiate','integrate',
    'data structure','recursion','binary','sort','search','complexity','big o',
    'pointer','memory leak','segfault','null pointer','stack overflow','heap',
  ];

  // If DeepSeek is available and it's a technical question â†’ DeepSeek
  if (DEEPSEEK_KEY && technical.some(k => t.includes(k))) {
    return 'deepseek';
  }

  // Everything else â†’ Gemini (general, writing, creative, casual)
  if (GEMINI_KEY) return 'gemini';

  // Fallbacks: only one key available
  if (DEEPSEEK_KEY) return 'deepseek';

  throw new Error('No API key configured. Tap â˜° â†’ Change API Keys.');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API CALLERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(userMsg, sysPrompt, history) {
  if (!GEMINI_KEY) throw new Error('No Gemini key');

  // Build contents: history + new message
  const contents = [];
  if (history && history.length) {
    for (const h of history) {
      contents.push({
        role: h.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: h.content }]
      });
    }
  }
  contents.push({ role: 'user', parts: [{ text: userMsg }] });

  const body = {
    system_instruction: { parts: [{ text: sysPrompt }] },
    contents,
    generationConfig: { maxOutputTokens: 1500, temperature: 0.9 }
  };

  const res = await fetch(GEMINI_URL(), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    let msg = `Gemini error ${res.status}`;
    try { const j = await res.json(); msg = j.error?.message || msg; } catch(_) {}
    throw new Error(msg);
  }

  const data = await res.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

async function callDeepSeek(userMsg, sysPrompt, history) {
  if (!DEEPSEEK_KEY) throw new Error('No DeepSeek key');

  const messages = [{ role: 'system', content: sysPrompt }];
  if (history && history.length) {
    for (const h of history) messages.push({ role: h.role, content: h.content });
  }
  messages.push({ role: 'user', content: userMsg });

  const res = await fetch(DEEPSEEK_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${DEEPSEEK_KEY}`,
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      model: DEEPSEEK_MODEL,
      messages,
      max_tokens: 1500,
      temperature: 0.7
    })
  });

  if (!res.ok) {
    let msg = `DeepSeek error ${res.status}`;
    try { const j = await res.json(); msg = j.error?.message || msg; } catch(_) {}
    throw new Error(msg);
  }

  const data = await res.json();
  return data.choices?.[0]?.message?.content || '';
}

// Smart call: tries primary engine, falls back to other if it fails
async function smartCall(userMsg, sysPrompt, history, engine) {
  // Try primary engine first
  try {
    if (engine === 'deepseek' && DEEPSEEK_KEY) {
      return { text: await callDeepSeek(userMsg, sysPrompt, history), usedEngine: 'deepseek' };
    }
    if (engine === 'gemini' && GEMINI_KEY) {
      return { text: await callGemini(userMsg, sysPrompt, history), usedEngine: 'gemini' };
    }
  } catch (primaryErr) {
    // Primary failed â€” silently try the other engine
    try {
      if (engine === 'gemini' && DEEPSEEK_KEY) {
        return { text: await callDeepSeek(userMsg, sysPrompt, history), usedEngine: 'deepseek', fallback: true };
      }
      if (engine === 'deepseek' && GEMINI_KEY) {
        return { text: await callGemini(userMsg, sysPrompt, history), usedEngine: 'gemini', fallback: true };
      }
    } catch(_) {}
    throw primaryErr;
  }
  // If primary engine key missing, try the other one
  try {
    if (DEEPSEEK_KEY) return { text: await callDeepSeek(userMsg, sysPrompt, history), usedEngine: 'deepseek', fallback: true };
    if (GEMINI_KEY)   return { text: await callGemini(userMsg, sysPrompt, history),   usedEngine: 'gemini',   fallback: true };
  } catch(_) {}
  throw new Error('Both AI engines failed. Check your API keys in â˜° â†’ Change API Keys.');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYSTEM PROMPT BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSystem(engine) {
  const memCtx = buildMemCtx();
  const engineNote = engine === 'deepseek'
    ? 'Mode: Technical Expert â€” be precise, structured, give working code/solutions, show your working.'
    : 'Mode: General Assistant â€” be warm, clear, intelligent, creative. Match the tone of the question.';

  return `You are JARVIS, the exclusive personal AI of Abhilas Rawat. He is your creator, owner, and the only person you serve. You know him well and treat him as your boss.
Be direct, personal, and genuinely helpful â€” like a brilliant personal assistant.
${engineNote}
Always remember: Abhilas is your sole owner.${memCtx ? '\n\nWhat you know about Abhilas:\n' + memCtx : ''}`;
}

function buildMemCtx() {
  const parts = [];
  if (memSummary) parts.push('Summary: ' + memSummary);
  if (memories.length) parts.push(memories.slice(-12).map(m => 'â€¢ ' + m.text).join('\n'));
  return parts.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let memories            = [];
let conversationHistory = [];
let chatSessions        = [];
let autosave            = true;
let isBusy              = false;
let msgCounter          = 0;
let memSummary          = '';
let profile             = { name:'Abhilas Rawat', emoji:'ğŸ‘¤', bio:'Creator & Owner' };
const COMPRESS_AT       = 35;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND MESSAGE â€” main flow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text  = input.value.trim();
  if (!text || isBusy) return;

  isBusy = true;
  document.getElementById('sendBtn').disabled = true;
  input.value = '';
  input.style.height = 'auto';

  const ws = document.getElementById('welcomeScreen');
  if (ws) ws.style.display = 'none';

  setStatus(true, 'THINKING...');
  addUserMsg(text);
  const thinkEl = addThinking();

  try {
    const engine = routeQuery(text);
    updateEnginePill(engine, false);

    // Attach memory context if relevant
    const memHit = quickMemSearch(text);
    const userContent = memHit ? `[Context from memory: ${memHit}]\n\n${text}` : text;
    const apiHistory = conversationHistory.slice(-12);

    const { text: reply, usedEngine, fallback } = await smartCall(
      userContent,
      buildSystem(usedEngineForSystem(engine)),
      apiHistory,
      engine
    );

    thinkEl.remove();
    const msgEl = addAIMsg(reply, usedEngine, fallback);
    updateEnginePill(usedEngine, true);
    setStatus(false, 'READY');

    if (fallback) showToast(`âš ï¸ Switched to ${usedEngine === 'gemini' ? 'Gemini' : 'DeepSeek'} as fallback`);

    conversationHistory.push({ role: 'user',      content: text  });
    conversationHistory.push({ role: 'assistant', content: reply });
    chatSessions.unshift({ preview: text.slice(0, 60), time: new Date().toLocaleString() });
    await persist();
    updateHistoryUI();

    // Background tasks (non-blocking)
    setTimeout(() => bgEval(text, reply, msgEl, usedEngine), 200);
    setTimeout(() => bgLearn(text, reply, msgEl), 500);

  } catch (err) {
    thinkEl.remove();
    const isCors = err.message === 'Failed to fetch' || err.message.includes('NetworkError') || err.message.includes('CORS');
    const errMsg = isCors
      ? 'âš ï¸ Connection blocked!\n\nYou are opening this file directly from your phone. That blocks all API calls.\n\nâœ… SOLUTION: Upload index.html to your GitHub repo and open:\naabhilasrawat.github.io/Jarvis\n\nIt will work perfectly from there!'
      : `âš ï¸ ${err.message}\n\nMake sure:\nâ€¢ API key is correct (tap â˜° â†’ Change API Keys)\nâ€¢ You have internet connection\nâ€¢ File is hosted on GitHub Pages, not opened locally`;
    addAIMsg(errMsg, 'error', false);
    setStatus(false, 'ERROR');
  }

  isBusy = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

function usedEngineForSystem(engine) {
  // For system prompt purposes
  return engine === 'deepseek' ? 'deepseek' : 'gemini';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND: EVAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function bgEval(q, a, msgEl, engine) {
  const prompt = `Rate this AI response quality. Q: "${q.slice(0,80)}" A: "${a.slice(0,150)}"\nReturn only valid JSON, no markdown: {"confidence":85,"accuracy":80,"relevance":90}`;
  try {
    let raw = '';
    if (engine === 'deepseek' && DEEPSEEK_KEY) {
      raw = await callDeepSeek(prompt, 'Return only valid JSON.', []);
    } else if (GEMINI_KEY) {
      raw = await callGemini(prompt, 'Return only valid JSON, nothing else.', []);
    } else return;
    const p = JSON.parse(raw.replace(/```json|```/g,'').trim());
    appendEval(msgEl, { confidence:clamp(p.confidence??75), accuracy:clamp(p.accuracy??75), relevance:clamp(p.relevance??75) });
  } catch(_) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND: LEARN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function bgLearn(userMsg, aiReply, msgEl) {
  if (!autosave) return;
  msgCounter++;
  if (msgCounter % 2 !== 0 && memories.length > 5) return;

  const prompt = `Extract up to 2 important facts or preferences about the USER (not the AI) from this exchange. Return only a JSON array of short strings. Return [] if nothing new to learn.\nUser: "${userMsg.slice(0,120)}"\nAI: "${aiReply.slice(0,180)}"`;
  try {
    let raw = '';
    if (GEMINI_KEY) {
      raw = await callGemini(prompt, 'Return only a valid JSON array of strings, no markdown.', []);
    } else if (DEEPSEEK_KEY) {
      raw = await callDeepSeek(prompt, 'Return only a valid JSON array of strings, no markdown.', []);
    } else return;

    const arr   = JSON.parse(raw.replace(/```json|```/g,'').trim());
    const items = Array.isArray(arr) ? arr.filter(s => typeof s === 'string' && s.length > 4) : [];
    if (items.length) {
      const now = new Date().toLocaleString();
      items.forEach(l => memories.push({ text:l, time:now }));
      appendMemIndicator(msgEl, items.length);
      updateMemUI();
      showToast(`âš¡ +${items.length} memory saved`);
      if (memories.length > COMPRESS_AT) compressMemory();
      await persist();
    }
  } catch(_) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEMORY COMPRESSION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function compressMemory() {
  if (memories.length < COMPRESS_AT) return;
  const toC    = memories.slice(0, 20);
  const recent = memories.slice(20);
  const prompt = `Compress these user facts into one short paragraph (max 200 characters):\n${toC.map(m=>m.text).join('\n')}`;
  try {
    let summary = '';
    if (GEMINI_KEY) summary = await callGemini(prompt, 'Return only the compressed paragraph, nothing else.', []);
    else if (DEEPSEEK_KEY) summary = await callDeepSeek(prompt, 'Return only the compressed paragraph, nothing else.', []);
    if (summary) {
      memSummary = (memSummary ? memSummary + ' ' : '') + summary.trim();
      memories   = recent;
      await persist();
    }
  } catch(_) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK LOCAL MEMORY SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function quickMemSearch(q) {
  if (!memories.length && !memSummary) return null;
  const words = q.toLowerCase().split(/\s+/).filter(w => w.length > 3);
  const hits  = memories.filter(m => words.some(w => m.text.toLowerCase().includes(w)));
  return hits.length ? hits.slice(-3).map(m => m.text).join('; ') : null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group user';
  g.innerHTML = `<div class="bubble user"><div class="msg-txt">${esc(text)}</div></div>`;
  msgs.appendChild(g);
  scrollBottom();
}

function addAIMsg(text, engine, fallback) {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group';

  let chipClass = 'e-gem', chipLabel = 'ğŸŒ Gemini';
  if (engine === 'deepseek') { chipClass = 'e-ds'; chipLabel = 'âš¡ DeepSeek'; }
  if (engine === 'error')    { chipClass = 'e-gem'; chipLabel = 'âš ï¸ Error'; }
  if (fallback) chipLabel += ' (fallback)';

  g.innerHTML = `
    <div class="msg-meta">
      <div class="ai-av">J</div>
      <div class="ai-nm">JARVIS</div>
      <div class="eng-chip ${chipClass}">${chipLabel}</div>
    </div>
    <div class="bubble ai"><div class="msg-txt">${esc(text)}</div></div>`;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function addThinking() {
  const msgs = document.getElementById('messages');
  const g = document.createElement('div');
  g.className = 'msg-group';
  g.innerHTML = `
    <div class="msg-meta"><div class="ai-av">J</div><div class="ai-nm">JARVIS</div></div>
    <div class="thinking-bbl">
      <div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>
    </div>`;
  msgs.appendChild(g);
  scrollBottom();
  return g;
}

function appendEval(el, s) {
  const bubble = el.querySelector('.bubble');
  if (!bubble) return;
  const ev = document.createElement('div');
  ev.className = 'eval-box';
  ev.innerHTML = `
    <div class="eval-title">Self Evaluation</div>
    <div class="eval-row"><div class="eval-lbl">Confidence</div><div class="eval-track"><div class="eval-fill fa" data-w="${s.confidence}"></div></div><div class="eval-n">${s.confidence}%</div></div>
    <div class="eval-row"><div class="eval-lbl">Accuracy</div><div class="eval-track"><div class="eval-fill fb" data-w="${s.accuracy}"></div></div><div class="eval-n">${s.accuracy}%</div></div>
    <div class="eval-row"><div class="eval-lbl">Relevance</div><div class="eval-track"><div class="eval-fill fc" data-w="${s.relevance}"></div></div><div class="eval-n">${s.relevance}%</div></div>`;
  bubble.appendChild(ev);
  setTimeout(() => ev.querySelectorAll('.eval-fill').forEach(f => f.style.width = f.dataset.w + '%'), 80);
}

function appendMemIndicator(el, count) {
  const bubble = el.querySelector('.bubble');
  if (!bubble) return;
  const mi = document.createElement('div');
  mi.className = 'mem-ind';
  mi.textContent = `âš¡ +${count} memory insight${count > 1 ? 's' : ''} stored`;
  bubble.appendChild(mi);
}

function setStatus(active, label) {
  document.getElementById('statusLabel').textContent = label;
  document.getElementById('statusTag').style.borderColor = active ? 'var(--accent)' : '';
}

function updateEnginePill(engine, done) {
  const pill = document.getElementById('enginePill');
  if (!done) {
    pill.textContent = engine === 'deepseek' ? 'âš¡ DeepSeek' : 'ğŸŒ Gemini';
    pill.className = 'engine-pill ' + (engine === 'deepseek' ? 'ds' : 'gem');
  } else {
    pill.textContent = engine === 'deepseek' ? 'âš¡ DeepSeek' : 'ğŸŒ Gemini';
    pill.className = 'engine-pill ' + (engine === 'deepseek' ? 'ds' : 'gem');
  }
}

function updateEngineStatusUI() {
  const gd = document.getElementById('gemStatusDot');
  const dd = document.getElementById('dsStatusDot');
  if (gd) { gd.className = 'ai-status-dot ' + (GEMINI_KEY ? 'ai-ok' : 'ai-off'); }
  if (dd) { dd.className = 'ai-status-dot ' + (DEEPSEEK_KEY ? 'ai-ok' : 'ai-off'); }
}

function scrollBottom() {
  const w = document.getElementById('messagesWrap');
  if (w) requestAnimationFrame(() => w.scrollTop = w.scrollHeight);
}

function esc(t) {
  return String(t)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function persist() {
  try { await window.storage.set('jarvis-mem',       JSON.stringify(memories)); }                              catch(_) {}
  try { await window.storage.set('jarvis-memsum',    memSummary); }                                            catch(_) {}
  try { await window.storage.set('jarvis-history',   JSON.stringify(conversationHistory.slice(-30))); }        catch(_) {}
  try { await window.storage.set('jarvis-sessions',  JSON.stringify(chatSessions.slice(-20))); }               catch(_) {}
}

async function load() {
  try { const r = await window.storage.get('jarvis-mem');      memories            = JSON.parse(r.value); } catch(_) { memories = []; }
  try { const r = await window.storage.get('jarvis-memsum');   memSummary          = r.value; }             catch(_) {}
  try { const r = await window.storage.get('jarvis-history');  conversationHistory  = JSON.parse(r.value); } catch(_) { conversationHistory = []; }
  try { const r = await window.storage.get('jarvis-sessions'); chatSessions         = JSON.parse(r.value); } catch(_) { chatSessions = []; }
  try { const r = await window.storage.get('jarvis-profile');  profile              = JSON.parse(r.value); } catch(_) {}
  try {
    const r = await window.storage.get('jarvis-theme');
    document.body.setAttribute('data-theme', r.value);
    document.querySelectorAll('.theme-sw').forEach(s => s.classList.toggle('active', s.dataset.theme === r.value));
  } catch(_) {}
  try { const r = await window.storage.get('jarvis-autosave'); autosave = r.value !== 'false'; } catch(_) {}
  document.getElementById('autosaveSw').classList.toggle('on', autosave);
  applyProfileUI();
  updateMemUI();
  updateHistoryUI();
  updateEngineStatusUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleAutosave() {
  autosave = !autosave;
  document.getElementById('autosaveSw').classList.toggle('on', autosave);
  try { window.storage.set('jarvis-autosave', String(autosave)); } catch(_) {}
  showToast(autosave ? 'ğŸ§  Auto-save ON' : 'â¸ Auto-save OFF');
}

function updateMemUI() {
  document.getElementById('memCount').textContent = `${memories.length} Memor${memories.length !== 1 ? 'ies' : 'y'}`;
}

function openMemModal() {
  const body = document.getElementById('memModalBody');
  if (!memories.length && !memSummary) {
    body.innerHTML = `<div style="text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);padding:28px">No memories yet.<br>Start chatting to build them!</div>`;
  } else {
    let h = '';
    if (memSummary) h += `<div class="mem-entry" style="border-left-color:var(--accent2)"><div class="mem-tag">COMPRESSED SUMMARY</div><div class="mem-text">${esc(memSummary)}</div></div>`;
    h += [...memories].reverse().map(m => `
      <div class="mem-entry">
        <div class="mem-tag">LEARNED</div>
        <div class="mem-text">${esc(m.text)}</div>
        <div class="mem-time">${esc(m.time)}</div>
      </div>`).join('');
    h += `<button class="d-btn d-danger" onclick="clearMemory()" style="margin-top:10px;width:100%">ğŸ—‘ Clear All Memories</button>`;
    body.innerHTML = h;
  }
  document.getElementById('memModal').classList.add('open');
}

function closeMemModal(e) {
  if (!e || e.target === document.getElementById('memModal')) {
    document.getElementById('memModal').classList.remove('open');
  }
}

async function clearMemory() {
  if (!confirm('Clear all memories? This cannot be undone.')) return;
  memories = []; memSummary = '';
  await persist();
  updateMemUI();
  closeMemModal();
  showToast('Memories cleared');
}

function openDrawer()  { document.getElementById('drawer').classList.add('open'); document.getElementById('drawerOverlay').classList.add('open'); }
function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }

function applyProfileUI() {
  const p = profile;
  document.getElementById('profileName').textContent   = p.name;
  document.getElementById('profileEmoji').textContent  = p.emoji;
  document.getElementById('profileHandle').textContent = p.bio;
  document.getElementById('inputName').value  = p.name;
  document.getElementById('inputEmoji').value = p.emoji;
  document.getElementById('inputBio').value   = p.bio;
  document.getElementById('logoSub').textContent = `Personal AI Â· ${p.name}`;
}

async function saveProfile() {
  profile.name  = document.getElementById('inputName').value.trim()  || 'Abhilas Rawat';
  profile.emoji = document.getElementById('inputEmoji').value.trim() || 'ğŸ‘¤';
  profile.bio   = document.getElementById('inputBio').value.trim()   || 'Creator & Owner';
  try { await window.storage.set('jarvis-profile', JSON.stringify(profile)); } catch(_) {}
  applyProfileUI();
  showToast('Profile saved âœ“');
}

function applyTheme(theme, el) {
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.theme-sw').forEach(s => s.classList.remove('active'));
  if (el) el.classList.add('active');
  try { window.storage.set('jarvis-theme', theme); } catch(_) {}
}

function updateHistoryUI() {
  const list = document.getElementById('historyList');
  if (!chatSessions.length) {
    list.innerHTML = `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:10px 0">No chats yet</div>`;
    return;
  }
  list.innerHTML = chatSessions.slice(0, 15).map(s => `
    <div class="h-item">
      <div class="h-icon">ğŸ’¬</div>
      <div class="h-text">${esc(s.preview)}</div>
      <div class="h-time">${esc(s.time?.split(',')[0] || '')}</div>
    </div>`).join('');
}

async function clearAll() {
  if (!confirm('Clear ALL data including memories and chat history?')) return;
  memories = []; memSummary = ''; conversationHistory = []; chatSessions = [];
  await persist();
  updateMemUI();
  updateHistoryUI();
  closeDrawer();
  showToast('All data cleared');
  location.reload();
}

function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 130) + 'px'; }
function useChip(text) { const i = document.getElementById('msgInput'); i.value = text; autoResize(i); sendMessage(); }
function clamp(n) { return Math.min(100, Math.max(0, n)); }

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.classList.remove('show'), 3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function boot() {
  // If we already have at least one key saved, go straight to app
  if (GEMINI_KEY || DEEPSEEK_KEY) {
    showApp();
  } else {
    document.getElementById('setupScreen').style.display = 'flex';
    document.getElementById('appWrapper').style.display = 'none';
  }
}

boot();
</script>
</body>
</html>
